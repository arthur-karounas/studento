<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>With Lera</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Removing hard white color so JS can change it */
        html { 
            background-color: #ffffff; 
            height: 100%;
        }

        body {
            background-color: #ffffff;
            padding-top: 0 !important;
            min-height: 100%;
        }

        /* Mobile header: bringing back blur, ensuring white undertone */
        .mobile-header-glass {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(4rem + env(safe-area-inset-top)) !important;
            background-color: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            z-index: 40;
            display: flex;
            align-items: flex-end; 
            padding-bottom: 1rem; 
            justify-content: center;
        }

        body { font-family: 'Inter', sans-serif; }
        body.modal-open { overflow: hidden; }
        .hidden { display: none !important; }
        
        /* Active tab for desktop */
        .active-tab { background: #4f46e5; color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2); }
        
        /* Student active tab is BLUE */
        .student-active-tab { background: #3b82f6; color: white; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }

        /* Active tab for mobile (bottom menu) */
        .mobile-active-tab { color: #4f46e5 !important; }
        .mobile-active-tab i { transform: translateY(-4px); transition: transform 0.2s ease; }
        
        /* Student mobile tab is BLUE */
        .student-mobile-active-tab { color: #2563eb !important; }
        .student-mobile-active-tab i { transform: translateY(-4px); transition: transform 0.2s ease; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        .task-card:hover { transform: translateY(-2px); transition: all 0.2s ease; }
        
        .step-node.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        .step-node.completed { background: #10b981; color: white; border-color: #10b981; }

        /* Mobile Layout Logic (Portrait) */
        @media (orientation: portrait), (max-width: 768px) {
            .desktop-sidebar { display: none !important; }
            .mobile-nav { display: flex !important; }
            .main-content { 
                padding-top: calc(5rem + env(safe-area-inset-top)) !important; 
                padding-bottom: 7rem !important;
                padding-left: 1rem !important; 
                padding-right: 1rem !important; 
            }
            .screen-header { text-align: center; }
            .screen-header h2 { display: none; }
            .screen-header p { display: none; }
            
            .login-card { 
                background: transparent !important; 
                box-shadow: none !important; 
                border: none !important; 
                padding-left: 1.5rem !important; 
                padding-right: 1.5rem !important;
            }
        }
        
        /* Emoji Animation */
        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .emoji-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 min-h-screen font-medium">

    <div id="notification-container" class="fixed top-20 right-4 md:top-6 md:right-6 z-[200] flex flex-col gap-3 w-[calc(100%-2rem)] md:w-auto"></div>

    <!-- MODAL: IMAGE VIEW (FULLSCREEN) -->
    <div id="modal-image-view" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-sm transition-all duration-300" onclick="app.closeImageModal()">
        <button onclick="app.closeImageModal()" class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors p-2 bg-slate-800/50 rounded-full">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <img id="expanded-image" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl transition-transform duration-300 scale-95 cursor-default" onclick="event.stopPropagation()">
    </div>

    <!-- MODAL: CONFIRM -->
    <div id="modal-confirm" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mb-6">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-extrabold text-slate-800 mb-2">Are you sure?</h3>
                <p id="confirm-message" class="text-slate-500 mb-8 text-sm">This action cannot be undone.</p>
                <div class="flex gap-3 w-full">
                    <button id="confirm-cancel" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">Cancel</button>
                    <button id="confirm-ok" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-bold hover:bg-rose-600 transition-all shadow-lg shadow-rose-200">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: RECEIVE SUPPORT (NEW) -->
    <div id="modal-receive-support" class="fixed inset-0 z-[190] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 animate-slide-up text-center">
            <div class="w-20 h-20 bg-pink-50 text-pink-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i data-lucide="gift" class="w-10 h-10"></i>
            </div>
            <h3 class="text-2xl font-black text-slate-800 mb-2">You got a wish!</h3>
            <p class="text-slate-400 font-bold uppercase text-xs tracking-widest mb-6">From a random classmate</p>
            
            <div class="bg-pink-50 p-6 rounded-2xl mb-8 relative">
                <i data-lucide="quote" class="absolute top-4 left-4 w-6 h-6 text-pink-200"></i>
                <p id="receive-support-text" class="text-slate-700 font-bold text-lg italic relative z-10 leading-relaxed">...</p>
            </div>

            <button onclick="app.acceptSupportMessage()" class="w-full py-4 bg-pink-500 text-white rounded-2xl font-bold hover:bg-pink-600 transition-all shadow-lg shadow-pink-200 flex items-center justify-center gap-2">
                <span>Thanks</span> <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
            </button>
        </div>
    </div>

    <!-- MODAL: EDIT SCORE -->
    <div id="modal-edit-score" class="fixed inset-0 z-[160] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 animate-slide-up">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-6 shadow-inner">
                    <i data-lucide="pencil" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Grade Answer</h3>
                <p class="text-slate-500 mb-8 text-sm font-medium">Enter score (0-5)</p>
                
                <input type="number" id="edit-score-input" min="0" max="10" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-black text-center text-3xl text-indigo-600 mb-8 placeholder:text-slate-200" placeholder="0">

                <div class="flex gap-3 w-full">
                    <button onclick="app.closeEditScoreModal()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">Cancel</button>
                    <button onclick="app.saveScore()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EMOJI REACTION -->
    <div id="modal-emoji" class="fixed inset-0 z-[170] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="app.closeEmojiModal()"></div>
        <div class="relative bg-white w-full max-w-xs rounded-[2rem] shadow-2xl p-6 animate-slide-up">
            <div class="text-center mb-6">
                <h3 class="text-xl font-black text-slate-800">Reaction</h3>
                <p id="reaction-hint" class="text-xs text-slate-400 font-bold mt-1">Max 2 for the whole class</p>
            </div>
            <div class="grid grid-cols-4 gap-3 mb-6">
                <!-- Emojis will be injected here -->
                <button onclick="app.sendReaction('üî•')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üî•</button>
                <button onclick="app.sendReaction('‚ù§Ô∏è')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">‚ù§Ô∏è</button>
                <button onclick="app.sendReaction('üöÄ')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üöÄ</button>
                <button onclick="app.sendReaction('üåü')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üåü</button>
                <button onclick="app.sendReaction('üëë')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üëë</button>
                <button onclick="app.sendReaction('üòé')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üòé</button>
                <button onclick="app.sendReaction('üß†')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üß†</button>
                <button onclick="app.sendReaction('üëª')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üëª</button>
            </div>
            <button onclick="app.deleteReaction()" id="btn-delete-reaction" class="w-full py-3 bg-rose-50 text-rose-500 rounded-xl font-bold hover:bg-rose-100 transition-colors hidden">Remove reaction</button>
        </div>
    </div>

    <!-- MAIN SCREEN -->
    <div id="screen-main" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="max-w-md w-full text-center space-y-10 animate-slide-up">
            <div class="flex justify-center">
                <div class="relative">
                    <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 animate-pulse"></div>
                    <div class="relative bg-indigo-600 p-6 rounded-[2rem] shadow-2xl">
                        <i data-lucide="graduation-cap" class="text-white w-14 h-14"></i>
                    </div>
                </div>
            </div>
            <div>
                <h1 class="text-5xl font-black tracking-tight text-slate-900 mb-4">With Lera</h1>
                <p class="text-slate-500 text-lg leading-relaxed px-4">A convenient and simple environment for learning!</p>
            </div>
            <div class="space-y-4 px-2">
                <button onclick="app.showScreen('screen-student-login')" class="w-full py-5 rounded-2xl bg-indigo-600 text-white text-lg font-bold hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100 flex items-center justify-center gap-3 group">
                    Student
                </button>
                <button onclick="app.showScreen('screen-teacher-login')" class="w-full py-5 rounded-2xl bg-white border-2 border-slate-100 text-slate-700 text-lg font-bold hover:border-indigo-400 transition-all">
                    Teacher
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREENS -->
    <div id="screen-teacher-login" class="screen hidden min-h-screen flex items-center justify-center p-0 md:p-6 bg-white md:bg-[#FFFFFF]">
    <div class="login-card max-w-sm w-full bg-white rounded-[2.5rem] p-8 md:p-10 md:shadow-2xl md:border md:border-slate-50 animate-slide-up text-center">
        
        <button onclick="app.showScreen('screen-main')" class="text-slate-400 hover:text-indigo-600 mb-8 flex items-center justify-center gap-2 text-sm font-extrabold transition-colors mx-auto">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
        </button>

        <div class="mb-8">
            <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i data-lucide="graduation-cap" class="w-10 h-10"></i>
            </div>
            <h2 class="text-4xl font-black text-slate-800 tracking-tight">Teacher</h2>
        </div>

        <div class="space-y-4">
            
            <div class="relative bg-slate-100 p-1.5 rounded-2xl flex mb-6">
                <div id="auth-slider-bg" class="absolute top-1.5 left-1.5 bottom-1.5 w-[calc(50%-6px)] bg-white rounded-xl shadow-sm transition-all duration-300 ease-out transform translate-x-0"></div>

                <button onclick="app.setTeacherAuthMode('login')" id="btn-auth-login" class="flex-1 relative z-10 py-3 text-sm font-black text-indigo-600 transition-colors duration-300">
                    Log In
                </button>

                <button onclick="app.setTeacherAuthMode('register')" id="btn-auth-register" class="flex-1 relative z-10 py-3 text-sm font-black text-slate-400 transition-colors duration-300">
                    Sign Up
                </button>
            </div>

            <input type="email" id="t-email" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-center placeholder:text-slate-300" placeholder="Email">

<div class="relative">
    <input type="password" id="t-password" oninput="app.checkPasswordStrength(this.value)" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-center placeholder:text-slate-300" placeholder="Password">
    
    <div id="password-strength-container" class="hidden absolute -bottom-3 left-6 right-6 h-1.5 bg-slate-100 rounded-full overflow-hidden">
        <div id="password-strength-bar" class="h-full w-0 bg-rose-500 transition-all duration-300 ease-out"></div>
    </div>
</div>
            <div class="pt-2">
                <button onclick="app.submitTeacherAuth()" id="btn-auth-action" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-[0.98]">
                    Log In
                </button>
            </div>

        </div>
    </div>
</div>

    <div id="screen-student-login" class="screen hidden min-h-screen flex items-center justify-center p-0 md:p-6 bg-white md:bg-[#FFFFFF]">
        <div class="login-card max-w-sm w-full bg-white rounded-[2.5rem] p-8 md:p-10 md:shadow-2xl md:border md:border-slate-50 animate-slide-up text-center">
            <button onclick="app.showScreen('screen-main')" class="text-slate-400 hover:text-indigo-600 mb-10 flex items-center justify-center gap-2 text-sm font-extrabold transition-colors mx-auto">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
            </button>
            <div class="mb-10">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="key-round" class="w-10 h-10"></i>
                </div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">Hello!</h2>
                <p class="text-slate-400 mt-2 font-semibold leading-relaxed">Enter your three secret words to log in</p>
            </div>
            <div class="space-y-6">
                <input type="text" id="s-phrase" class="w-full px-6 py-6 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white text-center font-black text-xl outline-none transition-all placeholder:font-bold placeholder:text-slate-200" placeholder="word word word">
                <button onclick="app.studentLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-[0.98]">Enter Dashboard</button>
            </div>
        </div>
    </div>

    <div id="modal-support-quest" class="fixed inset-0 z-[180] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="app.closeSupportModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 animate-slide-up">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-pink-50 text-pink-500 rounded-full flex items-center justify-center mb-6 shadow-inner">
                    <i data-lucide="heart-handshake" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Support a Friend</h3>
                <p class="text-slate-500 mb-6 text-sm font-medium">Send a kind message to earn +1 point!</p>
                
                <div class="w-full space-y-4">
                    <!-- Dropdown removed as per request for random assignment -->
                    <div class="bg-slate-50 p-4 rounded-2xl text-slate-500 text-sm font-bold border-2 border-dashed border-slate-200">
                        <i data-lucide="shuffle" class="w-4 h-4 inline-block mr-1 mb-0.5"></i>
                        Your message will be sent to a random classmate!
                    </div>

                    <textarea id="support-message-text" rows="3" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-pink-500 focus:bg-white outline-none font-bold text-slate-800 resize-none placeholder:font-normal" placeholder="Write something nice..."></textarea>

                    <div class="flex gap-3 w-full pt-2">
                        <button onclick="app.closeSupportModal()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">Cancel</button>
                        <button onclick="app.submitSupportQuest()" class="flex-1 py-4 bg-pink-500 text-white rounded-2xl font-bold hover:bg-pink-600 transition-all shadow-lg shadow-pink-200">Send üíå</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="screen-teacher-dash" class="screen hidden min-h-screen md:h-screen md:overflow-hidden flex flex-col md:flex-row relative">
        
        <!-- MOBILE TOP HEADER (Fixed) -->
        <header class="md:hidden mobile-header-glass border-b border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.02)]">
            <h1 id="mobile-header-title" class="font-black text-2xl text-slate-800">Class</h1>
        </header>

        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar w-80 bg-white border-r border-slate-100 p-8 flex flex-col shrink-0 overflow-y-auto">
            <div class="flex items-center gap-3 mb-12 px-2 font-black text-2xl text-indigo-600 italic">
                <div class="bg-indigo-600 p-2 rounded-lg text-white not-italic shadow-lg shadow-indigo-100">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                </div>
                With Lera
            </div>
            <nav class="flex-grow space-y-3">
                <button onclick="app.setTeacherTab('students')" id="tab-btn-students" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 active-tab">
                    <i data-lucide="users" class="w-5 h-5"></i> Class
                </button>
                <button onclick="app.setTeacherTab('tasks')" id="tab-btn-tasks" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i> Tasks
                </button>
                <button onclick="app.setTeacherTab('stats')" id="tab-btn-stats" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Analytics
                </button>
                <button onclick="app.setTeacherTab('rating')" id="tab-btn-rating" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="trophy" class="w-5 h-5"></i> Leaderboard
                </button>
            </nav>
            <button onclick="app.logout()" class="mt-auto flex items-center gap-4 px-6 py-4 rounded-2xl text-rose-500 font-bold hover:bg-rose-50 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i> Logout
            </button>
        </aside>

        <!-- Mobile Bottom Nav -->
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-50 flex flex-row justify-around items-center p-2 pb-6 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <button onclick="app.setTeacherTab('students')" id="mob-tab-students" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px] mobile-active-tab">
                <i data-lucide="users" class="w-6 h-6"></i> Class
            </button>
            <button onclick="app.setTeacherTab('tasks')" id="mob-tab-tasks" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="clipboard-list" class="w-6 h-6"></i> Tasks
            </button>
            <button onclick="app.setTeacherTab('stats')" id="mob-tab-stats" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="bar-chart-2" class="w-6 h-6"></i> Analytics
            </button>
            <button onclick="app.setTeacherTab('rating')" id="mob-tab-rating" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="trophy" class="w-6 h-6"></i> Leaderboard
            </button>
            <button onclick="app.logout()" class="flex flex-col items-center gap-1 p-3 text-rose-400 font-black text-[10px]">
                <i data-lucide="log-out" class="w-6 h-6"></i> Logout
            </button>
        </nav>

        <main class="main-content flex-grow p-6 md:p-12 overflow-y-auto bg-[#F8FAFC]">
            <!-- TAB: STUDENTS -->
            <section id="tab-students" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 md:mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">Class</h2>
                    <button onclick="app.toggleAddStudentForm()" class="w-full md:w-auto bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                        <i data-lucide="user-plus" class="w-5 h-5"></i> Add Student
                    </button>
                </div>
                <div id="add-student-form" class="hidden mb-10 bg-white p-6 md:p-8 rounded-[2rem] border-2 border-indigo-100 shadow-sm">
                    <h3 class="font-black text-xl mb-6">New Student</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="new-name" class="px-6 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-indigo-400 outline-none font-bold" placeholder="Full Name">
                        <input type="text" id="new-phrase" class="px-6 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-indigo-400 outline-none font-bold" placeholder="3 secret words">
                        <button onclick="app.createStudent()" class="py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all">Add</button>
                    </div>
                </div>
                <div id="student-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- TAB: TASKS -->
            <section id="tab-tasks" class="hidden">
                <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-0 mb-6 md:mb-10 screen-header">
                    <div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800">Tasks</h2>
                        <p class="text-slate-500 mt-1 font-medium">Material distribution</p>
                    </div>
                    <button onclick="app.openNewTaskForm()" class="bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i> New Task
                    </button>
                </div>
                <div id="task-creation-wizard" class="hidden mb-12">
                    <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
                        <div class="bg-slate-900 px-6 py-5 md:px-10 md:py-6 flex justify-between items-center">
                            <h3 id="wizard-title" class="text-white font-bold">Task Builder</h3>
                            <button onclick="app.closeNewTaskForm()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="p-6 md:p-10">
                            <div class="flex items-center justify-between mb-10 max-w-md mx-auto relative">
                                <div class="absolute h-1 bg-slate-100 top-1/2 left-0 right-0 -translate-y-1/2 z-0"></div>
                                <div id="step-line-1" class="absolute h-1 bg-indigo-500 top-1/2 left-0 w-0 -translate-y-1/2 z-0 transition-all duration-500"></div>
                                <div class="step-node active relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-1">1</div>
                                <div class="step-node relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-2">2</div>
                                <div class="step-node relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-3">3</div>
                            </div>
                            <div id="wizard-step-1" class="space-y-6 max-w-xl mx-auto">
                                <textarea id="task-text" rows="4" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white outline-none font-medium text-lg resize-none" placeholder="What needs to be done?"></textarea>
                                
                                <!-- Image Input Section (Updated for up to 3 photos) -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">Images (Max 3)</label>
                                    
                                    <div class="flex gap-2 mb-4">
                                        <input type="text" id="new-image-url" class="flex-1 px-6 py-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none font-medium truncate" placeholder="Paste URL and click Add">
                                        
                                        <button onclick="app.addImageFromUrl()" class="px-6 py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-700 transition-colors">Add</button>

                                        <label class="px-5 py-4 bg-slate-100 rounded-2xl cursor-pointer hover:bg-slate-200 transition-colors flex-shrink-0" title="Upload Image">
                                            <i data-lucide="image-plus" class="w-6 h-6 text-slate-500"></i>
                                            <input type="file" id="task-image-file" accept="image/*" class="hidden" onchange="app.handleImageUpload(this)">
                                        </label>
                                    </div>
                                    
                                    <!-- Grid for active images -->
                                    <div id="active-images-list" class="grid grid-cols-3 gap-3"></div>
                                </div>
                                
                                <!-- Answer Type Selection -->
                                <div class="bg-slate-100 p-1.5 rounded-2xl flex gap-1">
    <label class="flex-1 cursor-pointer">
        <input type="radio" name="answerType" value="mixed" class="peer sr-only" checked onchange="app.updateAnswerTypeUI()">
        <div class="py-3 px-2 rounded-xl text-center text-sm font-bold text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-2">
            <span>‚ú®</span> Auto Check
        </div>
    </label>

    <label class="flex-1 cursor-pointer">
        <input type="radio" name="answerType" value="manual" class="peer sr-only" onchange="app.updateAnswerTypeUI()">
        <div class="py-3 px-2 rounded-xl text-center text-sm font-bold text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-2">
            <span>üëÅÔ∏è</span> Manual Review
        </div>
    </label>
</div>

                                <input type="text" id="task-answer" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white outline-none font-bold" placeholder="Correct Answer (for reference)">
                                <button onclick="app.nextWizardStep(2)" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Next</button>
                            </div>
                            <div id="wizard-step-2" class="hidden space-y-6 max-w-2xl mx-auto">
                                <div id="student-checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-1"></div>
                                <div class="flex gap-3">
                                    <button onclick="app.nextWizardStep(1)" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold">Back</button>
                                    <button onclick="app.nextWizardStep(3)" class="flex-[2] py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Next</button>
                                </div>
                            </div>
                            <div id="wizard-step-3" class="hidden space-y-8 max-w-xl mx-auto">
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">Publish Date</label>
                                        <div class="relative">
                                            <input type="text" onfocus="(this.type='datetime-local')" onblur="if(!this.value)this.type='text'" id="task-publish-date" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 font-bold text-slate-700" placeholder="Select date and time">
                                            <div class="text-xs text-slate-400 mt-2 ml-2">Leave empty to publish now</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">Deadline</label>
                                        <input type="text" onfocus="(this.type='datetime-local')" onblur="if(!this.value)this.type='text'" id="task-deadline" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 font-bold text-slate-700" placeholder="Select date and time (does not affect grading)">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button onclick="app.nextWizardStep(2)" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold">Back</button>
                                    <button onclick="app.assignTask()" class="flex-[2] py-5 bg-emerald-500 text-white rounded-2xl font-black shadow-xl">Publish</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="teacher-tasks-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6"></div>
            </section>

            <!-- TAB: STATS -->
            <section id="tab-stats" class="hidden">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-8 px-2">
        
    </div>

    <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 shadow-sm border border-slate-100 mb-8">
        <div class="h-[300px] md:h-[450px]">
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <div id="quick-stats" class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-10"></div>
</section>
            
            <!-- TAB: RATING (Teacher) -->
            <section id="tab-rating" class="hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">Leaderboard</h2>
                    <p class="text-slate-400 font-medium">Class Hall of Fame</p>
                </div>
                <div id="teacher-rating-list" class="max-w-2xl mx-auto space-y-4"></div>
            </section>
        </main>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="screen-student-dash" class="screen hidden min-h-screen md:h-screen md:overflow-hidden flex flex-col md:flex-row">
        
        <!-- MOBILE TOP HEADER (Fixed) -->
        <header class="md:hidden mobile-header-glass border-b border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.02)]">
            <h1 id="mobile-student-title" class="font-black text-2xl text-slate-800">My Lessons</h1>
        </header>

        <aside class="desktop-sidebar w-80 bg-white border-r border-slate-100 p-8 flex flex-col shrink-0 overflow-y-auto">
            <div class="flex items-center gap-3 mb-12 font-black text-2xl uppercase tracking-widest text-blue-600 italic"><i data-lucide="backpack"></i> With Lera</div>
            <nav class="flex-grow space-y-3">
                <button onclick="app.setStudentTab('lessons')" id="st-tab-btn-lessons" class="w-full px-6 py-4 rounded-2xl font-black flex items-center gap-4 shadow-sm student-active-tab transition-all hover:bg-blue-50">
                    <i data-lucide="book-open"></i> My Lessons
                </button>
                <button onclick="app.setStudentTab('quests')" id="st-tab-btn-quests" class="w-full px-6 py-4 rounded-2xl font-black flex items-center gap-4 text-slate-400 transition-all hover:bg-blue-50 hover:text-blue-600">
                    <i data-lucide="target"></i> Quests
                </button>
                <button onclick="app.setStudentTab('rating')" id="st-tab-btn-rating" class="w-full px-6 py-4 rounded-2xl font-black flex items-center gap-4 text-slate-400 transition-all hover:bg-blue-50 hover:text-blue-600">
                    <i data-lucide="trophy"></i> Leaderboard
                </button>
            </nav>
            <div class="mt-auto pt-8 border-t border-slate-50">
                <div class="bg-blue-50 rounded-[2rem] p-6 mb-8 border border-blue-100">
                    <p id="student-name-display" class="font-black text-slate-900 truncate text-lg">...</p>
                    <p id="student-phrase-display" class="text-xs text-blue-700 opacity-60 font-mono mb-4"></p>
                    <div class="bg-white px-5 py-3 rounded-2xl flex justify-between items-center shadow-sm">
                        <span id="student-total-score" class="font-black text-blue-700 text-2xl">0</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 font-bold">Logout</button>
            </div>
        </aside>
        
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-50 flex flex-row justify-around items-center p-2 pb-6 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <button onclick="app.setStudentTab('lessons')" id="st-mob-tab-lessons" class="flex flex-col items-center gap-1 p-3 text-blue-500 font-black text-[10px] student-mobile-active-tab">
                <i data-lucide="book-open" class="w-6 h-6"></i> Lessons
            </button>
             <button onclick="app.setStudentTab('quests')" id="st-mob-tab-quests" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="target" class="w-6 h-6"></i> Quests
            </button>
            <button onclick="app.setStudentTab('rating')" id="st-mob-tab-rating" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="trophy" class="w-6 h-6"></i> Leaderboard
            </button>
            <button onclick="app.logout()" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="log-out" class="w-6 h-6"></i> Logout
            </button>
        </nav>

        <main class="main-content flex-grow p-6 md:p-12 overflow-y-auto bg-[#F8FAFC]">
            <!-- STUDENT TAB: LESSONS -->
            <section id="tab-student-lessons">
                <h2 class="text-3xl md:text-4xl font-black mb-8 text-slate-800 md:block hidden">Lessons</h2>
                <div id="student-tasks-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6"></div>
            </section>
            
            <!-- STUDENT TAB: QUESTS -->
            <section id="tab-student-quests" class="hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">Quests</h2>
                    <p class="text-slate-400 font-medium">Daily challenges & Rewards</p>
                </div>
                <!-- Quest Grid -->
                <div id="student-quests-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Daily Quest will be injected here -->
                </div>
            </section>

            <!-- STUDENT TAB: RATING -->
            <section id="tab-student-rating" class="hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">Hall of Fame</h2>
                    <p class="text-slate-400 font-medium">Anonymous class leaderboard</p>
                </div>
                <div id="student-rating-list" class="max-w-2xl mx-auto space-y-4"></div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, setDoc, Timestamp, query, where, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyA_mptcpENpEsrJYHXBRxb-rlRH_eqI8-E","authDomain":"studento-aa5d2.firebaseapp.com","projectId":"studento-aa5d2","storageBucket":"studento-aa5d2.firebasestorage.app","messagingSenderId":"1078257307837","appId":"1:1078257307837:web:9ea84484c1dfdb129ca7d4"}');
        // Fallback for appId to avoid undefined paths which cause 400 bad request errors
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'school-edu-v4';
        
        const appFb = initializeApp(firebaseConfig);
        const auth = getAuth(appFb);
        const db = getFirestore(appFb);

        let currentStudentId = null;
        let currentStudentData = null; // Stores info about student (and teacher)
        let groupedTasks = []; 
        let drafts = [];
        let editingDraftId = null;
        let editingGroupId = null; // Tracks if we are editing a published group
        let statsChart = null;
        let currentEditingTaskId = null;
        let currentReactionTargetId = null; // Stores ID of the student we are sending reaction to
        let currentDraftImages = []; // Stores images for the task currently being created

        // === GLOBAL STRING COMPARISON FUNCTIONS (Levenshtein Algorithm) ===
        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            const matrix = [];

            // Initialize first column
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }

            // Initialize first row
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            // Fill matrix
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            Math.min(
                                matrix[i][j - 1] + 1, // insertion
                                matrix[i - 1][j] + 1 // deletion
                            )
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }

        // === GENERATE HTML DIFF FOR ERRORS ===
        function getDiffHTML(student, correct) {
            const s = student.trim();
            const c = correct.trim();
            
            // Matrix dimensions
            const n = s.length;
            const m = c.length;
            
            // Create matrix
            const dp = Array.from({ length: n + 1 }, () => Array(m + 1).fill(0));

            // Initialize boundaries
            for (let i = 0; i <= n; i++) dp[i][0] = i;
            for (let j = 0; j <= m; j++) dp[0][j] = j;

            // Fill matrix (case-insensitive for alignment)
            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    if (s[i - 1].toLowerCase() === c[j - 1].toLowerCase()) { 
                        dp[i][j] = dp[i - 1][j - 1];
                    } else {
                        dp[i][j] = Math.min(
                            dp[i - 1][j] + 1,        // Deletion
                            dp[i][j - 1] + 1,        // Insertion
                            dp[i - 1][j - 1] + 1  // Substitution
                        );
                    }
                }
            }

            // Backtrack to generate HTML
            let i = n, j = m;
            let html = '';

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && s[i - 1].toLowerCase() === c[j - 1].toLowerCase()) {
                    html = s[i - 1] + html; // Match - just the character
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j] === dp[i][j - 1] + 1)) {
                    // Insertion (needed in correct, missing in student) -> Green
                    html = `<span class="bg-emerald-200 text-emerald-700 px-0.5 rounded mx-0.5">${c[j - 1]}</span>` + html;
                    j--;
                } else if (i > 0 && (j === 0 || dp[i][j] === dp[i - 1][j] + 1)) {
                    // Deletion (present in student, extra) -> Red strikethrough
                        html = `<span class="bg-rose-200 text-rose-600 line-through px-0.5 rounded mx-0.5 opacity-80 decoration-2 decoration-rose-500">${s[i - 1]}</span>` + html;
                    i--;
                } else {
                      // Substitution -> Show red what was, green what should be
                    html = `<span class="bg-emerald-200 text-emerald-700 px-0.5 rounded mx-0.5">${c[j - 1]}</span><span class="bg-rose-200 text-rose-600 line-through px-0.5 rounded mx-0.5 opacity-80 decoration-2 decoration-rose-500">${s[i - 1]}</span>` + html;
                    i--; j--;
                }
            }
            return html;
        }

        function calculateSimilarity(s1, s2) {
            const a = s1.trim().toLowerCase();
            const b = s2.trim().toLowerCase();
            
            // If strings are identical
            if (a === b) return 100;

            const maxLength = Math.max(a.length, b.length);
            if (maxLength === 0) return 100; // Both empty

            const distance = levenshtein(a, b);
            const similarity = (1 - distance / maxLength) * 100;
            return Math.floor(similarity);
        }
        // =================================================================

        const formatDate = (inputDate) => {
            if (!inputDate) return "";
            const d = new Date(inputDate);
            return d.toLocaleString('en-US', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        const notify = (text, type = 'info') => {
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = `${type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'} text-white px-6 py-4 rounded-2xl shadow-2xl animate-slide-up mb-2 flex items-center gap-3 font-bold`;
            el.innerHTML = `<span class="text-sm">${text}</span>`;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 400); }, 3000);
        };

        const getColPath = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

        let activeTeacherTab = 'students';
        let activeStudentTab = 'lessons';

        window.app = {
            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                document.getElementById('screen-main').classList.add('hidden');
                document.getElementById(id).classList.remove('hidden');
                
                // === DYNAMIC BACKGROUND FOR OVERSCROLL ===
                // If on dashboard, paint "background" gray
                if (id === 'screen-teacher-dash' || id === 'screen-student-dash') {
                    document.documentElement.style.backgroundColor = '#F8FAFC';
                    document.body.style.backgroundColor = '#F8FAFC';
                    // Change status bar color in browser (for Android Chrome etc.)
                    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                    if (metaThemeColor) metaThemeColor.setAttribute('content', '#F8FAFC');
                } else {
                    // If on login/main, paint white
                    document.documentElement.style.backgroundColor = '#ffffff';
                    document.body.style.backgroundColor = '#ffffff';
                    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                    if (metaThemeColor) metaThemeColor.setAttribute('content', '#ffffff');
                }
                
                lucide.createIcons();
            },

            askConfirm: (message) => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal-confirm');
                    document.getElementById('confirm-message').textContent = message;
                    modal.classList.remove('hidden');
                    document.body.classList.add('modal-open');
                    document.getElementById('confirm-ok').onclick = () => { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); resolve(true); };
                    document.getElementById('confirm-cancel').onclick = () => { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); resolve(false); };
                });
            },

            openImageModal: (src) => {
                const modal = document.getElementById('modal-image-view');
                const img = document.getElementById('expanded-image');
                img.src = src;
                modal.classList.remove('hidden');
                setTimeout(() => img.classList.remove('scale-95'), 10);
                document.body.classList.add('modal-open');
            },

            closeImageModal: () => {
                const modal = document.getElementById('modal-image-view');
                const img = document.getElementById('expanded-image');
                modal.classList.add('hidden');
                img.classList.add('scale-95');
                document.body.classList.remove('modal-open');
            },

            submitTeacherAuth: () => {
                if (window.app.teacherAuthMode === 'login') {
                    app.teacherLogin();
                } else {
                    app.teacherRegister();
                }
            },

            teacherAuthMode: 'login',

// 1. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–≤–µ—Ç–∞ –∏ —à–∏—Ä–∏–Ω—ã
checkPasswordStrength: (val) => {
    const bar = document.getElementById('password-strength-bar');
    const len = val.length;
    
    // –ú–∞–∫—Å–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–æ–ª–æ—Å–∫–∏
    // (Math.min –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–º 100%)
    const percentage = Math.min(100, (len / 6) * 100);
    
    bar.style.width = percentage + '%';

    // –õ–æ–≥–∏–∫–∞ —Ü–≤–µ—Ç–æ–≤:
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã —Ü–≤–µ—Ç–æ–≤
    bar.classList.remove('bg-rose-500', 'bg-amber-400', 'bg-emerald-500');

    if (len === 0) {
        bar.classList.add('bg-rose-500'); // –ü—É—Å—Ç–æ - –∫—Ä–∞—Å–Ω—ã–π
    } else if (len < 4) {
        bar.classList.add('bg-rose-500'); // –ú–∞–ª–æ - –∫—Ä–∞—Å–Ω—ã–π
    } else if (len < 6) {
        bar.classList.add('bg-amber-400'); // –ü–æ—á—Ç–∏ - –∂–µ–ª—Ç—ã–π/–æ—Ä–∞–Ω–∂–µ–≤—ã–π
    } else {
        bar.classList.add('bg-emerald-500'); // –ì–æ—Ç–æ–≤–æ - –∑–µ–ª–µ–Ω—ã–π
    }
},

// 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ strengthContainer)
setTeacherAuthMode: (mode) => {
    window.app.teacherAuthMode = mode;
    
    const slider = document.getElementById('auth-slider-bg');
    const btnLogin = document.getElementById('btn-auth-login');
    const btnRegister = document.getElementById('btn-auth-register');
    const actionBtn = document.getElementById('btn-auth-action');
    const strengthContainer = document.getElementById('password-strength-container');
    const passwordInput = document.getElementById('t-password');

    if (mode === 'login') {
        // –†–µ–∂–∏–º –í—Ö–æ–¥–∞
        slider.style.transform = 'translateX(0)';
        btnLogin.classList.replace('text-slate-400', 'text-indigo-600');
        btnRegister.classList.replace('text-indigo-600', 'text-slate-400');
        actionBtn.textContent = 'Log In';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å–∫—É
        strengthContainer.classList.add('hidden');
    } else {
        // –†–µ–∂–∏–º –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        slider.style.transform = 'translateX(100%)'; 
        btnLogin.classList.replace('text-indigo-600', 'text-slate-400');
        btnRegister.classList.replace('text-slate-400', 'text-indigo-600');
        actionBtn.textContent = 'Create Account';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–æ—Å–∫—É
        strengthContainer.classList.remove('hidden');
        // –°—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —á—Ç–æ-—Ç–æ –≤–≤–µ–ª)
        app.checkPasswordStrength(passwordInput.value);
    }
},

            setTeacherTab: (tab) => {
                if (activeTeacherTab === tab && !document.getElementById(`tab-${tab}`).classList.contains('hidden')) {
                    return; 
                }

                const tabs = ['students', 'tasks', 'stats', 'rating'];
                const titles = { students: 'Class', tasks: 'Tasks', stats: 'Analytics', rating: 'Leaderboard' };
                
                const mobileTitle = document.getElementById('mobile-header-title');
                if (mobileTitle) mobileTitle.textContent = titles[tab];

                tabs.forEach(t => {
                    const el = document.getElementById(`tab-${t}`);
                    const btn = document.getElementById(`tab-btn-${t}`);
                    const isVisible = t === tab;
                    
                    if (isVisible) {
                        el.classList.remove('hidden');
                        el.classList.remove('animate-slide-up');
                        void el.offsetWidth; 
                        el.classList.add('animate-slide-up');
                        
                        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –±–µ–ª—ã–º, —É–±–∏—Ä–∞–µ–º —Å–µ—Ä—ã–π –∏ —Ö–æ–≤–µ—Ä
                        btn.classList.add('active-tab', 'text-white');
                        btn.classList.remove('text-slate-400', 'hover:bg-slate-50');
                    } else {
                        el.classList.add('hidden');
                        
                        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç
                        btn.classList.remove('active-tab', 'text-white');
                        btn.classList.add('text-slate-400', 'hover:bg-slate-50');
                    }
                    
                    const mobBtn = document.getElementById(`mob-tab-${t}`);
                    if(mobBtn) mobBtn.classList.toggle('mobile-active-tab', isVisible);
                });
                
                activeTeacherTab = tab;

                if(tab === 'students') loadMyStudents();
                if(tab === 'tasks') loadTeacherTasks();
                if(tab === 'stats') loadStatistics();
                if(tab === 'rating') loadTeacherLeaderboard();
                lucide.createIcons();
            },

            setStudentTab: (tab) => {
                if (activeStudentTab === tab && !document.getElementById(`tab-student-${tab}`).classList.contains('hidden')) {
                      return;
                }
                
                const tabs = ['lessons', 'quests', 'rating'];
                const titles = { lessons: 'My Lessons', quests: 'Quests', rating: 'Leaderboard' };

                const mobileTitle = document.getElementById('mobile-student-title');
                if (mobileTitle) mobileTitle.textContent = titles[tab];

                tabs.forEach(t => {
                    const el = document.getElementById(`tab-student-${t}`);
                    const btn = document.getElementById(`st-tab-btn-${t}`);
                    const isVisible = t === tab;
                    
                    if (isVisible) {
                          el.classList.remove('hidden');
                          el.classList.remove('animate-slide-up');
                          void el.offsetWidth;
                          el.classList.add('animate-slide-up');

                          // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –Ø–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–ª—ã–π —Ü–≤–µ—Ç
                          btn.classList.add('student-active-tab', 'text-white');
                          btn.classList.remove('text-slate-400', 'hover:bg-blue-50', 'hover:text-blue-600');
                    } else {
                        el.classList.add('hidden');

                        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        btn.classList.remove('student-active-tab', 'text-white');
                        btn.classList.add('text-slate-400', 'hover:bg-blue-50', 'hover:text-blue-600');
                    }

                    const mobBtn = document.getElementById(`st-mob-tab-${t}`);
                    mobBtn.classList.toggle('student-mobile-active-tab', isVisible);
                    if(!isVisible) mobBtn.classList.add('text-slate-400');
                    else mobBtn.classList.remove('text-slate-400');
                });

                activeStudentTab = tab;
                if (tab === 'lessons') loadStudentTasks();
                if (tab === 'quests') loadStudentQuests();
                if (tab === 'rating') loadStudentLeaderboard();
                lucide.createIcons();
            },

            toggleAddStudentForm: () => document.getElementById('add-student-form').classList.toggle('hidden'),

            updateAnswerTypeUI: () => {
                const type = document.querySelector('input[name="answerType"]:checked').value;
                const input = document.getElementById('task-answer');
                if (type === 'manual') {
                    input.classList.add('hidden');
                } else {
                    input.classList.remove('hidden');
                }
            },

            openNewTaskForm: (id = null, type = 'draft') => {
                document.getElementById('task-creation-wizard').classList.remove('hidden');
                editingDraftId = null;
                editingGroupId = null;
                currentDraftImages = []; // Reset images

                // Reset inputs
                document.getElementById('task-text').value = '';
                document.getElementById('task-answer').value = '';
                document.getElementById('task-deadline').value = '';
                document.getElementById('task-publish-date').value = '';
                document.getElementById('new-image-url').value = '';
                app.renderImagePreviews();

                document.querySelector('input[name="answerType"][value="mixed"]').checked = true; // Default
                document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);

                // Set Title based on action
                const titleEl = document.getElementById('wizard-title');
                
                if (id && type === 'draft') {
                    editingDraftId = id;
                    titleEl.textContent = "Edit Draft";
                    
                    const draft = drafts.find(d => d.id === id);
                    if (draft) {
                        document.getElementById('task-text').value = draft.question || '';
                        document.getElementById('task-answer').value = draft.correctAnswer || '';
                        if (draft.deadline) document.getElementById('task-deadline').value = draft.deadline; 
                        if (draft.publishAt) document.getElementById('task-publish-date').value = draft.publishAt;
                        
                        if (draft.imageUrls && Array.isArray(draft.imageUrls)) {
                            currentDraftImages = draft.imageUrls;
                        } else if (draft.imageUrl) {
                            currentDraftImages = [draft.imageUrl];
                        }
                        app.renderImagePreviews();

                        if (draft.answerType) {
                            const rb = document.querySelector(`input[name="answerType"][value="${draft.answerType}"]`);
                            if (rb) rb.checked = true;
                        }

                        if (draft.studentIds && Array.isArray(draft.studentIds)) {
                            draft.studentIds.forEach(sid => {
                                const cb = document.querySelector(`.student-checkbox[value="${sid}"]`);
                                if (cb) cb.checked = true;
                            });
                        }
                    }
                } else if (id && type === 'published') {
                    editingGroupId = id;
                    titleEl.textContent = "Edit Task";
                    
                    const group = groupedTasks.find(g => g.groupId === id);
                    if (group) {
                          document.getElementById('task-text').value = group.question || '';
                          document.getElementById('task-answer').value = group.correctAnswer || '';
                          
                          // Date to string format for input
                          if(group.deadline) {
                             const d = group.deadline.toDate();
                             d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                             document.getElementById('task-deadline').value = d.toISOString().slice(0,16);
                          }
                          if(group.publishAt) {
                             const d = group.publishAt.toDate();
                             d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                             document.getElementById('task-publish-date').value = d.toISOString().slice(0,16);
                          }

                          // Images
                          if (group.imageUrls && Array.isArray(group.imageUrls)) {
                            currentDraftImages = group.imageUrls;
                        } else if (group.imageUrl) {
                            currentDraftImages = [group.imageUrl];
                        }
                        app.renderImagePreviews();

                        // Answer Type
                        if (group.answerType) {
                            const rb = document.querySelector(`input[name="answerType"][value="${group.answerType}"]`);
                            if (rb) rb.checked = true;
                        }

                        // Students Checkboxes
                        const assignedIds = group.items.map(i => i.studentId);
                        assignedIds.forEach(sid => {
                            const cb = document.querySelector(`.student-checkbox[value="${sid}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                } else {
                      titleEl.textContent = "Task Builder";
                }
                
                app.updateAnswerTypeUI();
                app.nextWizardStep(1);
            },
            
            // --- IMAGE HANDLING START ---
            addImageFromUrl: () => {
                const urlInput = document.getElementById('new-image-url');
                const url = urlInput.value.trim();
                if (!url) return;
                
                if (currentDraftImages.length >= 3) {
                    notify("Max 3 images allowed", "error");
                    return;
                }
                
                currentDraftImages.push(url);
                urlInput.value = '';
                app.renderImagePreviews();
            },

            handleImageUpload: (input) => {
                const file = input.files[0];
                if (!file) return;

                if (currentDraftImages.length >= 3) {
                    notify("Max 3 images allowed", "error");
                    input.value = '';
                    return;
                }

                if (file.size > 20 * 1024 * 1024) {
                    notify("File too huge (>20MB)", "error");
                    input.value = '';
                    return;
                }

                notify("Processing image...", "info"); // User feedback

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        let MAX_DIM = 1000; 
                        let quality = 0.7;

                        const compress = () => {
                            let currW = width;
                            let currH = height;

                            if (currW > currH) {
                                if (currW > MAX_DIM) { currH *= MAX_DIM / currW; currW = MAX_DIM; }
                            } else {
                                if (currH > MAX_DIM) { currW *= MAX_DIM / currH; currH = MAX_DIM; }
                            }

                            canvas.width = currW;
                            canvas.height = currH;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, currW, currH);

                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            
                            if (dataUrl.length > 900000) {
                                MAX_DIM = Math.floor(MAX_DIM * 0.8);
                                quality = Math.max(0.5, quality - 0.1);
                                if (MAX_DIM < 300) {
                                    notify("Image too complex to compress safely.", "error");
                                    return;
                                }
                                compress();
                            } else {
                                currentDraftImages.push(dataUrl);
                                app.renderImagePreviews();
                                notify("Image attached!", "success");
                            }
                        };
                        
                        compress();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                input.value = '';
            },

            removeImage: (index) => {
                currentDraftImages.splice(index, 1);
                app.renderImagePreviews();
            },

            renderImagePreviews: () => {
                const container = document.getElementById('active-images-list');
                container.innerHTML = currentDraftImages.map((src, index) => `
                    <div class="relative aspect-square rounded-xl overflow-hidden border border-slate-200 group">
                        <img src="${src}" class="w-full h-full object-cover">
                        <button onclick="app.removeImage(${index})" class="absolute top-1 right-1 bg-white text-rose-500 p-1.5 rounded-lg shadow-sm hover:bg-rose-50 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                lucide.createIcons();
            },
            // --- IMAGE HANDLING END ---

            closeNewTaskForm: async () => {
                const question = document.getElementById('task-text').value.trim();
                const container = document.getElementById('task-creation-wizard');
                
                // If editing a published task, we don't save as draft on close without publish.
                // We just close.
                if (editingGroupId) {
                    editingGroupId = null;
                    container.classList.add('hidden');
                    return;
                }

                if (question) {
                    const answer = document.getElementById('task-answer').value.trim();
                    const deadline = document.getElementById('task-deadline').value;
                    const publishAt = document.getElementById('task-publish-date').value;
                    const answerType = document.querySelector('input[name="answerType"]:checked').value;
                    const checked = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

                    const draftData = {
                        teacherId: auth.currentUser.uid,
                        question,
                        correctAnswer: answer,
                        answerType,
                        deadline, 
                        publishAt,
                        imageUrls: currentDraftImages, // Save all images
                        imageUrl: currentDraftImages[0] || "", // For backward compatibility
                        studentIds: checked,
                        updatedAt: Date.now()
                    };

                    try {
                        if (editingDraftId) {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drafts', editingDraftId), draftData);
                        } else {
                            await addDoc(getColPath('drafts'), draftData);
                        }
                        notify("Saved as draft", "info");
                    } catch (e) {
                        console.error(e);
                        notify("Error saving draft", "error");
                    }
                }

                editingDraftId = null;
                container.classList.add('hidden');
                loadTeacherTasks(); 
            },
            
            nextWizardStep: (step) => {
                [1, 2, 3].forEach(s => {
                    document.getElementById(`wizard-step-${s}`).classList.toggle('hidden', s !== step);
                    const node = document.getElementById(`node-${s}`);
                    node.classList.toggle('active', s === step);
                    node.classList.toggle('completed', s < step);
                });
                document.getElementById('step-line-1').style.width = step === 1 ? '0%' : step === 2 ? '50%' : '100%';
            },

            teacherLogin: async () => {
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-password').value);
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } catch (e) { notify("Access error", "error"); }
            },

            teacherRegister: async () => {
                try {
                    await createUserWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-password').value);
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } catch (e) { notify("Registration error", "error"); }
            },

            createStudent: async () => {
                const name = document.getElementById('new-name').value;
                const phrase = document.getElementById('new-phrase').value.trim().toLowerCase();
                if (!name || phrase.split(/\s+/).length !== 3) return notify("Need name and 3 words", "error");
                try {
                    await addDoc(getColPath('students'), { 
                        teacherId: auth.currentUser.uid, 
                        name, 
                        phrase, 
                        bonusPoints: 0, // Initialize bonusPoints
                        createdAt: Date.now() 
                    });
                    document.getElementById('new-name').value = ''; document.getElementById('new-phrase').value = '';
                    notify("Done", "success");
                    loadMyStudents();
                    app.toggleAddStudentForm();
                } catch (e) { notify("Error", "error"); }
            },

            deleteStudent: async (sid) => {
                if(await app.askConfirm("Delete?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sid));
                    loadMyStudents();
                }
            },

            assignTask: async () => {
                const text = document.getElementById('task-text').value;
                const answer = document.getElementById('task-answer').value.trim();
                const deadlineVal = document.getElementById('task-deadline').value;
                const publishVal = document.getElementById('task-publish-date').value;
                const answerType = document.querySelector('input[name="answerType"]:checked').value;
                const checked = document.querySelectorAll('.student-checkbox:checked');
                
                if (!text || (answerType !== 'manual' && !answer) || !deadlineVal || checked.length === 0) return notify("Fill in everything", "error");
                
                const publishAt = publishVal ? Timestamp.fromDate(new Date(publishVal)) : Timestamp.now();
                const deadline = Timestamp.fromDate(new Date(deadlineVal));

                try {
                    // Logic for UPDATING existing task group
                    if (editingGroupId) {
                        const commonData = {
                            question: text,
                            correctAnswer: answer,
                            answerType: answerType,
                            deadline: deadline,
                            publishAt: publishAt,
                            imageUrls: currentDraftImages,
                            imageUrl: currentDraftImages[0] || ""
                        };

                        const selectedStudentIds = Array.from(checked).map(cb => cb.value);
                        const group = groupedTasks.find(g => g.groupId === editingGroupId);
                        const existingStudentIds = group.items.map(i => i.studentId);
                        
                        // 1. Update existing tasks
                        const toUpdate = group.items.filter(i => selectedStudentIds.includes(i.studentId));
                        const updatePromises = toUpdate.map(task => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', task.id), commonData));
                        
                        // 2. Create new tasks for newly added students
                        const toAddIds = selectedStudentIds.filter(sid => !existingStudentIds.includes(sid));
                        const addPromises = toAddIds.map(sid => {
                             const name = document.querySelector(`.student-checkbox[value="${sid}"]`).dataset.name;
                             return addDoc(getColPath('tasks'), { 
                                 ...commonData, 
                                 groupId: editingGroupId, 
                                 teacherId: auth.currentUser.uid,
                                 studentId: sid, 
                                 studentName: name, 
                                 status: 'assigned', 
                                 score: 0, 
                                 createdAt: Date.now() 
                             });
                        });
                        
                        // 3. Delete tasks for removed students
                        const toDelete = group.items.filter(i => !selectedStudentIds.includes(i.studentId));
                        const deletePromises = toDelete.map(task => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', task.id)));
                        
                        await Promise.all([...updatePromises, ...addPromises, ...deletePromises]);
                        notify("Task updated successfully", "success");
                        editingGroupId = null;

                    } else {
                        // Logic for creating NEW task group
                        const groupId = Date.now().toString();
                        const promises = Array.from(checked).map(cb => {
                            return addDoc(getColPath('tasks'), {
                                groupId, teacherId: auth.currentUser.uid, studentId: cb.value, studentName: cb.dataset.name,
                                question: text, correctAnswer: answer, answerType: answerType, 
                                imageUrls: currentDraftImages, // Save all images
                                imageUrl: currentDraftImages[0] || "", // For backward compat
                                deadline: deadline,
                                publishAt: publishAt,
                                status: 'assigned', score: 0, createdAt: Date.now()
                            });
                        });
                        await Promise.all(promises);
                        
                        if (editingDraftId) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drafts', editingDraftId));
                        }
                        notify("Task published", "success");
                    }
                    
                    document.getElementById('task-text').value = ''; 
                    editingDraftId = null;
                    document.getElementById('task-creation-wizard').classList.add('hidden');
                    loadTeacherTasks();
                } catch (e) { console.error(e); notify("Error", "error"); }
            },

            deleteTaskGroup: async (groupId) => {
                if(await app.askConfirm("Delete for everyone?")) {
                    const group = groupedTasks.find(g => g.groupId === groupId);
                    await Promise.all(group.items.map(item => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', item.id))));
                    loadTeacherTasks();
                }
            },

            deleteDraft: async (draftId) => {
                 if(await app.askConfirm("Delete draft?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drafts', draftId));
                    loadTeacherTasks();
                }
            },

            // === SCORE EDIT LOGIC ===
            editScore: (taskId, currentScore) => {
                currentEditingTaskId = taskId;
                document.getElementById('edit-score-input').value = currentScore;
                document.getElementById('modal-edit-score').classList.remove('hidden');
            },
            
            closeEditScoreModal: () => {
                 document.getElementById('modal-edit-score').classList.add('hidden');
                 currentEditingTaskId = null;
            },

            saveScore: async () => {
                const newScore = parseInt(document.getElementById('edit-score-input').value, 10);
                if (isNaN(newScore)) return notify("Enter a number", "error");

                try {
                    // Update task status to completed as well (in case it was 'review')
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', currentEditingTaskId), {
                        score: newScore,
                        status: 'completed'
                    });
                    notify("Score updated", "success");
                    app.closeEditScoreModal();
                    
                    await loadTeacherTasks(); // Reload underlying list
                } catch (e) {
                    console.error(e);
                    notify("Update error", "error");
                }
            },
            
            // New toggle functions
            toggleTaskAccordion: (groupId) => {
                const body = document.getElementById(`task-body-${groupId}`);
                const chevron = document.getElementById(`chevron-${groupId}`);
                const card = document.getElementById(`task-card-${groupId}`);

                if (body.style.maxHeight) {
                    // Collapse
                    body.style.maxHeight = null;
                    chevron.style.transform = 'rotate(0deg)';
                    card.classList.remove('shadow-xl'); 
                    card.classList.add('shadow-sm');
                } else {
                    // Expand
                    body.style.maxHeight = body.scrollHeight + "px";
                    chevron.style.transform = 'rotate(180deg)';
                    card.classList.remove('shadow-sm'); 
                    card.classList.add('shadow-xl');
                }
            },

      toggleStudentTaskAccordion: (id) => {
                const body = document.getElementById(`st-body-${id}`);
                const chevron = document.getElementById(`st-chevron-${id}`);
                // –ú—ã –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º headerContent, –æ–Ω –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω
                
                if (body.style.maxHeight && body.style.maxHeight !== '0px') {
                    // –ó–∞–∫—Ä—ã—Ç—å
                    body.style.maxHeight = '0px';
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    // –û—Ç–∫—Ä—ã—Ç—å
                    body.style.maxHeight = (body.scrollHeight + 100) + "px";
                    chevron.style.transform = 'rotate(180deg)';
                }
            },
            
            // === REACTION LOGIC ===
            openEmojiModal: (targetId, hasReaction) => {
                currentReactionTargetId = targetId;
                const btnDelete = document.getElementById('btn-delete-reaction');
                const hint = document.getElementById('reaction-hint');
                
                // Check if teacher
                const isTeacher = !currentStudentId && auth.currentUser;
                
                if (isTeacher) {
                    hint.textContent = "Teacher reward (1 per student)";
                } else {
                    hint.textContent = "Max 2 for the whole class";
                }
                
                if (hasReaction) {
                        btnDelete.classList.remove('hidden');
                } else {
                        btnDelete.classList.add('hidden');
                }
                document.getElementById('modal-emoji').classList.remove('hidden');
            },
            
            closeEmojiModal: () => {
                document.getElementById('modal-emoji').classList.add('hidden');
                currentReactionTargetId = null;
            },
            
            sendReaction: async (emoji) => {
                // Determine sender (student or teacher)
                let senderId = currentStudentId;
                let isTeacher = false;
                
                if (!senderId && auth.currentUser) {
                    senderId = auth.currentUser.uid;
                    isTeacher = true;
                }
                
                if (!senderId || !currentReactionTargetId) return;
                
                const reactionId = `${senderId}_${currentReactionTargetId}`;
                
                try {
                    // 1. Check limits
                    const snap = await getDocs(getColPath('reactions'));
                    const myReactions = snap.docs
                        .map(d => d.data())
                        .filter(r => r.fromStudentId === senderId);
                        
                    // Look for existing reaction to this target
                    const existingToTarget = myReactions.find(r => r.toStudentId === currentReactionTargetId);
                    
                    if (!isTeacher) {
                        // For students: limit 2 total
                          if (!existingToTarget && myReactions.length >= 2) {
                            notify("Max 2 reactions allowed!", "error");
                            app.closeEmojiModal();
                            return;
                        }
                    } 
                    // Teachers limit not checked globally, only replacing old reaction for same student

                    // 2. Save/Update reaction
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reactions', reactionId), {
                        fromStudentId: senderId,
                        toStudentId: currentReactionTargetId,
                        emoji: emoji,
                        timestamp: Date.now(),
                        isTeacher: isTeacher // Teacher flag
                    });
                    
                    // === DAILY QUEST LOGIC (Student Only) ===
                    if (!isTeacher && currentStudentData) {
                        const today = new Date().toISOString().slice(0, 10);
                        const lastDate = currentStudentData.lastRewardDate;
                        
                        if (lastDate !== today) {
                            // Grant reward
                            const studentRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', currentStudentId);
                            const newBonus = (currentStudentData.bonusPoints || 0) + 1;
                            
                            // Optimistic update
                            currentStudentData.bonusPoints = newBonus;
                            currentStudentData.lastRewardDate = today;
                            
                            await updateDoc(studentRef, {
                                bonusPoints: newBonus,
                                lastRewardDate: today
                            });
                            
                            notify("Daily Quest Completed! +1 Point üíé", "success");
                        } else {
                             notify("Reaction sent!", "success");
                        }
                    } else {
                        notify("Reaction sent!", "success");
                    }
                    
                    app.closeEmojiModal();
                    
                    if (isTeacher) {
                        loadTeacherLeaderboard();
                    } else {
                        if (activeStudentTab === 'quests') loadStudentQuests();
                        else loadStudentLeaderboard(); 
                    }
                } catch (e) {
                    console.error(e);
                    notify("Send error", "error");
                }
            },
            
            deleteReaction: async () => {
                let senderId = currentStudentId;
                let isTeacher = false;
                if (!senderId && auth.currentUser) {
                    senderId = auth.currentUser.uid;
                    isTeacher = true;
                }
                
                if (!senderId || !currentReactionTargetId) return;
                const reactionId = `${senderId}_${currentReactionTargetId}`;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reactions', reactionId));
                    notify("Reaction removed", "success");
                    app.closeEmojiModal();
                    
                    if (isTeacher) loadTeacherLeaderboard();
                    else loadStudentLeaderboard();
                } catch(e) {
                    notify("Delete error", "error");
                }
            },

            // === SUPPORT QUEST LOGIC (UPDATED FOR RANDOM 1-TO-1) ===
            openSupportModal: async () => {
                if (!currentStudentId || !currentStudentData) return;
                
                // Dropdown removed - no need to load classmates here anymore
                document.getElementById('support-message-text').value = '';
                document.getElementById('modal-support-quest').classList.remove('hidden');
                lucide.createIcons();
            },

            closeSupportModal: () => {
                document.getElementById('modal-support-quest').classList.add('hidden');
            },

            submitSupportQuest: async () => {
                const text = document.getElementById('support-message-text').value.trim();
                if (text.length < 5) return notify("Message too short", "error");

                try {
                    // 1. Get ALL Classmates
                    const studentsSnap = await getDocs(getColPath('students'));
                    const classmates = studentsSnap.docs.map(d => ({id: d.id, ...d.data()}))
                        .filter(s => s.teacherId === currentStudentData.teacherId && s.id !== currentStudentId);

                    // 2. Get ALL Support Messages to see who received one
                    const msgsSnap = await getDocs(getColPath('support_messages'));
                    const receivedIds = new Set(msgsSnap.docs.map(d => d.data().toStudentId));

                    // 3. Filter Candidates: Must NOT have received a message yet
                    const candidates = classmates.filter(s => !receivedIds.has(s.id));

                    let targetId;

                    if (candidates.length > 0) {
                         // Pick random eligible candidate
                         const target = candidates[Math.floor(Math.random() * candidates.length)];
                         targetId = target.id;
                    } else {
                        // Fallback: If everyone has received one, pick random from ANY classmate (to avoid blocking)
                        // Or prevent sending? Let's assume fallback to any random classmate to keep the fun going.
                        if (classmates.length === 0) return notify("You are alone in class...", "error");
                        const target = classmates[Math.floor(Math.random() * classmates.length)];
                        targetId = target.id;
                    }

                    // 4. Save Message
                    await addDoc(getColPath('support_messages'), {
                        fromStudentId: currentStudentId,
                        fromName: currentStudentData.name, 
                        toStudentId: targetId,
                        message: text,
                        timestamp: Date.now(),
                        isRead: false
                    });

                    // 5. Update Student Stats (Bonus)
                    const today = new Date().toISOString().slice(0, 10);
                    const newBonus = (currentStudentData.bonusPoints || 0) + 1;
                    
                    currentStudentData.bonusPoints = newBonus;
                    currentStudentData.lastSupportQuestDate = today;

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', currentStudentId), {
                        bonusPoints: newBonus,
                        lastSupportQuestDate: today
                    });

                    notify("Random message sent! +1 Point üíé", "success");
                    app.closeSupportModal();
                    // Update UI
                    app.setStudentTab('quests'); 

                } catch (e) {
                    console.error(e);
                    notify("Error sending message", "error");
                }
            },
            
            // === RECEIVE SUPPORT LOGIC (NEW) ===
            checkIncomingSupport: async () => {
                if (!currentStudentId) return;

                const q = query(
                    getColPath('support_messages'),
                    where('toStudentId', '==', currentStudentId),
                    where('isRead', '==', false)
                );

                const snap = await getDocs(q);
                if (!snap.empty) {
                    const msgDoc = snap.docs[0]; // Take the first one
                    const msgData = msgDoc.data();
                    
                    document.getElementById('receive-support-text').textContent = msgData.message;
                    // Store doc ID to mark as read later
                    window.app.currentSupportMessageId = msgDoc.id;
                    
                    document.getElementById('modal-receive-support').classList.remove('hidden');
                }
            },
            
            acceptSupportMessage: async () => {
                if (!window.app.currentSupportMessageId) return;
                
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'support_messages', window.app.currentSupportMessageId), {
                        isRead: true
                    });
                    document.getElementById('modal-receive-support').classList.add('hidden');
                    window.app.currentSupportMessageId = null;
                    notify("Saved to your heart ‚ù§Ô∏è", "success");
                } catch(e) {
                    console.error(e);
                    document.getElementById('modal-receive-support').classList.add('hidden');
                }
            },

            studentLogin: async () => {
                const phrase = document.getElementById('s-phrase').value.trim().toLowerCase();
                try {
                    const snap = await getDocs(getColPath('students'));
                    const student = snap.docs.find(d => d.data().phrase === phrase);
                    if (!student) return notify("Invalid code", "error");
                    
                    localStorage.setItem('student_id', student.id);
                    currentStudentId = student.id;
                    currentStudentData = student.data();

                    document.getElementById('student-name-display').textContent = student.data().name;
                    document.getElementById('student-phrase-display').textContent = student.data().phrase;
                    window.app.showScreen('screen-student-dash');
                    
                    loadStudentTasks();
                    
                    // CHECK FOR INCOMING MESSAGES
                    setTimeout(app.checkIncomingSupport, 1000);
                    
                } catch (e) { notify("Error", "error"); }
            },

            // === TASK SUBMISSION ===
            submitTask: async (taskId, correct, deadlineSec, answerType) => {
                const val = document.getElementById(`input-${taskId}`).value.trim();
                if (!val) return notify("Enter answer", "error");

                // Check time
                const isLate = (Date.now() / 1000) > deadlineSec;

                // MANUAL REVIEW LOGIC
                if (answerType === 'manual') {
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), {
                            status: 'review', // New status for manual review
                            studentAnswer: val, 
                            score: 0, // No score yet
                            isLate: isLate,
                            completedAt: Date.now()
                        });
                        notify("Sent for review", "success");
                        loadStudentTasks();
                    } catch (e) { notify("Error", "error"); }
                    return;
                }

                // AUTO GRADING LOGIC
                // Calculate similarity
                const similarity = calculateSimilarity(val, correct);
                
                let score = 1;
                let message = "";

                if (similarity === 100) {
                    score = 5;
                    message = "Perfect! +5 points";
                } else if (similarity >= 75) {
                    score = 4;
                    message = "Good! +4 points";
                } else if (similarity >= 55) {
                    score = 3;
                    message = "Not bad. +3 points";
                } else {
                    score = 1;
                    message = "Attempt counted. +1 point";
                }

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), {
                        status: 'completed', 
                        studentAnswer: val, 
                        score: score, 
                        accuracy: similarity, // Save accuracy
                        isLate: isLate,
                        completedAt: Date.now()
                    });
                    
                    notify(message, "success");
                    loadStudentTasks();
                } catch (e) { notify("Error", "error"); }
            },
            // ============================================

            logout: async () => { 
                localStorage.removeItem('student_id');
                await signOut(auth); 
                window.location.reload(); 
            }
        };

        async function loadMyStudents() {
            if (!auth.currentUser) return;
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            const studentsSnap = await getDocs(getColPath('students'));
            
            const list = document.getElementById('student-list');
            const checklist = document.getElementById('student-checklist');
            const myStudents = studentsSnap.docs
                .map(d => ({id: d.id, ...d.data()}))
                .filter(s => s.teacherId === auth.currentUser.uid);
            
            let listHtml = '';
            let checklistHtml = '';

            myStudents.forEach(s => {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ö–ª–∞—Å—Å"
                listHtml += `
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 flex flex-col items-center text-center group relative shadow-sm">
                        <button onclick="app.deleteStudent('${s.id}')" class="absolute top-4 right-4 text-slate-200 hover:text-rose-500 transition-colors p-2">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center text-xl font-black mb-4">
                            ${s.name[0]}
                        </div>
                        <h4 class="font-black text-slate-800 truncate w-full px-4 mb-2">${s.name}</h4>
                        
                        <div class="bg-slate-50 border border-slate-100 text-slate-500 px-4 py-2 rounded-xl text-xs font-mono font-bold mt-2 break-all">
                            ${s.phrase}
                        </div>
                    </div>`;

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
                checklistHtml += `
                    <label class="group flex items-center gap-4 p-5 bg-white rounded-2xl border-2 border-slate-50 cursor-pointer hover:border-indigo-400 transition-all">
                        <input type="checkbox" value="${s.id}" data-name="${s.name}" class="student-checkbox peer sr-only">
                        <div class="w-6 h-6 border-2 border-slate-200 rounded-lg peer-checked:bg-indigo-600 peer-checked:border-indigo-600 flex items-center justify-center transition-all">
                            <i data-lucide="check" class="w-4 h-4 text-white opacity-0 peer-checked:opacity-100"></i>
                        </div>
                        <span class="font-bold text-slate-700">${s.name}</span>
                    </label>`;
            });

            list.innerHTML = listHtml;
            checklist.innerHTML = checklistHtml;
            lucide.createIcons();
        }

        async function loadTeacherTasks() {
            if (!auth.currentUser) return;
            const [tasksSnap, draftsSnap] = await Promise.all([ getDocs(getColPath('tasks')), getDocs(getColPath('drafts')) ]);
            
            const container = document.getElementById('teacher-tasks-list');
            const allTasks = tasksSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.teacherId === auth.currentUser.uid);
            drafts = draftsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.teacherId === auth.currentUser.uid);

            const groupsMap = {};
            allTasks.forEach(t => {
                const gid = t.groupId || t.id;
                if (!groupsMap[gid]) groupsMap[gid] = { ...t, items: [] };
                groupsMap[gid].items.push(t);
            });
            groupedTasks = Object.values(groupsMap).sort((a, b) => b.createdAt - a.createdAt);
            
            let html = '';
            
            // Render Drafts first
            drafts.sort((a, b) => b.updatedAt - a.updatedAt).forEach(d => {
                html += `
                    <div class="task-card bg-slate-50 p-6 rounded-[2rem] border-2 border-dashed border-slate-200 cursor-pointer relative group" onclick="app.openNewTaskForm('${d.id}')">
                         <div class="absolute top-6 right-14 bg-slate-200 text-slate-500 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">Draft</div>
                        <div class="flex justify-between items-start mb-4">
                             <div class="text-[10px] text-slate-400 font-black uppercase">Updated: ${new Date(d.updatedAt).toLocaleDateString()}</div>
                            <button onclick="event.stopPropagation(); app.deleteDraft('${d.id}')" class="text-slate-300 hover:text-rose-500"><i data-lucide="trash" class="w-5 h-5"></i></button>
                        </div>
                        <h4 class="font-black text-slate-700 text-lg mb-4 line-clamp-2 opacity-70 group-hover:opacity-100 transition-opacity whitespace-pre-wrap">${d.question || 'Untitled'}</h4>
                        <div class="w-full flex justify-end">
                            <span class="text-xs font-bold text-indigo-500 flex items-center gap-1">Continue <i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                        </div>
                    </div>`;
            });

            // Render Active Tasks (Accordion Style)
            groupedTasks.forEach(g => {
                const total = g.items.length;
                const done = g.items.filter(i => i.status === 'completed' || i.status === 'review').length;
                const prc = Math.round((done / total) * 100);
                const isScheduled = g.publishAt && g.publishAt.toMillis() > Date.now();
                const publishDate = g.publishAt ? formatDate(g.publishAt.toDate()) : 'Now';
                
                // Compatibility for images
                let images = [];
                if (g.imageUrls && Array.isArray(g.imageUrls)) images = g.imageUrls;
                else if (g.imageUrl) images = [g.imageUrl];
                
                // Does it require review?
                const needsReviewCount = g.items.filter(i => i.status === 'review').length;

                html += `
                    <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm transition-all duration-300 overflow-hidden flex flex-col h-full" id="task-card-${g.groupId}">
                        <div class="p-6 cursor-pointer flex flex-col flex-grow" onclick="app.toggleTaskAccordion('${g.groupId}')">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-2">
                                    <div class="text-[10px] text-slate-400 font-black uppercase">Deadline: ${formatDate(g.deadline.toDate())}</div>
                                    ${isScheduled ? '<div class="bg-amber-50 text-amber-600 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">Scheduled</div>' : ''}
                                    ${needsReviewCount > 0 ? `<div class="bg-amber-100 text-amber-700 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider flex items-center gap-1"><i data-lucide="eye" class="w-3 h-3"></i> Review (${needsReviewCount})</div>` : ''}
                                </div>
                                <div>
                                    <button onclick="event.stopPropagation(); app.openNewTaskForm('${g.groupId}', 'published')" class="text-slate-300 hover:text-indigo-500 p-1 mr-2"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                                    <button onclick="event.stopPropagation(); app.deleteTaskGroup('${g.groupId}')" class="text-slate-200 hover:text-rose-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                            
                            <!-- Image Grid -->
                            ${images.length > 0 ? `
                                <div class="grid grid-cols-${Math.min(3, images.length)} gap-2 mb-4">
                                    ${images.map(src => `
                                        <div class="${images.length === 1 ? 'aspect-video' : 'aspect-square'} rounded-2xl overflow-hidden border border-slate-100 relative group/img">
                                            <img src="${src}" onclick="event.stopPropagation(); app.openImageModal(this.src)" class="w-full h-full object-cover transition-transform group-hover/img:scale-105">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <h4 class="font-black text-slate-800 text-lg mb-4 whitespace-pre-wrap line-clamp-2">${g.question}</h4>
                            
                            <div class="flex items-center justify-between mt-auto">
                                <div class="w-full h-1.5 bg-slate-50 rounded-full overflow-hidden mr-4 flex-1">
                                    <div class="h-full bg-indigo-500" style="width: ${prc}%"></div>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                                     <i id="chevron-${g.groupId}" data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300"></i>
                                </div>
                            </div>
                        </div>

                        <div id="task-body-${g.groupId}" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-slate-50">
                             <div class="p-6 border-t border-slate-100">

                                <div class="text-slate-800 font-bold text-lg mb-6 whitespace-pre-wrap leading-relaxed border-b border-slate-200 pb-4">${g.question}</div>

                                <div class="grid grid-cols-1 gap-4 mb-6">
                                    <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100/50">
                                        <div class="text-[10px] font-black uppercase text-indigo-400 mb-1 tracking-widest">Correct Answer</div>
                                        <div class="text-base font-black text-indigo-700">${g.correctAnswer || '(Manual Check)'}</div>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100">
                                        <div class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest">Published</div>
                                        <div class="text-sm font-bold text-slate-600">${publishDate}</div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <div class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest ml-2">Student List</div>
                                    ${g.items.map(item => {
                                        let statusColor = 'text-slate-300';
                                        let statusText = 'Pending';
                                        
                                        if (item.status === 'completed') {
                                            statusColor = 'text-emerald-500';
                                            statusText = `<i data-lucide="check-circle-2" class="w-3 h-3"></i> ${item.score} pts.`;
                                        } else if (item.status === 'review') {
                                            statusColor = 'text-amber-500';
                                            statusText = `<i data-lucide="clock" class="w-3 h-3"></i> Under Review`;
                                        }

                                        return `
                                        <div class="flex flex-col p-4 bg-white border border-slate-100 rounded-2xl shadow-sm">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="font-bold text-slate-800 text-sm">${item.studentName}</div>
                                                <div class="text-xs font-black ${statusColor} flex items-center gap-1">
                                                    ${statusText}
                                                    ${item.status !== 'assigned' ? `
                                                        <button onclick="event.stopPropagation(); app.editScore('${item.id}', ${item.score})" class="p-1.5 ml-2 bg-slate-100 rounded-lg hover:bg-indigo-100 text-slate-400 hover:text-indigo-600 transition-colors" title="${item.status === 'review' ? 'Grade Now' : 'Edit Score'}">
                                                            <i data-lucide="${item.status === 'review' ? 'star' : 'pencil'}" class="w-3 h-3"></i>
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            
                                            ${item.status === 'completed' || item.status === 'review' ? `
                                                <div class="text-sm bg-slate-50 p-3 rounded-xl text-slate-600 mb-2 border border-slate-100/50">
                                                    <span class="font-bold text-slate-400 text-xs uppercase mr-2">Answer:</span> 
                                                    <span class="font-mono text-sm">${item.studentAnswer}</span>
                                                </div>
                                            ` : ''}

                                            ${item.status === 'completed' ? `
                                                <div class="text-sm px-1">
                                                     <span class="font-bold text-slate-400 text-xs uppercase mr-2">Diff:</span>
                                                     <span class="font-mono text-sm">${getDiffHTML(item.studentAnswer, g.correctAnswer || item.studentAnswer)}</span>
                                                </div>
                                                ${item.accuracy !== undefined ? `<div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-right mt-1">Accuracy: ${item.accuracy}%</div>` : ''}
                                            ` : ''}
                                        </div>
                                    `}).join('')}
                                </div>
                             </div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
            lucide.createIcons();
        }

        async function loadStatistics() {
            if (!auth.currentUser) return;
            const [studentsSnap, tasksSnap] = await Promise.all([ getDocs(getColPath('students')), getDocs(getColPath('tasks')) ]);
            const students = studentsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(s => s.teacherId === auth.currentUser.uid);
            const tasks = tasksSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.teacherId === auth.currentUser.uid);
            const completedTasks = tasks.filter(t => t.status === 'completed').sort((a, b) => a.completedAt - b.completedAt);

            const totalScore = completedTasks.reduce((acc, t) => acc + (t.score || 0), 0);
            const avgScore = completedTasks.length ? (totalScore / completedTasks.length).toFixed(1) : 0;
            const completionRate = tasks.length ? Math.round((completedTasks.length / tasks.length) * 100) : 0;

            document.getElementById('quick-stats').innerHTML = `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm text-center">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2 tracking-widest">Average Score</span>
                    <div class="text-3xl font-black text-slate-800">${avgScore}</div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm text-center">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2 tracking-widest">Completion</span>
                    <div class="text-3xl font-black text-indigo-600">${completionRate}%</div>
                </div>
            `;

            const dates = [...new Set(completedTasks.map(t => new Date(t.completedAt).toLocaleDateString()))];
            const colors = ['#4f46e5', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
            
            const datasets = students.map((s, idx) => {
                let cumulative = 0;
                const offset = idx * 0.1; 
                
                return {
                    label: s.name,
                    data: dates.map(date => {
                        const dayScore = completedTasks
                            .filter(t => t.studentId === s.id && new Date(t.completedAt).toLocaleDateString() === date)
                            .reduce((acc, c) => acc + (c.score || 0), 0);
                        cumulative += dayScore;
                        return cumulative + offset;
                    }),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length],
                    tension: 0.4, 
                    fill: false, 
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                };
            });

            if (statsChart) statsChart.destroy();
            statsChart = new Chart(document.getElementById('statsChart'), {
                type: 'line',
                data: { labels: dates, datasets },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += Math.floor(context.parsed.y);
                                    return label;
                                }
                            }
                        },
                        legend: { labels: { usePointStyle: true, boxWidth: 8 } }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#f8fafc' },
                            ticks: { callback: function(value) { if (value % 1 === 0) return value; } }
                        }, 
                        x: { grid: { display: false } } 
                    } 
                }
            });
        }

        async function loadTeacherLeaderboard() {
    if (!auth.currentUser) return;
    const teacherId = auth.currentUser.uid;

    // Load data
    const [studentsSnap, tasksSnap, reactionsSnap] = await Promise.all([
        getDocs(getColPath('students')),
        getDocs(getColPath('tasks')),
        getDocs(getColPath('reactions'))
    ]);

    const classmates = studentsSnap.docs
        .map(d => ({id: d.id, ...d.data()}))
        .filter(s => s.teacherId === teacherId);

    const container = document.getElementById('teacher-rating-list');

    if (classmates.length === 0) {
        container.innerHTML = '<div class="text-center text-slate-300 py-20 font-bold italic">Class is empty</div>';
        return;
    }

    const allTasks = tasksSnap.docs
        .map(d => d.data())
        .filter(t => t.teacherId === teacherId);

    const allReactions = reactionsSnap.docs
        .map(d => d.data());

    // Calculate scores (Tasks + Bonus Points)
    const scores = {};
    classmates.forEach(s => scores[s.id] = (s.bonusPoints || 0)); // Start with bonus points
    allTasks.forEach(t => {
        if (scores[t.studentId] !== undefined) scores[t.studentId] += (t.score || 0);
    });

    // Sort
    const leaderboard = classmates.map(s => ({
        id: s.id,
        name: s.name,
        score: scores[s.id]
    })).sort((a, b) => b.score - a.score);

    let html = `<div class="bg-white rounded-[2rem] border border-slate-100 p-2">`;

    leaderboard.forEach((user, index) => {
        const rank = index + 1;

        const receivedReactions = allReactions.filter(r => r.toStudentId === user.id);
        const myReactionToHim = receivedReactions.find(r => r.fromStudentId === teacherId);

        let iconColor = 'bg-slate-100 text-slate-500';
        let iconContent = rank;
        if (rank === 1) {
            iconColor = 'bg-yellow-100 text-yellow-600';
            iconContent = '<i data-lucide="trophy" class="w-4 h-4"></i>';
        }
        if (rank === 2) {
            iconColor = 'bg-slate-200 text-slate-600';
            iconContent = '2';
        }
        if (rank === 3) {
            iconColor = 'bg-amber-100 text-amber-700';
            iconContent = '3';
        }

        html += `
            <div class="flex items-center gap-4 p-4 rounded-2xl">
                <div class="w-10 h-10 rounded-full ${iconColor} flex items-center justify-center font-black text-sm shrink-0">
                    ${iconContent}
                </div>
                <div class="flex-grow min-w-0">
                    <div class="font-bold text-slate-700 text-lg truncate">${user.name}</div>
                    
                    <div class="flex flex-wrap gap-1 mt-1">
                        ${receivedReactions.map(r => {
                            if (r.isTeacher) {
                                return `
                                    <div class="emoji-pop relative group cursor-help inline-flex items-center gap-1 mx-0.5 bg-indigo-600 text-white rounded-full px-2 py-0.5 shadow-md" title="Teacher's reaction">
                                        <span class="text-[9px] font-black uppercase tracking-wider">TEACHER</span>
                                        <span class="text-sm border-l border-white/30 pl-1 ml-0.5">${r.emoji}</span>
                                    </div>`;
                            }
                            return `<span class="emoji-pop text-sm cursor-help relative rounded-full px-1 hover:bg-slate-100 transition-colors" title="Anonymous">${r.emoji}</span>`;
                        }).join('')}
                        
                        <button onclick="app.openEmojiModal('${user.id}', ${!!myReactionToHim})" class="ml-1 w-6 h-6 rounded-full bg-slate-100 hover:bg-indigo-100 text-slate-400 hover:text-indigo-500 flex items-center justify-center transition-all ${myReactionToHim ? 'bg-indigo-100 text-indigo-600 ring-2 ring-indigo-200' : ''}">
                            <i data-lucide="${myReactionToHim ? 'pencil' : 'smile-plus'}" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                <div class="font-black text-xl text-slate-800">${user.score}</div>
            </div>
            ${index < leaderboard.length - 1 ? '<div class="h-px bg-slate-50 mx-4"></div>' : ''}
        `;
    });

    html += `</div>`;
    container.innerHTML = html;
    lucide.createIcons();
}

        async function loadStudentLeaderboard() {
            if (!currentStudentData || !currentStudentId) return;

            // 1. Get teacher ID
            const teacherId = currentStudentData.teacherId;

            // 2. Load data
            const [studentsSnap, tasksSnap, reactionsSnap] = await Promise.all([ 
                getDocs(getColPath('students')), 
                getDocs(getColPath('tasks')),
                getDocs(getColPath('reactions'))
            ]);

            const classmates = studentsSnap.docs
                .map(d => ({id: d.id, ...d.data()}))
                .filter(s => s.teacherId === teacherId);

            const allTasks = tasksSnap.docs
                .map(d => d.data())
                .filter(t => t.teacherId === teacherId);
                
            const allReactions = reactionsSnap.docs
                .map(d => d.data());

            // 3. Calc scores (Tasks + Bonus Points)
            const scores = {};
            classmates.forEach(s => scores[s.id] = (s.bonusPoints || 0)); // Start with bonus points
            
            allTasks.forEach(t => {
                if (scores[t.studentId] !== undefined) {
                    scores[t.studentId] += (t.score || 0);
                }
            });

            // 4. Sort
            const leaderboard = classmates.map(s => ({
                id: s.id,
                name: s.id === currentStudentId ? "You" : "Student", 
                realName: s.name, 
                score: scores[s.id]
            })).sort((a, b) => b.score - a.score);

            // 5. Render
            const container = document.getElementById('student-rating-list');
            const myRankIndex = leaderboard.findIndex(x => x.id === currentStudentId);
            const myData = leaderboard[myRankIndex];

            // Find closest competitor above
            const nextTarget = leaderboard[myRankIndex - 1];
            
            // Motivation phrase
            let motivationText = "";
            
            if (myRankIndex === 0) {
                 motivationText = "You're at the top! Keep it up! üëëüî•";
            } else {
                 const phrases = ["You're close, push it! üöÄ", "Onwards to the summit! üèîÔ∏è", "A little more effort! üí™", "You're doing great! üî•", "The goal is near! üéØ"];
                 motivationText = phrases[Math.floor(Math.random() * phrases.length)];
            }

            let html = '';

            // Card "Your Result"
            html += `
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-8 rounded-[2.5rem] shadow-xl shadow-blue-200 mb-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-10 transform translate-x-10 -translate-y-10">
                        <i data-lucide="trophy" class="w-48 h-48"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="text-blue-200 font-bold text-sm uppercase tracking-widest mb-2">Your Rank</div>
                        <div class="flex items-baseline gap-2 mb-2">
                            <span class="text-6xl font-black">${myRankIndex + 1}</span>
                            <span class="text-xl font-medium opacity-60">of ${leaderboard.length}</span>
                        </div>
                        
                        <p class="text-blue-200 font-medium text-sm mb-6 border-l-2 border-blue-400 pl-3 italic opacity-80">
                            ${motivationText}
                        </p>

                         ${nextTarget ? `
                            <div class="bg-white/10 backdrop-blur-md p-4 rounded-2xl border border-white/20 flex flex-col gap-2">
                                <span class="text-sm font-medium">To ${myRankIndex}th place: <strong>${nextTarget.score - myData.score + 1} points</strong></span>
                            </div>` : ''}
                    </div>
                </div>
            `;

            // Leaderboard list
            html += `<div class="bg-white rounded-[2rem] border border-slate-100 p-2">`;
            
            leaderboard.forEach((user, index) => {
                const rank = index + 1;
                const isMe = user.id === currentStudentId;
                
                // Filter reactions FOR this user
                const receivedReactions = allReactions.filter(r => r.toStudentId === user.id);
                
                // Check if I reacted
                const myReactionToHim = receivedReactions.find(r => r.fromStudentId === currentStudentId);
                
                let iconColor = 'bg-slate-100 text-slate-500';
                let iconContent = rank;
                if (rank === 1) { iconColor = 'bg-yellow-100 text-yellow-600'; iconContent = '<i data-lucide="trophy" class="w-4 h-4"></i>'; }
                if (rank === 2) { iconColor = 'bg-slate-200 text-slate-600'; iconContent = '2'; }
                if (rank === 3) { iconColor = 'bg-amber-100 text-amber-700'; iconContent = '3'; }

                html += `
                    <div class="flex items-center gap-4 p-4 rounded-2xl ${isMe ? 'bg-blue-50 border border-blue-100' : ''}">
                        <div class="w-10 h-10 rounded-full ${iconColor} flex items-center justify-center font-black text-sm shrink-0">
                            ${iconContent}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="font-bold ${isMe ? 'text-blue-700' : 'text-slate-700'} text-lg truncate">
                                ${user.name} ${isMe ? '(You)' : ''}
                            </div>
                            
                            <!-- Emojis Container -->
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${receivedReactions.map(r => {
                                    if (r.isTeacher) {
                                        return `
                                            <div class="emoji-pop relative group cursor-help inline-flex items-center gap-1 mx-0.5 bg-indigo-600 text-white rounded-full px-2 py-0.5 shadow-md" title="Teacher's reaction">
                                                <span class="text-[9px] font-black uppercase tracking-wider">TEACHER</span>
                                                <span class="text-sm border-l border-white/30 pl-1 ml-0.5">${r.emoji}</span>
                                            </div>`;
                                    }
                                    return `<span class="emoji-pop text-sm cursor-help relative rounded-full px-1 hover:bg-slate-100 transition-colors" title="Anonymous">${r.emoji}</span>`;
                                }).join('')}
                                
                                ${!isMe ? `
                                    <button onclick="app.openEmojiModal('${user.id}', ${!!myReactionToHim})" class="ml-1 w-6 h-6 rounded-full bg-slate-100 hover:bg-blue-100 text-slate-400 hover:text-blue-500 flex items-center justify-center transition-all ${myReactionToHim ? 'bg-blue-100 text-blue-600 ring-2 ring-blue-200' : ''}">
                                            <i data-lucide="${myReactionToHim ? 'pencil' : 'smile-plus'}" class="w-3 h-3"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="font-black text-xl ${isMe ? 'text-blue-600' : 'text-slate-800'}">${user.score}</div>
                    </div>
                    ${index < leaderboard.length - 1 ? '<div class="h-px bg-slate-50 mx-4"></div>' : ''}
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        }

        async function loadStudentQuests() {
            if (!currentStudentId) return;

            const questContainer = document.getElementById('student-quests-list');
            const today = new Date().toISOString().slice(0, 10);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è 1-–≥–æ –∫–≤–µ—Å—Ç–∞ (–†–µ–∞–∫—Ü–∏–∏)
            const isReactionClaimed = currentStudentData.lastRewardDate === today;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è 2-–≥–æ –∫–≤–µ—Å—Ç–∞ (–ü–æ–¥–¥–µ—Ä–∂–∫–∞)
            const isSupportClaimed = currentStudentData.lastSupportQuestDate === today;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –æ–±–æ–∏—Ö –∫–≤–µ—Å—Ç–æ–≤
            let html = '';

            // --- QUEST 1: Social Butterfly (–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π) ---
            html += `
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[2rem] p-8 text-white shadow-xl relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300 flex flex-col">
                    <div class="relative z-10 flex flex-col h-full">
                        <div class="flex items-center justify-between mb-4">
                            <span class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider border border-white/10">Daily Quest</span>
                            ${isReactionClaimed 
                                ? '<div class="w-8 h-8 bg-emerald-400 rounded-full flex items-center justify-center shadow-lg"><i data-lucide="check" class="w-5 h-5 text-white"></i></div>' 
                                : '<div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center animate-pulse"><i data-lucide="clock" class="w-5 h-5 text-white"></i></div>'}
                        </div>
                        
                        <h3 class="font-black text-2xl mb-2">Social Butterfly</h3>
                        <p class="text-indigo-100 font-medium mb-8 leading-relaxed opacity-90">React to a classmate's profile on the Leaderboard.</p>
                        
                        <div class="mt-auto">
                            ${isReactionClaimed 
                                ? '<button disabled class="w-full bg-white/20 text-white cursor-default px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-2 border border-white/10">Completed <i data-lucide="check-circle" class="w-5 h-5"></i></button>'
                                : `<button onclick="app.setStudentTab('rating')" class="w-full bg-white text-indigo-600 px-6 py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2 group-hover:shadow-indigo-900/20">Go to Leaderboard <i data-lucide="arrow-right" class="w-5 h-5"></i></button>`
                            }
                        </div>
                    </div>
                    <div class="absolute -right-6 -bottom-6 opacity-20 transform rotate-12 scale-150"><i data-lucide="smile-plus" class="w-48 h-48"></i></div>
                </div>
            `;

            // --- QUEST 2: Support Hero (–ù–û–í–´–ô) ---
            html += `
                <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-[2rem] p-8 text-white shadow-xl relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300 flex flex-col">
                    <div class="relative z-10 flex flex-col h-full">
                        <div class="flex items-center justify-between mb-4">
                            <span class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider border border-white/10">Daily Quest</span>
                            ${isSupportClaimed 
                                ? '<div class="w-8 h-8 bg-emerald-400 rounded-full flex items-center justify-center shadow-lg"><i data-lucide="check" class="w-5 h-5 text-white"></i></div>' 
                                : '<div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center animate-pulse"><i data-lucide="clock" class="w-5 h-5 text-white"></i></div>'}
                        </div>
                        
                        <h3 class="font-black text-2xl mb-2">Support Hero</h3>
                        <p class="text-pink-100 font-medium mb-8 leading-relaxed opacity-90">Write a kind message to support your classmate.</p>
                        
                        <div class="mt-auto">
                            ${isSupportClaimed 
                                ? '<button disabled class="w-full bg-white/20 text-white cursor-default px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-2 border border-white/10">Completed <i data-lucide="check-circle" class="w-5 h-5"></i></button>'
                                : `<button onclick="app.openSupportModal()" class="w-full bg-white text-pink-600 px-6 py-4 rounded-xl font-bold shadow-lg hover:bg-pink-50 transition-colors flex items-center justify-center gap-2 group-hover:shadow-pink-900/20">Write Message <i data-lucide="pen-tool" class="w-5 h-5"></i></button>`
                            }
                        </div>
                    </div>
                    <div class="absolute -right-6 -bottom-6 opacity-20 transform rotate-12 scale-150"><i data-lucide="heart-handshake" class="w-48 h-48"></i></div>
                </div>
            `;

            questContainer.innerHTML = html;
            lucide.createIcons();
        }

        async function loadStudentTasks() {
            if (!currentStudentId) return;
            
            const snap = await getDocs(getColPath('tasks'));
            const tasks = snap.docs
                .map(d => ({id: d.id, ...d.data()}))
                .filter(t => t.studentId === currentStudentId);

            tasks.sort((a, b) => b.createdAt - a.createdAt);

            // Calculate total score including bonus points
            const taskScore = tasks.reduce((acc, t) => acc + (t.score || 0), 0);
            const bonus = currentStudentData.bonusPoints || 0;
            document.getElementById('student-total-score').textContent = taskScore + bonus;
            
            const list = document.getElementById('student-tasks-list');
            
            if (tasks.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center text-slate-400 py-20 font-bold">No tasks yet</div>';
                return;
            }

            let html = '';
            tasks.forEach(t => {
                const isDone = t.status === 'completed';
                const isReview = t.status === 'review'; // Check if under review
                const isScheduled = t.publishAt && t.publishAt.toMillis() > Date.now();
                if (isScheduled) return;

                const deadlineDate = t.deadline ? t.deadline.toDate() : null;
                const isLate = deadlineDate && (Date.now() > deadlineDate.getTime()) && !isDone && !isReview;

                // Handle multiple images
                let images = [];
                if (t.imageUrls && Array.isArray(t.imageUrls)) images = t.imageUrls;
                else if (t.imageUrl) images = [t.imageUrl];

                let statusText = 'Pending';
                let statusColor = 'text-slate-300';
                
                if (isDone) {
                    statusColor = 'text-emerald-500';
                    statusText = `<span class="flex items-center gap-1"><i data-lucide="check-circle-2" class="w-4 h-4"></i> ${t.score} pts.</span>`;
                } else if (isReview) {
                    statusColor = 'text-amber-500';
                    statusText = `<span class="flex items-center gap-1"><i data-lucide="clock" class="w-4 h-4"></i> Under Review</span>`;
                }

                html += `
                    <div id="st-card-${t.id}" class="bg-white rounded-[2rem] border border-slate-100 shadow-sm transition-all duration-500 overflow-hidden flex flex-col h-full group">
                        
                        <div class="cursor-pointer px-6 py-5 flex flex-col flex-grow" onclick="app.toggleStudentTaskAccordion('${t.id}')">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex flex-col gap-1">
                                    <div class="text-[10px] ${isLate ? 'text-rose-500 font-bold' : 'text-slate-400 font-black'} uppercase tracking-widest">
                                        ${isLate ? 'Overdue' : (deadlineDate ? 'Deadline: ' + formatDate(deadlineDate) : 'No deadline')}
                                    </div>
                                    <div class="text-xs font-black ${statusColor}">
                                        ${statusText}
                                    </div>
                                </div>

                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                     <i id="st-chevron-${t.id}" data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300"></i>
                                </div>
                            </div>
                            
                            <!-- Image Grid -->
                            ${images.length > 0 ? `
                                <div class="grid grid-cols-${Math.min(3, images.length)} gap-2 mb-4">
                                    ${images.map(src => `
                                        <div class="${images.length === 1 ? 'aspect-video' : 'aspect-square'} rounded-2xl overflow-hidden border border-slate-100 relative group/img">
                                            <img src="${src}" onclick="event.stopPropagation(); app.openImageModal(this.src)" class="w-full h-full object-cover transition-transform group-hover/img:scale-105">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <h4 class="font-black text-slate-800 text-lg line-clamp-2 leading-snug mt-auto">${t.question}</h4>
                        </div>
                        
                        <div id="st-body-${t.id}" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-slate-50">
                             <div class="p-6 border-t border-slate-100">

                                <div class="text-slate-800 font-bold text-lg mb-6 whitespace-pre-wrap leading-relaxed border-b border-slate-200 pb-4">${t.question}</div>
                                
                                ${isDone || isReview ? `
                                    <div class="bg-white p-5 rounded-2xl border border-slate-200">
                                        <div class="font-bold text-slate-800 text-lg mb-2 font-mono leading-relaxed">
    ${isDone ? getDiffHTML(t.studentAnswer, t.correctAnswer || t.studentAnswer) : t.studentAnswer}
</div>
                                        <div class="h-px bg-slate-100 my-4"></div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs font-bold text-slate-400 uppercase">Status</span>
                                            ${isDone ? `<span class="text-2xl font-black text-blue-600">${t.score} pts</span>` : `<span class="text-sm font-black text-amber-500 bg-amber-50 px-3 py-1 rounded-full">Waiting for teacher</span>`}
                                        </div>
                                    </div>
                                   ` : `
                                    <div class="space-y-4">
                                        <input type="text" id="input-${t.id}" class="w-full px-6 py-4 rounded-2xl bg-white border-2 border-slate-200 focus:border-blue-500 outline-none font-bold text-slate-800 transition-all" placeholder="Your answer...">
                                        <button onclick="app.submitTask('${t.id}', '${t.correctAnswer}', ${t.deadline ? t.deadline.seconds : 9999999999}, '${t.answerType}')" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all">
                                            Submit
                                        </button>
                                    </div>
                                    `}
                             </div>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
            lucide.createIcons();
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.email) {
                    // Teacher found
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } else {
                    // Anonymous login (likely student)
                    const sid = localStorage.getItem('student_id');
                    if (sid) {
                        try {
                            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sid));
                            if (snap.exists()) {
                                currentStudentId = sid;
                                currentStudentData = snap.data();

                                document.getElementById('student-name-display').textContent = currentStudentData.name;
                                document.getElementById('student-phrase-display').textContent = currentStudentData.phrase;
                                window.app.showScreen('screen-student-dash');
                                loadStudentTasks();

                                // CHECK FOR INCOMING MESSAGES
                                setTimeout(app.checkIncomingSupport, 1000);
                            }
                        } catch(e) { console.error("Auto-login error", e); }
                    }
                }
            } else {
                // If no one logged in, sign in anonymously to allow DB reads
                signInAnonymously(auth).catch(() => {});
            }
        });
        
        lucide.createIcons();
    </script>
</body>
</html>