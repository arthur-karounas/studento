<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>With Lera</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* –£–±–∏—Ä–∞–µ–º –∂–µ—Å—Ç–∫–∏–π –±–µ–ª—ã–π —Ü–≤–µ—Ç, —á—Ç–æ–±—ã JS –º–æ–≥ –µ–≥–æ –º–µ–Ω—è—Ç—å */
        html { 
            background-color: #ffffff; 
            height: 100%;
        }

        body {
            background-color: #ffffff;
            padding-top: 0 !important;
            min-height: 100%;
        }

        /* –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ, –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–ª—ã–π –ø–æ–¥—Ç–æ–Ω */
        .mobile-header-glass {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(4rem + env(safe-area-inset-top)) !important;
            background-color: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            z-index: 40;
            display: flex;
            align-items: flex-end; 
            padding-bottom: 1rem; 
            justify-content: center;
        }

        body { font-family: 'Inter', sans-serif; }
        body.modal-open { overflow: hidden; }
        .hidden { display: none !important; }
        
        /* –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
        .active-tab { background: #4f46e5; color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2); }
        
        .student-active-tab { background: #f59e0b; color: white; box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.2); }

        /* –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ (–Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é) */
        .mobile-active-tab { color: #4f46e5 !important; }
        .mobile-active-tab i { transform: translateY(-4px); transition: transform 0.2s ease; }
        
        .student-mobile-active-tab { color: #d97706 !important; }
        .student-mobile-active-tab i { transform: translateY(-4px); transition: transform 0.2s ease; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        .task-card:hover { transform: translateY(-2px); transition: all 0.2s ease; }
        
        .step-node.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        .step-node.completed { background: #10b981; color: white; border-color: #10b981; }

        /* –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ Layout (–ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º) */
        @media (orientation: portrait), (max-width: 768px) {
            .desktop-sidebar { display: none !important; }
            .mobile-nav { display: flex !important; }
            .main-content { 
                padding-top: calc(5rem + env(safe-area-inset-top)) !important; 
                padding-bottom: 7rem !important;
                padding-left: 1rem !important; 
                padding-right: 1rem !important; 
            }
            .screen-header { text-align: center; }
            .screen-header h2 { display: none; }
            .screen-header p { display: none; }
            
            .login-card { 
                background: transparent !important; 
                box-shadow: none !important; 
                border: none !important; 
                padding-left: 1.5rem !important; 
                padding-right: 1.5rem !important;
            }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–º–æ–¥–∑–∏ */
        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .emoji-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 min-h-screen font-medium">

    <div id="notification-container" class="fixed top-20 right-4 md:top-6 md:right-6 z-[200] flex flex-col gap-3 w-[calc(100%-2rem)] md:w-auto"></div>

    <!-- MODAL: CONFIRM -->
    <div id="modal-confirm" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mb-6">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-extrabold text-slate-800 mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h3>
                <p id="confirm-message" class="text-slate-500 mb-8 text-sm">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                <div class="flex gap-3 w-full">
                    <button id="confirm-cancel" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">–û—Ç–º–µ–Ω–∞</button>
                    <button id="confirm-ok" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-bold hover:bg-rose-600 transition-all shadow-lg shadow-rose-200">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: EDIT SCORE -->
    <div id="modal-edit-score" class="fixed inset-0 z-[160] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 animate-slide-up">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-6 shadow-inner">
                    <i data-lucide="pencil" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–ª</h3>
                <p class="text-slate-500 mb-8 text-sm font-medium">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –æ—Ü–µ–Ω–∫—É –¥–ª—è —É—á–µ–Ω–∏–∫–∞</p>
                
                <input type="number" id="edit-score-input" min="0" max="10" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-black text-center text-3xl text-indigo-600 mb-8 placeholder:text-slate-200" placeholder="0">

                <div class="flex gap-3 w-full">
                    <button onclick="app.closeEditScoreModal()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">–û—Ç–º–µ–Ω–∞</button>
                    <button onclick="app.saveScore()" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EMOJI REACTION -->
    <div id="modal-emoji" class="fixed inset-0 z-[170] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="app.closeEmojiModal()"></div>
        <div class="relative bg-white w-full max-w-xs rounded-[2rem] shadow-2xl p-6 animate-slide-up">
            <div class="text-center mb-6">
                <h3 class="text-xl font-black text-slate-800">–†–µ–∞–∫—Ü–∏—è</h3>
                <p id="reaction-hint" class="text-xs text-slate-400 font-bold mt-1">–ú–∞–∫—Å–∏–º—É–º 2 –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Å</p>
            </div>
            <div class="grid grid-cols-4 gap-3 mb-6">
                <!-- Emojis will be injected here -->
                <button onclick="app.sendReaction('üî•')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üî•</button>
                <button onclick="app.sendReaction('‚ù§Ô∏è')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">‚ù§Ô∏è</button>
                <button onclick="app.sendReaction('üöÄ')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üöÄ</button>
                <button onclick="app.sendReaction('üåü')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üåü</button>
                <button onclick="app.sendReaction('üëë')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üëë</button>
                <button onclick="app.sendReaction('üòé')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üòé</button>
                <button onclick="app.sendReaction('üß†')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üß†</button>
                <button onclick="app.sendReaction('üëª')" class="text-3xl hover:bg-slate-50 p-3 rounded-2xl transition-colors">üëª</button>
            </div>
            <button onclick="app.deleteReaction()" id="btn-delete-reaction" class="w-full py-3 bg-rose-50 text-rose-500 rounded-xl font-bold hover:bg-rose-100 transition-colors hidden">–£–±—Ä–∞—Ç—å —Ä–µ–∞–∫—Ü–∏—é</button>
        </div>
    </div>

    <!-- MAIN SCREEN -->
    <div id="screen-main" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="max-w-md w-full text-center space-y-10 animate-slide-up">
            <div class="flex justify-center">
                <div class="relative">
                    <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 animate-pulse"></div>
                    <div class="relative bg-indigo-600 p-6 rounded-[2rem] shadow-2xl">
                        <i data-lucide="graduation-cap" class="text-white w-14 h-14"></i>
                    </div>
                </div>
            </div>
            <div>
                <h1 class="text-5xl font-black tracking-tight text-slate-900 mb-4">With Lera</h1>
                <p class="text-slate-500 text-lg leading-relaxed px-4">–£–¥–æ–±–Ω–∞—è –∏ –ø—Ä–æ—Å—Ç–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è!</p>
            </div>
            <div class="space-y-4 px-2">
                <button onclick="app.showScreen('screen-student-login')" class="w-full py-5 rounded-2xl bg-indigo-600 text-white text-lg font-bold hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100 flex items-center justify-center gap-3 group">
                    –£—á–µ–Ω–∏–∫
                </button>
                <button onclick="app.showScreen('screen-teacher-login')" class="w-full py-5 rounded-2xl bg-white border-2 border-slate-100 text-slate-700 text-lg font-bold hover:border-indigo-400 transition-all">
                    –£—á–∏—Ç–µ–ª—å
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREENS -->
    <div id="screen-teacher-login" class="screen hidden min-h-screen flex items-center justify-center p-0 md:p-6 bg-white md:bg-[#FFFFFF]">
        <div class="login-card max-w-sm w-full bg-white rounded-[2.5rem] p-8 md:p-10 md:shadow-2xl md:border md:border-slate-50 animate-slide-up text-center">
            <button onclick="app.showScreen('screen-main')" class="text-slate-400 hover:text-indigo-600 mb-10 flex items-center justify-center gap-2 text-sm font-extrabold transition-colors mx-auto">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
            </button>
            <div class="mb-10">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="graduation-cap" class="w-10 h-10"></i>
                </div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">–£—á–∏—Ç–µ–ª—å</h2>
            </div>
            <div class="space-y-4">
                <input type="email" id="t-email" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-center placeholder:text-slate-300" placeholder="Email">
                <input type="password" id="t-password" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-center placeholder:text-slate-300" placeholder="–ü–∞—Ä–æ–ª—å">
                <div class="pt-4 space-y-3">
                    <button onclick="app.teacherLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-[0.98]">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
                    <button onclick="app.teacherRegister()" class="w-full py-4 text-indigo-600 font-bold hover:bg-indigo-50 rounded-2xl transition-all">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-student-login" class="screen hidden min-h-screen flex items-center justify-center p-0 md:p-6 bg-white md:bg-[#FFFFFF]">
        <div class="login-card max-w-sm w-full bg-white rounded-[2.5rem] p-8 md:p-10 md:shadow-2xl md:border md:border-slate-50 animate-slide-up text-center">
            <button onclick="app.showScreen('screen-main')" class="text-slate-400 hover:text-indigo-600 mb-10 flex items-center justify-center gap-2 text-sm font-extrabold transition-colors mx-auto">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
            </button>
            <div class="mb-10">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="key-round" class="w-10 h-10"></i>
                </div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">–ü—Ä–∏–≤–µ—Ç!</h2>
                <p class="text-slate-400 mt-2 font-semibold leading-relaxed">–í–≤–µ–¥–∏ —Å–≤–æ–∏ —Ç—Ä–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            <div class="space-y-6">
                <input type="text" id="s-phrase" class="w-full px-6 py-6 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white text-center font-black text-xl outline-none transition-all placeholder:font-bold placeholder:text-slate-200" placeholder="—Å–ª–æ–≤–æ —Å–ª–æ–≤–æ —Å–ª–æ–≤–æ">
                <button onclick="app.studentLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-[0.98]">–í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="screen-teacher-dash" class="screen hidden min-h-screen md:h-screen md:overflow-hidden flex flex-col md:flex-row relative">
        
        <!-- MOBILE TOP HEADER (Fixed) -->
        <header class="md:hidden mobile-header-glass border-b border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.02)]">
            <h1 id="mobile-header-title" class="font-black text-2xl text-slate-800">–ö–ª–∞—Å—Å</h1>
        </header>

        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar w-80 bg-white border-r border-slate-100 p-8 flex flex-col shrink-0 overflow-y-auto">
            <div class="flex items-center gap-3 mb-12 px-2 font-black text-2xl text-indigo-600 italic">
                <div class="bg-indigo-600 p-2 rounded-lg text-white not-italic shadow-lg shadow-indigo-100">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                </div>
                With Lera
            </div>
            <nav class="flex-grow space-y-3">
                <button onclick="app.setTeacherTab('students')" id="tab-btn-students" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 active-tab">
                    <i data-lucide="users" class="w-5 h-5"></i> –ö–ª–∞—Å—Å
                </button>
                <button onclick="app.setTeacherTab('tasks')" id="tab-btn-tasks" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i> –ó–∞–¥–∞–Ω–∏—è
                </button>
                <button onclick="app.setTeacherTab('stats')" id="tab-btn-stats" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </button>
                <button onclick="app.setTeacherTab('rating')" id="tab-btn-rating" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="trophy" class="w-5 h-5"></i> –†–µ–π—Ç–∏–Ω–≥
                </button>
            </nav>
            <button onclick="app.logout()" class="mt-auto flex items-center gap-4 px-6 py-4 rounded-2xl text-rose-500 font-bold hover:bg-rose-50 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i> –í—ã–π—Ç–∏
            </button>
        </aside>

        <!-- Mobile Bottom Nav -->
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-50 flex flex-row justify-around items-center p-2 pb-6 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <button onclick="app.setTeacherTab('students')" id="mob-tab-students" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px] mobile-active-tab">
                <i data-lucide="users" class="w-6 h-6"></i> –ö–ª–∞—Å—Å
            </button>
            <button onclick="app.setTeacherTab('tasks')" id="mob-tab-tasks" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="clipboard-list" class="w-6 h-6"></i> –ó–∞–¥–∞–Ω–∏—è
            </button>
            <button onclick="app.setTeacherTab('stats')" id="mob-tab-stats" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="bar-chart-2" class="w-6 h-6"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            </button>
            <button onclick="app.setTeacherTab('rating')" id="mob-tab-rating" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="trophy" class="w-6 h-6"></i> –†–µ–π—Ç–∏–Ω–≥
            </button>
            <button onclick="app.logout()" class="flex flex-col items-center gap-1 p-3 text-rose-400 font-black text-[10px]">
                <i data-lucide="log-out" class="w-6 h-6"></i> –í—ã—Ö–æ–¥
            </button>
        </nav>

        <main class="main-content flex-grow p-6 md:p-12 overflow-y-auto bg-[#F8FAFC]">
            <!-- TAB: STUDENTS -->
            <section id="tab-students" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 md:mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">–ö–ª–∞—Å—Å</h2>
                    <button onclick="app.toggleAddStudentForm()" class="w-full md:w-auto bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                        <i data-lucide="user-plus" class="w-5 h-5"></i> –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞
                    </button>
                </div>
                <div id="add-student-form" class="hidden mb-10 bg-white p-6 md:p-8 rounded-[2rem] border-2 border-indigo-100 shadow-sm">
                    <h3 class="font-black text-xl mb-6">–ù–æ–≤—ã–π —É—á–µ–Ω–∏–∫</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="new-name" class="px-6 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-indigo-400 outline-none font-bold" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
                        <input type="text" id="new-phrase" class="px-6 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-indigo-400 outline-none font-bold" placeholder="3 —Å–ª–æ–≤–∞ –ø–∞—Ä–æ–ª—è">
                        <button onclick="app.createStudent()" class="py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div id="student-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- TAB: TASKS -->
            <section id="tab-tasks" class="hidden">
                <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-0 mb-6 md:mb-10 screen-header">
                    <div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800">–ó–∞–¥–∞–Ω–∏—è</h2>
                        <p class="text-slate-500 mt-1 font-medium">–†–∞—Å—Å—ã–ª–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                    </div>
                    <button onclick="app.openNewTaskForm()" class="bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i> –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                    </button>
                </div>
                <div id="task-creation-wizard" class="hidden mb-12">
                    <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
                        <div class="bg-slate-900 px-6 py-5 md:px-10 md:py-6 flex justify-between items-center">
                            <h3 id="wizard-title" class="text-white font-bold">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è</h3>
                            <button onclick="app.closeNewTaskForm()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="p-6 md:p-10">
                            <div class="flex items-center justify-between mb-10 max-w-md mx-auto relative">
                                <div class="absolute h-1 bg-slate-100 top-1/2 left-0 right-0 -translate-y-1/2 z-0"></div>
                                <div id="step-line-1" class="absolute h-1 bg-indigo-500 top-1/2 left-0 w-0 -translate-y-1/2 z-0 transition-all duration-500"></div>
                                <div class="step-node active relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-1">1</div>
                                <div class="step-node relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-2">2</div>
                                <div class="step-node relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-3">3</div>
                            </div>
                            <div id="wizard-step-1" class="space-y-6 max-w-xl mx-auto">
                                <textarea id="task-text" rows="4" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white outline-none font-medium text-lg resize-none" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"></textarea>
                                
                                <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ç–≤–µ—Ç–∞ -->
                                <div class="bg-slate-100 p-1.5 rounded-2xl flex gap-1">
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="answerType" value="digits" class="peer sr-only">
                                        <div class="py-3 px-2 rounded-xl text-center text-xs sm:text-sm font-bold text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-2">
                                            <span>üî¢</span> –¶–∏—Ñ—Ä—ã
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="answerType" value="text" class="peer sr-only">
                                        <div class="py-3 px-2 rounded-xl text-center text-xs sm:text-sm font-bold text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-2">
                                            <span>üî†</span> –ë—É–∫–≤—ã
                                        </div>
                                    </label>
                                    <label class="flex-1 cursor-pointer">
                                        <input type="radio" name="answerType" value="mixed" class="peer sr-only" checked>
                                        <div class="py-3 px-2 rounded-xl text-center text-xs sm:text-sm font-bold text-slate-400 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all flex items-center justify-center gap-2">
                                            <span>üí°</span> –°–º–µ—à–∞–Ω–Ω—ã–π
                                        </div>
                                    </label>
                                </div>

                                <input type="text" id="task-answer" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white outline-none font-bold" placeholder="–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç">
                                <button onclick="app.nextWizardStep(2)" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">–î–∞–ª–µ–µ</button>
                            </div>
                            <div id="wizard-step-2" class="hidden space-y-6 max-w-2xl mx-auto">
                                <div id="student-checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-1"></div>
                                <div class="flex gap-3">
                                    <button onclick="app.nextWizardStep(1)" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold">–ù–∞–∑–∞–¥</button>
                                    <button onclick="app.nextWizardStep(3)" class="flex-[2] py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">–î–∞–ª–µ–µ</button>
                                </div>
                            </div>
                            <div id="wizard-step-3" class="hidden space-y-8 max-w-xl mx-auto">
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                                        <div class="relative">
                                            <input type="text" onfocus="(this.type='datetime-local')" onblur="if(!this.value)this.type='text'" id="task-publish-date" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 font-bold text-slate-700" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è">
                                            <div class="text-xs text-slate-400 mt-2 ml-2">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                                        <input type="text" onfocus="(this.type='datetime-local')" onblur="if(!this.value)this.type='text'" id="task-deadline" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 font-bold text-slate-700" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ü–µ–Ω–∫—É)">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button onclick="app.nextWizardStep(2)" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold">–ù–∞–∑–∞–¥</button>
                                    <button onclick="app.assignTask()" class="flex-[2] py-5 bg-emerald-500 text-white rounded-2xl font-black shadow-xl">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="teacher-tasks-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6"></div>
            </section>

            <!-- TAB: STATS -->
            <section id="tab-stats" class="hidden">
                <div class="hidden md:flex flex-col md:flex-row justify-between items-center gap-4 md:mb-10 screen-header">
                    <div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800">–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                        <p class="text-slate-500 mt-1 font-medium">–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–ª–∞—Å—Å–∞</p>
                    </div>
                </div>
                <div id="quick-stats" class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-10"></div>
                <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 shadow-sm border border-slate-100">
                    <div class="h-[300px] md:h-[450px] mb-12"><canvas id="statsChart"></canvas></div>
                    <div class="border-t border-slate-50 pt-10">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 ml-2">–†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤</h3>
                        <div id="stats-summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                    </div>
                </div>
            </section>
            
            <!-- TAB: RATING (Teacher) -->
            <section id="tab-rating" class="hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">–†–µ–π—Ç–∏–Ω–≥</h2>
                    <p class="text-slate-400 font-medium">–°—Ç–µ–Ω–∞ –ø–æ—á–µ—Ç–∞ –∫–ª–∞—Å—Å–∞</p>
                </div>
                <div id="teacher-rating-list" class="max-w-2xl mx-auto space-y-4"></div>
            </section>
        </main>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="screen-student-dash" class="screen hidden min-h-screen md:h-screen md:overflow-hidden flex flex-col md:flex-row">
        
        <!-- MOBILE TOP HEADER (Fixed) -->
        <header class="md:hidden mobile-header-glass border-b border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.02)]">
            <h1 id="mobile-student-title" class="font-black text-2xl text-slate-800">–ú–æ–∏ —É—Ä–æ–∫–∏</h1>
        </header>

        <aside class="desktop-sidebar w-80 bg-white border-r border-slate-100 p-8 flex flex-col shrink-0 overflow-y-auto">
            <div class="flex items-center gap-3 mb-12 font-black text-2xl uppercase tracking-widest text-amber-600 italic"><i data-lucide="backpack"></i> With Lera</div>
            <nav class="flex-grow space-y-3">
                <button onclick="app.setStudentTab('lessons')" id="st-tab-btn-lessons" class="w-full px-6 py-4 rounded-2xl font-black flex items-center gap-4 shadow-sm student-active-tab transition-all hover:bg-amber-50">
                    <i data-lucide="book-open"></i> –ú–æ–∏ —É—Ä–æ–∫–∏
                </button>
                <button onclick="app.setStudentTab('rating')" id="st-tab-btn-rating" class="w-full px-6 py-4 rounded-2xl font-black flex items-center gap-4 text-slate-400 transition-all hover:bg-amber-50 hover:text-amber-600">
                    <i data-lucide="trophy"></i> –†–µ–π—Ç–∏–Ω–≥
                </button>
            </nav>
            <div class="mt-auto pt-8 border-t border-slate-50">
                <div class="bg-amber-50 rounded-[2rem] p-6 mb-8 border border-amber-100">
                    <p id="student-name-display" class="font-black text-slate-900 truncate text-lg">...</p>
                    <p id="student-phrase-display" class="text-xs text-amber-700 opacity-60 font-mono mb-4"></p>
                    <div class="bg-white px-5 py-3 rounded-2xl flex justify-between items-center shadow-sm">
                        <span id="student-total-score" class="font-black text-amber-700 text-2xl">0</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 font-bold">–í—ã–π—Ç–∏</button>
            </div>
        </aside>
        
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-50 flex flex-row justify-around items-center p-2 pb-6 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <button onclick="app.setStudentTab('lessons')" id="st-mob-tab-lessons" class="flex flex-col items-center gap-1 p-3 text-amber-500 font-black text-[10px] student-mobile-active-tab">
                <i data-lucide="book-open" class="w-6 h-6"></i> –£—Ä–æ–∫–∏
            </button>
            <button onclick="app.setStudentTab('rating')" id="st-mob-tab-rating" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="trophy" class="w-6 h-6"></i> –†–µ–π—Ç–∏–Ω–≥
            </button>
            <button onclick="app.logout()" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="log-out" class="w-6 h-6"></i> –í—ã—Ö–æ–¥
            </button>
        </nav>

        <main class="main-content flex-grow p-6 md:p-12 overflow-y-auto bg-[#F8FAFC]">
            <!-- STUDENT TAB: LESSONS -->
            <section id="tab-student-lessons">
                <h2 class="text-3xl md:text-4xl font-black mb-8 text-slate-800 md:block hidden">–£—Ä–æ–∫–∏</h2>
                <div id="student-tasks-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </section>

            <!-- STUDENT TAB: RATING -->
            <section id="tab-student-rating" class="hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">–ó–∞–ª —Å–ª–∞–≤—ã</h2>
                    <p class="text-slate-400 font-medium">–ê–Ω–æ–Ω–∏–º–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–∞</p>
                </div>
                <div id="student-rating-list" class="max-w-2xl mx-auto space-y-4"></div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, setDoc, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyA_mptcpENpEsrJYHXBRxb-rlRH_eqI8-E","authDomain":"studento-aa5d2.firebaseapp.com","projectId":"studento-aa5d2","storageBucket":"studento-aa5d2.firebasestorage.app","messagingSenderId":"1078257307837","appId":"1:1078257307837:web:9ea84484c1dfdb129ca7d4"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-edu-v4';
        
        const appFb = initializeApp(firebaseConfig);
        const auth = getAuth(appFb);
        const db = getFirestore(appFb);

        let currentStudentId = null;
        let currentStudentData = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ –æ —Å—Ç—É–¥–µ–Ω—Ç–µ (–∏ —É—á–∏—Ç–µ–ª–µ)
        let groupedTasks = []; 
        let drafts = [];
        let editingDraftId = null;
        let statsChart = null;
        let currentEditingTaskId = null;
        let currentReactionTargetId = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —É—á–µ–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –°–¢–†–û–ö (–ê–ª–≥–æ—Ä–∏—Ç–º –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞) ===
        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            const matrix = [];

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // –∑–∞–º–µ–Ω–∞
                            Math.min(
                                matrix[i][j - 1] + 1, // –≤—Å—Ç–∞–≤–∫–∞
                                matrix[i - 1][j] + 1 // —É–¥–∞–ª–µ–Ω–∏–µ
                            )
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }

        // === –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML DIFF –î–õ–Ø –û–®–ò–ë–û–ö ===
        function getDiffHTML(student, correct) {
            const s = student.trim();
            const c = correct.trim();
            
            // –†–∞–∑–º–µ—Ä—ã –º–∞—Ç—Ä–∏—Ü—ã
            const n = s.length;
            const m = c.length;
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É
            const dp = Array.from({ length: n + 1 }, () => Array(m + 1).fill(0));

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞–Ω–∏—Ü
            for (let i = 0; i <= n; i++) dp[i][0] = i;
            for (let j = 0; j <= m; j++) dp[0][j] = j;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è)
            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    if (s[i - 1].toLowerCase() === c[j - 1].toLowerCase()) { 
                        dp[i][j] = dp[i - 1][j - 1];
                    } else {
                        dp[i][j] = Math.min(
                            dp[i - 1][j] + 1,      // –£–¥–∞–ª–µ–Ω–∏–µ
                            dp[i][j - 1] + 1,      // –í—Å—Ç–∞–≤–∫–∞
                            dp[i - 1][j - 1] + 1  // –ó–∞–º–µ–Ω–∞
                        );
                    }
                }
            }

            // –û–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML
            let i = n, j = m;
            let html = '';

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && s[i - 1].toLowerCase() === c[j - 1].toLowerCase()) {
                    html = s[i - 1] + html; // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –ø—Ä–æ—Å—Ç–æ —Å–∏–º–≤–æ–ª
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j] === dp[i][j - 1] + 1)) {
                    // –í—Å—Ç–∞–≤–∫–∞ (–Ω—É–∂–Ω–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º, –Ω–µ—Ç —É —Å—Ç—É–¥–µ–Ω—Ç–∞) -> –ó–µ–ª–µ–Ω—ã–π
                    html = `<span class="bg-emerald-200 text-emerald-700 px-0.5 rounded mx-0.5">${c[j - 1]}</span>` + html;
                    j--;
                } else if (i > 0 && (j === 0 || dp[i][j] === dp[i - 1][j] + 1)) {
                    // –£–¥–∞–ª–µ–Ω–∏–µ (–µ—Å—Ç—å —É —Å—Ç—É–¥–µ–Ω—Ç–∞, –ª–∏—à–Ω–µ–µ) -> –ö—Ä–∞—Å–Ω—ã–π –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π
                      html = `<span class="bg-rose-200 text-rose-600 line-through px-0.5 rounded mx-0.5 opacity-80 decoration-2 decoration-rose-500">${s[i - 1]}</span>` + html;
                    i--;
                } else {
                      // –ó–∞–º–µ–Ω–∞ -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º —á—Ç–æ –±—ã–ª–æ, –∑–µ–ª–µ–Ω—ã–º —á—Ç–æ –Ω–∞–¥–æ
                    html = `<span class="bg-emerald-200 text-emerald-700 px-0.5 rounded mx-0.5">${c[j - 1]}</span><span class="bg-rose-200 text-rose-600 line-through px-0.5 rounded mx-0.5 opacity-80 decoration-2 decoration-rose-500">${s[i - 1]}</span>` + html;
                    i--; j--;
                }
            }
            return html;
        }

        function calculateSimilarity(s1, s2) {
            const a = s1.trim().toLowerCase();
            const b = s2.trim().toLowerCase();
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã
            if (a === b) return 100;

            const maxLength = Math.max(a.length, b.length);
            if (maxLength === 0) return 100; // –û–±–µ –ø—É—Å—Ç—ã–µ

            const distance = levenshtein(a, b);
            const similarity = (1 - distance / maxLength) * 100;
            return Math.floor(similarity);
        }
        // =================================================================

        const formatDate = (inputDate) => {
            if (!inputDate) return "";
            const d = new Date(inputDate);
            return d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        const notify = (text, type = 'info') => {
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = `${type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'} text-white px-6 py-4 rounded-2xl shadow-2xl animate-slide-up mb-2 flex items-center gap-3 font-bold`;
            el.innerHTML = `<span class="text-sm">${text}</span>`;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 400); }, 3000);
        };

        const getColPath = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

        let activeTeacherTab = 'students';
        let activeStudentTab = 'lessons';

        window.app = {
            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                document.getElementById('screen-main').classList.add('hidden');
                document.getElementById(id).classList.remove('hidden');
                
                // === –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –§–û–ù –î–õ–Ø OVERSCROLL ===
                // –ï—Å–ª–∏ –º—ã –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ, –∫—Ä–∞—Å–∏–º "–ø–æ–¥–ª–æ–∂–∫—É" –≤ —Å–µ—Ä—ã–π
                if (id === 'screen-teacher-dash' || id === 'screen-student-dash') {
                    document.documentElement.style.backgroundColor = '#F8FAFC';
                    document.body.style.backgroundColor = '#F8FAFC';
                    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–¥–ª—è Android Chrome –∏ —Ç.–¥.)
                    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                    if (metaThemeColor) metaThemeColor.setAttribute('content', '#F8FAFC');
                } else {
                    // –ï—Å–ª–∏ –Ω–∞ –ª–æ–≥–∏–Ω–µ/–≥–ª–∞–≤–Ω–æ–π, –∫—Ä–∞—Å–∏–º –≤ –±–µ–ª—ã–π
                    document.documentElement.style.backgroundColor = '#ffffff';
                    document.body.style.backgroundColor = '#ffffff';
                    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                    if (metaThemeColor) metaThemeColor.setAttribute('content', '#ffffff');
                }
                
                lucide.createIcons();
            },

            askConfirm: (message) => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal-confirm');
                    document.getElementById('confirm-message').textContent = message;
                    modal.classList.remove('hidden');
                    document.body.classList.add('modal-open');
                    document.getElementById('confirm-ok').onclick = () => { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); resolve(true); };
                    document.getElementById('confirm-cancel').onclick = () => { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); resolve(false); };
                });
            },

            setTeacherTab: (tab) => {
                if (activeTeacherTab === tab && !document.getElementById(`tab-${tab}`).classList.contains('hidden')) {
                    return; 
                }

                const tabs = ['students', 'tasks', 'stats', 'rating'];
                const titles = { students: '–ö–ª–∞—Å—Å', tasks: '–ó–∞–¥–∞–Ω–∏—è', stats: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', rating: '–†–µ–π—Ç–∏–Ω–≥' };
                
                const mobileTitle = document.getElementById('mobile-header-title');
                if (mobileTitle) mobileTitle.textContent = titles[tab];

                tabs.forEach(t => {
                    const el = document.getElementById(`tab-${t}`);
                    const isVisible = t === tab;
                    
                    if (isVisible) {
                        el.classList.remove('hidden');
                        el.classList.remove('animate-slide-up');
                        void el.offsetWidth; 
                        el.classList.add('animate-slide-up');
                    } else {
                        el.classList.add('hidden');
                    }
                    
                    document.getElementById(`tab-btn-${t}`).classList.toggle('active-tab', isVisible);
                    const mobBtn = document.getElementById(`mob-tab-${t}`);
                    if(mobBtn) mobBtn.classList.toggle('mobile-active-tab', isVisible);
                });
                
                activeTeacherTab = tab;

                if(tab === 'students') loadMyStudents();
                if(tab === 'tasks') loadTeacherTasks();
                if(tab === 'stats') loadStatistics();
                if(tab === 'rating') loadTeacherLeaderboard();
                lucide.createIcons();
            },

            setStudentTab: (tab) => {
                if (activeStudentTab === tab && !document.getElementById(`tab-student-${tab}`).classList.contains('hidden')) {
                     return;
                }
                
                const tabs = ['lessons', 'rating'];
                const titles = { lessons: '–ú–æ–∏ —É—Ä–æ–∫–∏', rating: '–†–µ–π—Ç–∏–Ω–≥' };

                const mobileTitle = document.getElementById('mobile-student-title');
                if (mobileTitle) mobileTitle.textContent = titles[tab];

                tabs.forEach(t => {
                    const el = document.getElementById(`tab-student-${t}`);
                    const isVisible = t === tab;
                    
                    if (isVisible) {
                         el.classList.remove('hidden');
                         el.classList.remove('animate-slide-up');
                         void el.offsetWidth;
                         el.classList.add('animate-slide-up');
                    } else {
                        el.classList.add('hidden');
                    }

                    const btn = document.getElementById(`st-tab-btn-${t}`);
                    if (isVisible) {
                        btn.classList.add('student-active-tab');
                        btn.classList.remove('text-slate-400', 'hover:bg-amber-50', 'hover:text-amber-600');
                    } else {
                        btn.classList.remove('student-active-tab');
                        btn.classList.add('text-slate-400', 'hover:bg-amber-50', 'hover:text-amber-600');
                    }

                    const mobBtn = document.getElementById(`st-mob-tab-${t}`);
                    mobBtn.classList.toggle('student-mobile-active-tab', isVisible);
                    if(!isVisible) mobBtn.classList.add('text-slate-400');
                    else mobBtn.classList.remove('text-slate-400');
                });

                activeStudentTab = tab;
                if (tab === 'lessons') loadStudentTasks();
                if (tab === 'rating') loadStudentLeaderboard();
                lucide.createIcons();
            },

            toggleAddStudentForm: () => document.getElementById('add-student-form').classList.toggle('hidden'),

            openNewTaskForm: (draftId = null) => {
                document.getElementById('task-creation-wizard').classList.remove('hidden');
                editingDraftId = draftId;

                // Reset inputs
                document.getElementById('task-text').value = '';
                document.getElementById('task-answer').value = '';
                document.getElementById('task-deadline').value = '';
                document.getElementById('task-publish-date').value = '';
                document.querySelector('input[name="answerType"][value="mixed"]').checked = true; // Default
                document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);

                document.getElementById('wizard-title').textContent = draftId ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞" : "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è";

                if (draftId) {
                    const draft = drafts.find(d => d.id === draftId);
                    if (draft) {
                        document.getElementById('task-text').value = draft.question || '';
                        document.getElementById('task-answer').value = draft.correctAnswer || '';
                        if (draft.deadline) document.getElementById('task-deadline').value = draft.deadline; 
                        if (draft.publishAt) document.getElementById('task-publish-date').value = draft.publishAt;
                        
                        // Set Answer Type
                        if (draft.answerType) {
                            const rb = document.querySelector(`input[name="answerType"][value="${draft.answerType}"]`);
                            if (rb) rb.checked = true;
                        }

                        if (draft.studentIds && Array.isArray(draft.studentIds)) {
                            draft.studentIds.forEach(sid => {
                                const cb = document.querySelector(`.student-checkbox[value="${sid}"]`);
                                if (cb) cb.checked = true;
                            });
                        }
                    }
                }

                app.nextWizardStep(1);
            },

            closeNewTaskForm: async () => {
                const question = document.getElementById('task-text').value.trim();
                const container = document.getElementById('task-creation-wizard');
                
                if (question) {
                    const answer = document.getElementById('task-answer').value.trim();
                    const deadline = document.getElementById('task-deadline').value;
                    const publishAt = document.getElementById('task-publish-date').value;
                    const answerType = document.querySelector('input[name="answerType"]:checked').value;
                    const checked = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

                    const draftData = {
                        teacherId: auth.currentUser.uid,
                        question,
                        correctAnswer: answer,
                        answerType,
                        deadline, 
                        publishAt, 
                        studentIds: checked,
                        updatedAt: Date.now()
                    };

                    try {
                        if (editingDraftId) {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drafts', editingDraftId), draftData);
                        } else {
                            await addDoc(getColPath('drafts'), draftData);
                        }
                        notify("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫", "info");
                    } catch (e) {
                        console.error(e);
                        notify("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞", "error");
                    }
                }

                editingDraftId = null;
                container.classList.add('hidden');
                loadTeacherTasks(); 
            },
            
            nextWizardStep: (step) => {
                [1, 2, 3].forEach(s => {
                    document.getElementById(`wizard-step-${s}`).classList.toggle('hidden', s !== step);
                    const node = document.getElementById(`node-${s}`);
                    node.classList.toggle('active', s === step);
                    node.classList.toggle('completed', s < step);
                });
                document.getElementById('step-line-1').style.width = step === 1 ? '0%' : step === 2 ? '50%' : '100%';
            },

            teacherLogin: async () => {
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-password').value);
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } catch (e) { notify("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞", "error"); }
            },

            teacherRegister: async () => {
                try {
                    await createUserWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-password').value);
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } catch (e) { notify("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏", "error"); }
            },

            createStudent: async () => {
                const name = document.getElementById('new-name').value;
                const phrase = document.getElementById('new-phrase').value.trim().toLowerCase();
                if (!name || phrase.split(/\s+/).length !== 3) return notify("–ù—É–∂–Ω–æ –∏–º—è –∏ 3 —Å–ª–æ–≤–∞", "error");
                try {
                    await addDoc(getColPath('students'), { teacherId: auth.currentUser.uid, name, phrase, createdAt: Date.now() });
                    document.getElementById('new-name').value = ''; document.getElementById('new-phrase').value = '';
                    notify("–ì–æ—Ç–æ–≤–æ", "success");
                    loadMyStudents();
                    app.toggleAddStudentForm();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },

            deleteStudent: async (sid) => {
                if(await app.askConfirm("–£–¥–∞–ª–∏—Ç—å?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sid));
                    loadMyStudents();
                }
            },

            assignTask: async () => {
                const text = document.getElementById('task-text').value;
                const answer = document.getElementById('task-answer').value.trim();
                const deadlineVal = document.getElementById('task-deadline').value;
                const publishVal = document.getElementById('task-publish-date').value;
                const answerType = document.querySelector('input[name="answerType"]:checked').value;
                const checked = document.querySelectorAll('.student-checkbox:checked');
                
                if (!text || !answer || !deadlineVal || checked.length === 0) return notify("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë", "error");
                
                const groupId = Date.now().toString();
                const publishAt = publishVal ? Timestamp.fromDate(new Date(publishVal)) : Timestamp.now();
                const deadline = Timestamp.fromDate(new Date(deadlineVal));

                try {
                    const promises = Array.from(checked).map(cb => {
                        return addDoc(getColPath('tasks'), {
                            groupId, teacherId: auth.currentUser.uid, studentId: cb.value, studentName: cb.dataset.name,
                            question: text, correctAnswer: answer, answerType: answerType,
                            deadline: deadline,
                            publishAt: publishAt,
                            status: 'assigned', score: 0, createdAt: Date.now()
                        });
                    });
                    await Promise.all(promises);
                    
                    if (editingDraftId) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drafts', editingDraftId));
                    }
                    
                    document.getElementById('task-text').value = ''; 
                    editingDraftId = null;

                    notify("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "success");
                    document.getElementById('task-creation-wizard').classList.add('hidden');
                    loadTeacherTasks();
                } catch (e) { console.error(e); notify("–û—à–∏–±–∫–∞", "error"); }
            },

            deleteTaskGroup: async (groupId) => {
                if(await app.askConfirm("–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö?")) {
                    const group = groupedTasks.find(g => g.groupId === groupId);
                    await Promise.all(group.items.map(item => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', item.id))));
                    loadTeacherTasks();
                }
            },

            deleteDraft: async (draftId) => {
                 if(await app.askConfirm("–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drafts', draftId));
                    loadTeacherTasks();
                }
            },

            // === –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ë–ê–õ–õ–ê (–ß–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) ===
            editScore: (taskId, currentScore) => {
                currentEditingTaskId = taskId;
                document.getElementById('edit-score-input').value = currentScore;
                document.getElementById('modal-edit-score').classList.remove('hidden');
            },
            
            closeEditScoreModal: () => {
                 document.getElementById('modal-edit-score').classList.add('hidden');
                 currentEditingTaskId = null;
            },

            saveScore: async () => {
                const newScore = parseInt(document.getElementById('edit-score-input').value, 10);
                if (isNaN(newScore)) return notify("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ", "error");

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', currentEditingTaskId), {
                        score: newScore
                    });
                    notify("–û—Ü–µ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞", "success");
                    app.closeEditScoreModal();
                    
                    await loadTeacherTasks(); // Reload underlying list
                } catch (e) {
                    console.error(e);
                    notify("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", "error");
                }
            },
            
            // New toggle functions
            toggleTaskAccordion: (groupId) => {
                const body = document.getElementById(`task-body-${groupId}`);
                const chevron = document.getElementById(`chevron-${groupId}`);
                const card = document.getElementById(`task-card-${groupId}`);

                if (body.style.maxHeight) {
                    // Collapse
                    body.style.maxHeight = null;
                    chevron.style.transform = 'rotate(0deg)';
                    card.classList.remove('shadow-xl'); 
                    card.classList.add('shadow-sm');
                } else {
                    // Expand
                    body.style.maxHeight = body.scrollHeight + "px";
                    chevron.style.transform = 'rotate(180deg)';
                    card.classList.remove('shadow-sm'); 
                    card.classList.add('shadow-xl');
                }
            },

            toggleStudentTaskAccordion: (taskId) => {
                const body = document.getElementById(`st-body-${taskId}`);
                const chevron = document.getElementById(`st-chevron-${taskId}`);
                const card = document.getElementById(`st-card-${taskId}`);

                if (body.style.maxHeight) {
                    body.style.maxHeight = null;
                    chevron.style.transform = 'rotate(0deg)';
                    card.classList.remove('shadow-xl');
                } else {
                    body.style.maxHeight = body.scrollHeight + "px";
                    chevron.style.transform = 'rotate(180deg)';
                    card.classList.add('shadow-xl');
                }
            },
            
            // === –õ–û–ì–ò–ö–ê –†–ï–ê–ö–¶–ò–ô ===
            openEmojiModal: (targetId, hasReaction) => {
                currentReactionTargetId = targetId;
                const btnDelete = document.getElementById('btn-delete-reaction');
                const hint = document.getElementById('reaction-hint');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∏—Ç–µ–ª—å –ª–∏ —ç—Ç–æ
                const isTeacher = !currentStudentId && auth.currentUser;
                
                if (isTeacher) {
                    hint.textContent = "–ù–∞–≥—Ä–∞–¥–∞ –æ—Ç —É—á–∏—Ç–µ–ª—è (1 –Ω–∞ —É—á–µ–Ω–∏–∫–∞)";
                } else {
                    hint.textContent = "–ú–∞–∫—Å–∏–º—É–º 2 –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Å";
                }
                
                if (hasReaction) {
                     btnDelete.classList.remove('hidden');
                } else {
                     btnDelete.classList.add('hidden');
                }
                document.getElementById('modal-emoji').classList.remove('hidden');
            },
            
            closeEmojiModal: () => {
                document.getElementById('modal-emoji').classList.add('hidden');
                currentReactionTargetId = null;
            },
            
            sendReaction: async (emoji) => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (—É—á–µ–Ω–∏–∫ –∏–ª–∏ —É—á–∏—Ç–µ–ª—å)
                let senderId = currentStudentId;
                let isTeacher = false;
                
                if (!senderId && auth.currentUser) {
                    senderId = auth.currentUser.uid;
                    isTeacher = true;
                }
                
                if (!senderId || !currentReactionTargetId) return;
                
                const reactionId = `${senderId}_${currentReactionTargetId}`;
                
                try {
                    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
                    const snap = await getDocs(getColPath('reactions'));
                    const myReactions = snap.docs
                        .map(d => d.data())
                        .filter(r => r.fromStudentId === senderId);
                        
                    // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–∞–∫—Ü–∏—é —ç—Ç–æ–º—É —á–µ–ª–æ–≤–µ–∫—É
                    const existingToTarget = myReactions.find(r => r.toStudentId === currentReactionTargetId);
                    
                    if (!isTeacher) {
                        // –î–ª—è —É—á–µ–Ω–∏–∫–æ–≤: –ª–∏–º–∏—Ç 2 –≤—Å–µ–≥–æ
                         if (!existingToTarget && myReactions.length >= 2) {
                            notify("–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º—É–º 2 —Ä–µ–∞–∫—Ü–∏–∏!", "error");
                            app.closeEmojiModal();
                            return;
                        }
                    } 
                    // –î–ª—è —É—á–∏—Ç–µ–ª–µ–π –ª–∏–º–∏—Ç –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é —ç—Ç–æ–º—É –∂–µ —É—á–µ–Ω–∏–∫—É (—á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞)

                    // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º/–û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reactions', reactionId), {
                        fromStudentId: senderId,
                        toStudentId: currentReactionTargetId,
                        emoji: emoji,
                        timestamp: Date.now(),
                        isTeacher: isTeacher // –§–ª–∞–≥ —É—á–∏—Ç–µ–ª—è
                    });
                    
                    notify("–†–µ–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!", "success");
                    app.closeEmojiModal();
                    
                    if (isTeacher) {
                        loadTeacherLeaderboard();
                    } else {
                        loadStudentLeaderboard(); 
                    }
                } catch (e) {
                    console.error(e);
                    notify("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏", "error");
                }
            },
            
            deleteReaction: async () => {
                let senderId = currentStudentId;
                let isTeacher = false;
                if (!senderId && auth.currentUser) {
                    senderId = auth.currentUser.uid;
                    isTeacher = true;
                }
                
                if (!senderId || !currentReactionTargetId) return;
                const reactionId = `${senderId}_${currentReactionTargetId}`;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reactions', reactionId));
                    notify("–†–µ–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞", "success");
                    app.closeEmojiModal();
                    
                    if (isTeacher) loadTeacherLeaderboard();
                    else loadStudentLeaderboard();
                } catch(e) {
                    notify("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "error");
                }
            },

            studentLogin: async () => {
                const phrase = document.getElementById('s-phrase').value.trim().toLowerCase();
                try {
                    const snap = await getDocs(getColPath('students'));
                    const student = snap.docs.find(d => d.data().phrase === phrase);
                    if (!student) return notify("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥", "error");
                    
                    localStorage.setItem('student_id', student.id);
                    currentStudentId = student.id;
                    currentStudentData = student.data();

                    document.getElementById('student-name-display').textContent = student.data().name;
                    document.getElementById('student-phrase-display').textContent = student.data().phrase;
                    window.app.showScreen('screen-student-dash');
                    loadStudentTasks();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },

            // === –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –ó–ê–î–ê–ù–ò–Ø ===
            submitTask: async (taskId, correct, deadlineSec) => {
                const val = document.getElementById(`input-${taskId}`).value.trim();
                if (!val) return notify("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç", "error");

                // –°—á–∏—Ç–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω—É
                const similarity = calculateSimilarity(val, correct);
                
                let score = 1;
                let message = "";

                if (similarity === 100) {
                    score = 5;
                    message = "–ò–¥–µ–∞–ª—å–Ω–æ! +5 –±–∞–ª–ª–æ–≤";
                } else if (similarity >= 75) {
                    score = 4;
                    message = "–•–æ—Ä–æ—à–æ! +4 –±–∞–ª–ª–∞";
                } else if (similarity >= 55) {
                    score = 3;
                    message = "–ù–µ–ø–ª–æ—Ö–æ. +3 –±–∞–ª–ª–∞";
                } else {
                    score = 1;
                    message = "–ü–æ–ø—ã—Ç–∫–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞. +1 –±–∞–ª–ª";
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (—á–∏—Å—Ç–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ü–µ–Ω–∫—É)
                const isLate = (Date.now() / 1000) > deadlineSec;

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), {
                        status: 'completed', 
                        studentAnswer: val, 
                        score: score, 
                        accuracy: similarity, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                        isLate: isLate,
                        completedAt: Date.now()
                    });
                    
                    notify(message, "success");
                    loadStudentTasks();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },
            // ============================================

            logout: async () => { 
                localStorage.removeItem('student_id');
                await signOut(auth); 
                window.location.reload(); 
            }
        };

        async function loadMyStudents() {
            if (!auth.currentUser) return;
            const [studentsSnap, tasksSnap] = await Promise.all([ getDocs(getColPath('students')), getDocs(getColPath('tasks')) ]);
            const tasks = tasksSnap.docs.map(d => d.data());
            const scores = {};
            tasks.forEach(t => { if(t.teacherId === auth.currentUser.uid) scores[t.studentId] = (scores[t.studentId] || 0) + (t.score || 0); });
            const list = document.getElementById('student-list');
            const checklist = document.getElementById('student-checklist');
            const myStudents = studentsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(s => s.teacherId === auth.currentUser.uid);
            
            let listHtml = '';
            let checklistHtml = '';
            myStudents.forEach(s => {
                const total = scores[s.id] || 0;
                listHtml += `
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 flex flex-col items-center text-center group relative">
                        <button onclick="app.deleteStudent('${s.id}')" class="absolute top-4 right-4 text-slate-200 hover:text-rose-500 transition-colors p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center text-xl font-black mb-4">${s.name[0]}</div>
                        <h4 class="font-black text-slate-800 truncate w-full px-4">${s.name}</h4>
                        <div class="bg-indigo-600 text-white px-4 py-1.5 rounded-full text-xs font-black shadow-lg shadow-indigo-100 mt-4">${total} –±.</div>
                    </div>`;
                checklistHtml += `
                    <label class="group flex items-center gap-4 p-5 bg-white rounded-2xl border-2 border-slate-50 cursor-pointer hover:border-indigo-400 transition-all">
                        <input type="checkbox" value="${s.id}" data-name="${s.name}" class="student-checkbox peer sr-only">
                        <div class="w-6 h-6 border-2 border-slate-200 rounded-lg peer-checked:bg-indigo-600 peer-checked:border-indigo-600 flex items-center justify-center transition-all">
                            <i data-lucide="check" class="w-4 h-4 text-white opacity-0 peer-checked:opacity-100"></i>
                        </div>
                        <span class="font-bold text-slate-700">${s.name}</span>
                    </label>`;
            });
            list.innerHTML = listHtml;
            checklist.innerHTML = checklistHtml;
            lucide.createIcons();
        }

        async function loadTeacherTasks() {
            if (!auth.currentUser) return;
            const [tasksSnap, draftsSnap] = await Promise.all([ getDocs(getColPath('tasks')), getDocs(getColPath('drafts')) ]);
            
            const container = document.getElementById('teacher-tasks-list');
            const allTasks = tasksSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.teacherId === auth.currentUser.uid);
            drafts = draftsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.teacherId === auth.currentUser.uid);

            const groupsMap = {};
            allTasks.forEach(t => {
                const gid = t.groupId || t.id;
                if (!groupsMap[gid]) groupsMap[gid] = { ...t, items: [] };
                groupsMap[gid].items.push(t);
            });
            groupedTasks = Object.values(groupsMap).sort((a, b) => b.createdAt - a.createdAt);
            
            if (groupedTasks.length === 0 && drafts.length === 0) {
                container.innerHTML = '<div class="col-span-full py-20 text-center text-slate-300 font-bold italic">–ü—É—Å—Ç–æ</div>';
                return;
            }

            let html = '';
            
            // Render Drafts first
            drafts.sort((a, b) => b.updatedAt - a.updatedAt).forEach(d => {
                html += `
                    <div class="task-card bg-slate-50 p-6 rounded-[2rem] border-2 border-dashed border-slate-200 cursor-pointer relative group" onclick="app.openNewTaskForm('${d.id}')">
                         <div class="absolute top-6 right-14 bg-slate-200 text-slate-500 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">–ß–µ—Ä–Ω–æ–≤–∏–∫</div>
                        <div class="flex justify-between items-start mb-4">
                             <div class="text-[10px] text-slate-400 font-black uppercase">–ò–∑–º–µ–Ω–µ–Ω: ${new Date(d.updatedAt).toLocaleDateString()}</div>
                            <button onclick="event.stopPropagation(); app.deleteDraft('${d.id}')" class="text-slate-300 hover:text-rose-500"><i data-lucide="trash" class="w-5 h-5"></i></button>
                        </div>
                        <h4 class="font-black text-slate-700 text-lg mb-4 line-clamp-2 opacity-70 group-hover:opacity-100 transition-opacity whitespace-pre-wrap">${d.question || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h4>
                        <div class="w-full flex justify-end">
                            <span class="text-xs font-bold text-indigo-500 flex items-center gap-1">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å <i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                        </div>
                    </div>`;
            });

            // Render Active Tasks (Accordion Style)
            groupedTasks.forEach(g => {
                const total = g.items.length;
                const done = g.items.filter(i => i.status === 'completed').length;
                const prc = Math.round((done / total) * 100);
                const isScheduled = g.publishAt && g.publishAt.toMillis() > Date.now();
                const publishDate = g.publishAt ? formatDate(g.publishAt.toDate()) : '–°—Ä–∞–∑—É';
                
                html += `
                    <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm transition-all duration-300 overflow-hidden" id="task-card-${g.groupId}">
                        <!-- Header (Clickable to toggle) -->
                        <div class="p-6 cursor-pointer" onclick="app.toggleTaskAccordion('${g.groupId}')">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="text-[10px] text-slate-400 font-black uppercase">–î–µ–¥–ª–∞–π–Ω: ${formatDate(g.deadline.toDate())}</div>
                                    ${isScheduled ? '<div class="bg-amber-50 text-amber-600 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">–ü–ª–∞–Ω</div>' : ''}
                                </div>
                                <button onclick="event.stopPropagation(); app.deleteTaskGroup('${g.groupId}')" class="text-slate-200 hover:text-rose-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            
                            <h4 class="font-black text-slate-800 text-lg mb-4 line-clamp-2 whitespace-pre-wrap">${g.question}</h4>
                            
                            <div class="flex items-center justify-between mt-2">
                                <div class="w-full h-1.5 bg-slate-50 rounded-full overflow-hidden mr-4 max-w-[150px]">
                                    <div class="h-full bg-indigo-500" style="width: ${prc}%"></div>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                                     <i id="chevron-${g.groupId}" data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Body (Hidden by default) -->
                        <div id="task-body-${g.groupId}" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-slate-50">
                             <div class="p-6 border-t border-slate-100">
                                <div class="grid grid-cols-1 gap-4 mb-6">
                                    <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100/50">
                                        <div class="text-[10px] font-black uppercase text-indigo-400 mb-1 tracking-widest">–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
                                        <div class="text-base font-black text-indigo-700">${g.correctAnswer}</div>
                                    </div>
                                    <div class="bg-white p-4 rounded-2xl border border-slate-100">
                                        <div class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest">–ü—É–±–ª–∏–∫–∞—Ü–∏—è</div>
                                        <div class="text-sm font-bold text-slate-600">${publishDate}</div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <div class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest ml-2">–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</div>
                                    ${g.items.map(item => `
                                        <div class="flex flex-col p-4 bg-white border border-slate-100 rounded-2xl shadow-sm">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="font-bold text-slate-800 text-sm">${item.studentName}</div>
                                                <div class="text-xs font-black ${item.status === 'completed' ? 'text-emerald-500' : 'text-slate-300'}">
                                                    ${item.status === 'completed' ? `
                                                        <div class="flex items-center gap-2">
                                                            <span>–°–¥–∞–Ω–æ (${item.score} –±.)</span>
                                                            <button onclick="event.stopPropagation(); app.editScore('${item.id}', ${item.score})" class="p-1.5 bg-slate-100 rounded-lg hover:bg-indigo-100 text-slate-400 hover:text-indigo-600 transition-colors" title="–ò–∑–º–µ–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É">
                                                                <i data-lucide="pencil" class="w-3 h-3"></i>
                                                            </button>
                                                        </div>
                                                    ` : '–û–∂–∏–¥–∞–µ—Ç'}
                                                </div>
                                            </div>
                                            ${item.status === 'completed' ? `
                                                <div class="text-sm bg-slate-50 p-3 rounded-xl text-slate-600 mb-2 border border-slate-100/50">
                                                    <span class="font-bold text-slate-400 text-xs uppercase mr-2">–û—Ç–≤–µ—Ç:</span> 
                                                    <span class="font-mono text-sm">${getDiffHTML(item.studentAnswer, g.correctAnswer)}</span>
                                                </div>
                                                ${item.accuracy !== undefined ? `<div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-right">–¢–æ—á–Ω–æ—Å—Ç—å: ${item.accuracy}%</div>` : ''}
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                             </div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
            lucide.createIcons();
        }

        async function loadStatistics() {
            if (!auth.currentUser) return;
            const [studentsSnap, tasksSnap] = await Promise.all([ getDocs(getColPath('students')), getDocs(getColPath('tasks')) ]);
            const students = studentsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(s => s.teacherId === auth.currentUser.uid);
            const tasks = tasksSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.teacherId === auth.currentUser.uid);
            const completedTasks = tasks.filter(t => t.status === 'completed').sort((a, b) => a.completedAt - b.completedAt);

            const totalScore = completedTasks.reduce((acc, t) => acc + (t.score || 0), 0);
            const avgScore = completedTasks.length ? (totalScore / completedTasks.length).toFixed(1) : 0;
            const completionRate = tasks.length ? Math.round((completedTasks.length / tasks.length) * 100) : 0;

            document.getElementById('quick-stats').innerHTML = `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2 tracking-widest">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</span>
                    <div class="text-3xl font-black text-slate-800">${avgScore}</div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2 tracking-widest">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
                    <div class="text-3xl font-black text-indigo-600">${completionRate}%</div>
                </div>
            `;

            const dates = [...new Set(completedTasks.map(t => new Date(t.completedAt).toLocaleDateString()))];
            
            const colors = ['#4f46e5', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'];
            
            const datasets = students.map((s, idx) => {
                let cumulative = 0;
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ª–∏–Ω–∏–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ —Å–ª–∏–ø–∞–ª–∏—Å—å
                // –ß–µ–º –±–æ–ª—å—à–µ —É—á–µ–Ω–∏–∫–æ–≤, —Ç–µ–º –±–æ–ª—å—à–µ —Ä–∞–∑–±—Ä–æ—Å, –Ω–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–∞–∑—É–º–Ω–æ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 0.8 —Å—É–º–º–∞—Ä–Ω–æ)
                const offset = idx * 0.1; 
                
                return {
                    label: s.name,
                    data: dates.map(date => {
                        const dayScore = completedTasks
                            .filter(t => t.studentId === s.id && new Date(t.completedAt).toLocaleDateString() === date)
                            .reduce((acc, c) => acc + (c.score || 0), 0);
                        cumulative += dayScore;
                        return cumulative + offset; // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥
                    }),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length],
                    tension: 0.4, 
                    fill: false, 
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                };
            });

            if (statsChart) statsChart.destroy();
            statsChart = new Chart(document.getElementById('statsChart'), {
                type: 'line',
                data: { labels: dates, datasets },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–ª (—É–±–∏—Ä–∞–µ–º –æ—Ñ—Ñ—Å–µ—Ç)
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += Math.floor(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#f8fafc' },
                            ticks: {
                                callback: function(value) { if (value % 1 === 0) { return value; } } // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–±–Ω—ã–µ —Ç–∏–∫–∏
                            }
                        }, 
                        x: { grid: { display: false } } 
                    } 
                }
            });

            document.getElementById('stats-summary').innerHTML = students.map(s => {
                const total = tasks.filter(t => t.studentId === s.id).reduce((acc, c) => acc + (c.score || 0), 0);
                return `
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                        <div class="font-black text-slate-800 truncate mb-1">${s.name}</div>
                        <div class="text-indigo-600 font-black text-xl">${total} –±–∞–ª–ª–æ–≤</div>
                    </div>`;
            }).join('');
        }

        async function loadTeacherLeaderboard() {
            if (!auth.currentUser) return;
            const teacherId = auth.currentUser.uid;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const [studentsSnap, tasksSnap, reactionsSnap] = await Promise.all([ 
                getDocs(getColPath('students')), 
                getDocs(getColPath('tasks')),
                getDocs(getColPath('reactions'))
            ]);

            const classmates = studentsSnap.docs
                .map(d => ({id: d.id, ...d.data()}))
                .filter(s => s.teacherId === teacherId);

            const allTasks = tasksSnap.docs
                .map(d => d.data())
                .filter(t => t.teacherId === teacherId);
                
            const allReactions = reactionsSnap.docs
                .map(d => d.data());

            // –°—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã
            const scores = {};
            classmates.forEach(s => scores[s.id] = 0);
            allTasks.forEach(t => { if (scores[t.studentId] !== undefined) scores[t.studentId] += (t.score || 0); });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º
            const leaderboard = classmates.map(s => ({
                id: s.id,
                name: s.name, 
                score: scores[s.id]
            })).sort((a, b) => b.score - a.score);

            const container = document.getElementById('teacher-rating-list');
            let html = `<div class="bg-white rounded-[2rem] border border-slate-100 p-2">`;
            
            leaderboard.forEach((user, index) => {
                const rank = index + 1;
                
                const receivedReactions = allReactions.filter(r => r.toStudentId === user.id);
                // –ò—â–µ–º —Ä–µ–∞–∫—Ü–∏—é –û–¢ –£–ß–ò–¢–ï–õ–Ø (–º–µ–Ω—è)
                const myReactionToHim = receivedReactions.find(r => r.fromStudentId === teacherId);
                
                let iconColor = 'bg-slate-100 text-slate-500';
                let iconContent = rank;
                if (rank === 1) { iconColor = 'bg-yellow-100 text-yellow-600'; iconContent = '<i data-lucide="trophy" class="w-4 h-4"></i>'; }
                if (rank === 2) { iconColor = 'bg-slate-200 text-slate-600'; iconContent = '2'; }
                if (rank === 3) { iconColor = 'bg-amber-100 text-amber-700'; iconContent = '3'; }

                html += `
                    <div class="flex items-center gap-4 p-4 rounded-2xl">
                        <div class="w-10 h-10 rounded-full ${iconColor} flex items-center justify-center font-black text-sm shrink-0">
                            ${iconContent}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="font-bold text-slate-700 text-lg truncate">${user.name}</div>
                            
                            <!-- Emojis Container -->
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${receivedReactions.map(r => {
                                    const style = r.isTeacher 
                                        ? 'bg-amber-100 border-2 border-amber-300 ring-2 ring-amber-100/50 scale-110 z-10 shadow-sm' 
                                        : '';
                                    return `<span class="emoji-pop text-sm cursor-help relative rounded-full ${style}" title="${r.isTeacher ? '–û—Ç —É—á–∏—Ç–µ–ª—è' : '–ê–Ω–æ–Ω–∏–º–Ω–æ'}">${r.emoji}</span>`;
                                }).join('')}
                                
                                <button onclick="app.openEmojiModal('${user.id}', ${!!myReactionToHim})" class="ml-1 w-6 h-6 rounded-full bg-slate-100 hover:bg-indigo-100 text-slate-400 hover:text-indigo-500 flex items-center justify-center transition-all ${myReactionToHim ? 'bg-indigo-100 text-indigo-600 ring-2 ring-indigo-200' : ''}">
                                    <i data-lucide="${myReactionToHim ? 'pencil' : 'smile-plus'}" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                        <div class="font-black text-xl text-slate-800">${user.score}</div>
                    </div>
                    ${index < leaderboard.length - 1 ? '<div class="h-px bg-slate-50 mx-4"></div>' : ''}
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        }

        async function loadStudentLeaderboard() {
            if (!currentStudentData || !currentStudentId) return;

            // 1. –ü–æ–ª—É—á–∞–µ–º ID —É—á–∏—Ç–µ–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
            const teacherId = currentStudentData.teacherId;

            // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const [studentsSnap, tasksSnap, reactionsSnap] = await Promise.all([ 
                getDocs(getColPath('students')), 
                getDocs(getColPath('tasks')),
                getDocs(getColPath('reactions'))
            ]);

            const classmates = studentsSnap.docs
                .map(d => ({id: d.id, ...d.data()}))
                .filter(s => s.teacherId === teacherId);

            const allTasks = tasksSnap.docs
                .map(d => d.data())
                .filter(t => t.teacherId === teacherId);
                
            const allReactions = reactionsSnap.docs
                .map(d => d.data());

            // 3. –°—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã
            const scores = {};
            classmates.forEach(s => scores[s.id] = 0);
            
            allTasks.forEach(t => {
                if (scores[t.studentId] !== undefined) {
                    scores[t.studentId] += (t.score || 0);
                }
            });

            // 4. –°–æ—Ä—Ç–∏—Ä—É–µ–º (–ø–æ —É–±—ã–≤–∞–Ω–∏—é –±–∞–ª–ª–æ–≤)
            const leaderboard = classmates.map(s => ({
                id: s.id,
                name: s.id === currentStudentId ? "–í—ã" : "–£—á–µ–Ω–∏–∫", 
                realName: s.name, 
                score: scores[s.id]
            })).sort((a, b) => b.score - a.score);

            // 5. –†–µ–Ω–¥–µ—Ä–∏–º
            const container = document.getElementById('student-rating-list');
            const myRankIndex = leaderboard.findIndex(x => x.id === currentStudentId);
            const myData = leaderboard[myRankIndex];

            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ —Å–≤–µ—Ä—Ö—É
            const nextTarget = leaderboard[myRankIndex - 1];
            const randomPhrase = ["–¢—ã —É–∂–µ –±–ª–∏–∑–∫–æ, –ø–æ–¥–Ω–∞–∂–º–∏! üöÄ", "–í–ø–µ—Ä–µ–¥ –∫ –≤–µ—Ä—à–∏–Ω–µ! üèîÔ∏è", "–ï—â–µ –Ω–µ–º–Ω–æ–≥–æ —É—Å–∏–ª–∏–π! üí™"][Math.floor(Math.random()*3)];

            let html = '';

            // –ö–∞—Ä—Ç–æ—á–∫–∞ "–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
            html += `
                <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 text-white p-8 rounded-[2.5rem] shadow-xl shadow-indigo-200 mb-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-10 transform translate-x-10 -translate-y-10">
                        <i data-lucide="trophy" class="w-48 h-48"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="text-indigo-200 font-bold text-sm uppercase tracking-widest mb-2">–í–∞—à–µ –º–µ—Å—Ç–æ</div>
                        <div class="flex items-baseline gap-2 mb-6">
                            <span class="text-6xl font-black">${myRankIndex + 1}</span>
                            <span class="text-xl font-medium opacity-60">–∏–∑ ${leaderboard.length}</span>
                        </div>
                         ${nextTarget ? `
                            <div class="bg-white/10 backdrop-blur-md p-4 rounded-2xl border border-white/20 flex flex-col gap-2">
                                <span class="text-sm font-medium">–î–æ ${myRankIndex}-–≥–æ –º–µ—Å—Ç–∞: <strong>${nextTarget.score - myData.score + 1} –±–∞–ª–ª–æ–≤</strong></span>
                            </div>` : ''}
                    </div>
                </div>
            `;

            // –°–ø–∏—Å–æ–∫ –ª–∏–¥–µ—Ä–æ–≤
            html += `<div class="bg-white rounded-[2rem] border border-slate-100 p-2">`;
            
            leaderboard.forEach((user, index) => {
                const rank = index + 1;
                const isMe = user.id === currentStudentId;
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–∞–∫—Ü–∏–∏ –î–õ–Ø —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
                const receivedReactions = allReactions.filter(r => r.toStudentId === user.id);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—Ç–∞–≤–∏–ª –ª–∏ –Ø —Ä–µ–∞–∫—Ü–∏—é —ç—Ç–æ–º—É —é–∑–µ—Ä—É
                const myReactionToHim = receivedReactions.find(r => r.fromStudentId === currentStudentId);
                
                let iconColor = 'bg-slate-100 text-slate-500';
                let iconContent = rank;
                if (rank === 1) { iconColor = 'bg-yellow-100 text-yellow-600'; iconContent = '<i data-lucide="trophy" class="w-4 h-4"></i>'; }
                if (rank === 2) { iconColor = 'bg-slate-200 text-slate-600'; iconContent = '2'; }
                if (rank === 3) { iconColor = 'bg-amber-100 text-amber-700'; iconContent = '3'; }

                html += `
                    <div class="flex items-center gap-4 p-4 rounded-2xl ${isMe ? 'bg-indigo-50 border border-indigo-100' : ''}">
                        <div class="w-10 h-10 rounded-full ${iconColor} flex items-center justify-center font-black text-sm shrink-0">
                            ${iconContent}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="font-bold ${isMe ? 'text-indigo-700' : 'text-slate-700'} text-lg truncate">
                                ${user.name} ${isMe ? '(–í—ã)' : ''}
                            </div>
                            
                            <!-- Emojis Container -->
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${receivedReactions.map(r => {
                                    // –°—Ç–∏–ª—å –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π —É—á–∏—Ç–µ–ª—è
                                    const style = r.isTeacher 
                                        ? 'bg-amber-100 border-2 border-amber-300 ring-2 ring-amber-100/50 scale-110 z-10 shadow-sm' 
                                        : '';
                                    return `<span class="emoji-pop text-sm cursor-help relative rounded-full ${style}" title="${r.isTeacher ? '–û—Ç —É—á–∏—Ç–µ–ª—è' : '–ê–Ω–æ–Ω–∏–º–Ω–æ'}">${r.emoji}</span>`;
                                }).join('')}
                                
                                ${!isMe ? `
                                    <button onclick="app.openEmojiModal('${user.id}', ${!!myReactionToHim})" class="ml-1 w-6 h-6 rounded-full bg-slate-100 hover:bg-indigo-100 text-slate-400 hover:text-indigo-500 flex items-center justify-center transition-all ${myReactionToHim ? 'bg-indigo-100 text-indigo-600 ring-2 ring-indigo-200' : ''}">
                                        <i data-lucide="${myReactionToHim ? 'pencil' : 'smile-plus'}" class="w-3 h-3"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="font-black text-xl ${isMe ? 'text-indigo-600' : 'text-slate-800'}">${user.score}</div>
                    </div>
                    ${index < leaderboard.length - 1 ? '<div class="h-px bg-slate-50 mx-4"></div>' : ''}
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.email) {
                    // –£—á–∏—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } else {
                    // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥ (–≤–æ–∑–º–æ–∂–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç)
                    const sid = localStorage.getItem('student_id');
                    if (sid) {
                        try {
                            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sid));
                            if (snap.exists()) {
                                currentStudentId = sid;
                                currentStudentData = snap.data();

                                document.getElementById('student-name-display').textContent = currentStudentData.name;
                                document.getElementById('student-phrase-display').textContent = currentStudentData.phrase;
                                window.app.showScreen('screen-student-dash');
                                loadStudentTasks();
                            }
                        } catch(e) { console.error("Auto-login error", e); }
                    }
                }
            } else {
                // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç, –≤—Ö–æ–¥–∏–º –∞–Ω–æ–Ω–∏–º–Ω–æ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ
                signInAnonymously(auth).catch(() => {});
            }
        });
        
        lucide.createIcons();
    </script>
</body>
</html>