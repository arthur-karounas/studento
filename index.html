<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta name="apple-mobile-web-app-capable" content="yes">

    <title>With Lera</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

        /* –í–µ—Å—å "–∑–∞–¥–Ω–∏–∫" –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ ‚Äî —á–∏—Å—Ç–æ –±–µ–ª—ã–µ */
html {
    background-color: #ffffff !important;
}

body {
    background-color: #ffffff !important;
    /* –£–±–∏—Ä–∞–µ–º padding-top –æ—Ç—Å—é–¥–∞, —á—Ç–æ–±—ã —Ö–µ–¥–µ—Ä –º–æ–≥ –ø–æ–¥–Ω—è—Ç—å—Å—è –∫ —Å–∞–º–æ–º—É –≤–µ—Ä—Ö—É */
    padding-top: 0 !important; 
}

/* –ú–æ–±–∏–ª—å–Ω—ã–π —Ö–µ–¥–µ—Ä: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ, –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –±–µ–ª—ã–π –ø–æ–¥—Ç–æ–Ω */
.mobile-header-glass {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –æ–Ω–∞ –≤–∫–ª—é—á–∞–ª–∞ safe-area + –≤—ã—Å–æ—Ç—É —Å–∞–º–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
    height: calc(4rem + env(safe-area-inset-top)) !important;
    background-color: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    z-index: 40;
    
    /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç, –Ω–æ —Å —É—á–µ—Ç–æ–º –æ—Ç—Å—Ç—É–ø–∞ –ø–æ–¥ –æ—Å—Ç—Ä–æ–≤–æ–∫ */
    display: flex;
    align-items: flex-end; /* –ü—Ä–∏–∂–∏–º–∞–µ–º —Ç–µ–∫—Å—Ç –∫ –Ω–∏–∑—É —Ö–µ–¥–µ—Ä–∞ */
    padding-bottom: 1rem;  /* –î–µ–ª–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    justify-content: center;
}
        body { font-family: 'Inter', sans-serif; }
        body.modal-open { overflow: hidden; }
        .hidden { display: none !important; }
        
        /* –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
        .active-tab { background: #4f46e5; color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2); }
        
        /* –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ (–Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é) */
        .mobile-active-tab { color: #4f46e5 !important; }
        .mobile-active-tab i { transform: translateY(-4px); transition: transform 0.2s ease; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        .task-card:hover { transform: translateY(-2px); transition: all 0.2s ease; }
        
        .step-node.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        .step-node.completed { background: #10b981; color: white; border-color: #10b981; }

        /* –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ Layout (–ü–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º) */
        @media (orientation: portrait), (max-width: 768px) {
            .desktop-sidebar { display: none !important; }
            .mobile-nav { display: flex !important; }
            /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º padding-top, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∑–∞–µ–∑–∂–∞–ª –ø–æ–¥ –≤–µ—Ä—Ö–Ω–∏–π —Ö–µ–¥–µ—Ä */
            .main-content { 
                padding-top: calc(5rem + env(safe-area-inset-top)) !important; 
        padding-bottom: 7rem !important;
                padding-left: 1rem !important; 
                padding-right: 1rem !important; 
            }
            .screen-header { text-align: center; }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Ç–µ–ø–µ—Ä—å —Å–≤–µ—Ä—Ö—É */
            .screen-header h2 { display: none; }
            .screen-header p { display: none; }
            
            /* –£–±–∏—Ä–∞–µ–º "–≤–∏–¥–∂–µ—Ç–Ω–æ—Å—Ç—å" –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è –ª–æ–≥–∏–Ω–∞ */
            .login-card { 
                background: transparent !important; 
                box-shadow: none !important; 
                border: none !important; 
                padding-left: 1.5rem !important; 
                padding-right: 1.5rem !important;
            }
        }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-900 min-h-screen font-medium">

    <div id="notification-container" class="fixed top-20 right-4 md:top-6 md:right-6 z-[200] flex flex-col gap-3 w-[calc(100%-2rem)] md:w-auto"></div>

    <!-- MODAL: CONFIRM -->
    <div id="modal-confirm" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mb-6">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-extrabold text-slate-800 mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h3>
                <p id="confirm-message" class="text-slate-500 mb-8 text-sm">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                <div class="flex gap-3 w-full">
                    <button id="confirm-cancel" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-all">–û—Ç–º–µ–Ω–∞</button>
                    <button id="confirm-ok" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-bold hover:bg-rose-600 transition-all shadow-lg shadow-rose-200">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: TASK DETAILS -->
    <div id="modal-task-details" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-md" onclick="app.closeTaskDetails()"></div>
        <div class="relative bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <button onclick="app.closeTaskDetails()" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 transition-colors z-10 bg-white rounded-full border shadow-sm">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div id="modal-content" class="overflow-y-auto p-6 md:p-10"></div>
        </div>
    </div>

    <!-- MAIN SCREEN -->
    <div id="screen-main" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="max-w-md w-full text-center space-y-10 animate-slide-up">
            <div class="flex justify-center">
                <div class="relative">
                    <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 animate-pulse"></div>
                    <div class="relative bg-indigo-600 p-6 rounded-[2rem] shadow-2xl">
                        <i data-lucide="graduation-cap" class="text-white w-14 h-14"></i>
                    </div>
                </div>
            </div>
            <div>
                <h1 class="text-5xl font-black tracking-tight text-slate-900 mb-4">With Lera</h1>
                <p class="text-slate-500 text-lg leading-relaxed px-4">–£–¥–æ–±–Ω–∞—è –∏ –ø—Ä–æ—Å—Ç–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è!</p>
            </div>
            <div class="space-y-4 px-2">
                <button onclick="app.showScreen('screen-student-login')" class="w-full py-5 rounded-2xl bg-indigo-600 text-white text-lg font-bold hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100 flex items-center justify-center gap-3 group">
                    –£—á–µ–Ω–∏–∫
                </button>
                <button onclick="app.showScreen('screen-teacher-login')" class="w-full py-5 rounded-2xl bg-white border-2 border-slate-100 text-slate-700 text-lg font-bold hover:border-indigo-400 transition-all">
                    –£—á–∏—Ç–µ–ª—å
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREENS -->
    <div id="screen-teacher-login" class="screen hidden min-h-screen flex items-center justify-center p-0 md:p-6 bg-white md:bg-[#FFFFFF]">
        <div class="login-card max-w-sm w-full bg-white rounded-[2.5rem] p-8 md:p-10 md:shadow-2xl md:border md:border-slate-50 animate-slide-up text-center">
            <button onclick="app.showScreen('screen-main')" class="text-slate-400 hover:text-indigo-600 mb-10 flex items-center justify-center gap-2 text-sm font-extrabold transition-colors mx-auto">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
            </button>
            <div class="mb-10">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="graduation-cap" class="w-10 h-10"></i>
                </div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">–£—á–∏—Ç–µ–ª—å</h2>
            </div>
            <div class="space-y-4">
                <input type="email" id="t-email" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-center placeholder:text-slate-300" placeholder="Email">
                <input type="password" id="t-password" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-center placeholder:text-slate-300" placeholder="–ü–∞—Ä–æ–ª—å">
                <div class="pt-4 space-y-3">
                    <button onclick="app.teacherLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-[0.98]">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
                    <button onclick="app.teacherRegister()" class="w-full py-4 text-indigo-600 font-bold hover:bg-indigo-50 rounded-2xl transition-all">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-student-login" class="screen hidden min-h-screen flex items-center justify-center p-0 md:p-6 bg-white md:bg-[#FFFFFF]">
        <div class="login-card max-w-sm w-full bg-white rounded-[2.5rem] p-8 md:p-10 md:shadow-2xl md:border md:border-slate-50 animate-slide-up text-center">
            <button onclick="app.showScreen('screen-main')" class="text-slate-400 hover:text-indigo-600 mb-10 flex items-center justify-center gap-2 text-sm font-extrabold transition-colors mx-auto">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> –ù–∞–∑–∞–¥
            </button>
            <div class="mb-10">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i data-lucide="key-round" class="w-10 h-10"></i>
                </div>
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">–ü—Ä–∏–≤–µ—Ç!</h2>
                <p class="text-slate-400 mt-2 font-semibold leading-relaxed">–í–≤–µ–¥–∏ —Å–≤–æ–∏ —Ç—Ä–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            <div class="space-y-6">
                <input type="text" id="s-phrase" class="w-full px-6 py-6 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white text-center font-black text-xl outline-none transition-all placeholder:font-bold placeholder:text-slate-200" placeholder="—Å–ª–æ–≤–æ —Å–ª–æ–≤–æ —Å–ª–æ–≤–æ">
                <button onclick="app.studentLogin()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-[0.98]">–í–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç</button>
            </div>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="screen-teacher-dash" class="screen hidden min-h-screen md:h-screen md:overflow-hidden flex flex-col md:flex-row relative">
        
        <!-- MOBILE TOP HEADER (Fixed) -->
        <header class="md:hidden mobile-header-glass border-b border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.02)]">
    <h1 id="mobile-header-title" class="font-black text-2xl text-slate-800">–ö–ª–∞—Å—Å</h1>
</header>

        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar w-80 bg-white border-r border-slate-100 p-8 flex flex-col shrink-0 overflow-y-auto">
            <div class="flex items-center gap-3 mb-12 px-2 font-black text-2xl text-indigo-600 italic">
                <div class="bg-indigo-600 p-2 rounded-lg text-white not-italic shadow-lg shadow-indigo-100">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                </div>
                With Lera
            </div>
            <nav class="flex-grow space-y-3">
                <button onclick="app.setTeacherTab('students')" id="tab-btn-students" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 active-tab">
                    <i data-lucide="users" class="w-5 h-5"></i> –ö–ª–∞—Å—Å
                </button>
                <button onclick="app.setTeacherTab('tasks')" id="tab-btn-tasks" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i> –ó–∞–¥–∞–Ω–∏—è
                </button>
                <button onclick="app.setTeacherTab('stats')" id="tab-btn-stats" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all font-bold text-slate-400 hover:bg-slate-50">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </button>
            </nav>
            <button onclick="app.logout()" class="mt-auto flex items-center gap-4 px-6 py-4 rounded-2xl text-rose-500 font-bold hover:bg-rose-50 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i> –í—ã–π—Ç–∏
            </button>
        </aside>

        <!-- Mobile Bottom Nav -->
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-50 flex flex-row justify-around items-center p-2 pb-6 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <button onclick="app.setTeacherTab('students')" id="mob-tab-students" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px] mobile-active-tab">
                <i data-lucide="users" class="w-6 h-6"></i> –ö–ª–∞—Å—Å
            </button>
            <button onclick="app.setTeacherTab('tasks')" id="mob-tab-tasks" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="clipboard-list" class="w-6 h-6"></i> –ó–∞–¥–∞–Ω–∏—è
            </button>
            <button onclick="app.setTeacherTab('stats')" id="mob-tab-stats" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]">
                <i data-lucide="bar-chart-2" class="w-6 h-6"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            </button>
            <button onclick="app.logout()" class="flex flex-col items-center gap-1 p-3 text-rose-400 font-black text-[10px]">
                <i data-lucide="log-out" class="w-6 h-6"></i> –í—ã—Ö–æ–¥
            </button>
        </nav>

        <main class="main-content flex-grow p-6 md:p-12 overflow-y-auto bg-[#F8FAFC]">
            <!-- TAB: STUDENTS -->
            <section id="tab-students" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 md:mb-10 screen-header">
                    <h2 class="text-3xl md:text-4xl font-black text-slate-800">–ö–ª–∞—Å—Å</h2>
                    <button onclick="app.toggleAddStudentForm()" class="w-full md:w-auto bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                        <i data-lucide="user-plus" class="w-5 h-5"></i> –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞
                    </button>
                </div>
                <div id="add-student-form" class="hidden mb-10 bg-white p-6 md:p-8 rounded-[2rem] border-2 border-indigo-100 shadow-sm">
                    <h3 class="font-black text-xl mb-6">–ù–æ–≤—ã–π —É—á–µ–Ω–∏–∫</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="new-name" class="px-6 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-indigo-400 outline-none font-bold" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
                        <input type="text" id="new-phrase" class="px-6 py-4 rounded-xl bg-slate-50 border-2 border-transparent focus:border-indigo-400 outline-none font-bold" placeholder="3 —Å–ª–æ–≤–∞ –ø–∞—Ä–æ–ª—è">
                        <button onclick="app.createStudent()" class="py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div id="student-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- TAB: TASKS -->
            <section id="tab-tasks" class="hidden">
                <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-0 mb-6 md:mb-10 screen-header">
                    <div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800">–ó–∞–¥–∞–Ω–∏—è</h2>
                        <p class="text-slate-500 mt-1 font-medium">–†–∞—Å—Å—ã–ª–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</p>
                    </div>
                    <button onclick="app.openNewTaskForm()" class="bg-indigo-600 text-white px-8 py-5 rounded-2xl font-black flex items-center justify-center gap-3 hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100">
                        <i data-lucide="plus-circle" class="w-6 h-6"></i> –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
                    </button>
                </div>
                <div id="task-creation-wizard" class="hidden mb-12">
                    <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
                        <div class="bg-slate-900 px-6 py-5 md:px-10 md:py-6 flex justify-between items-center">
                            <h3 class="text-white font-bold">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è</h3>
                            <button onclick="app.closeNewTaskForm()" class="text-slate-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="p-6 md:p-10">
                            <div class="flex items-center justify-between mb-10 max-w-md mx-auto relative">
                                <div class="absolute h-1 bg-slate-100 top-1/2 left-0 right-0 -translate-y-1/2 z-0"></div>
                                <div id="step-line-1" class="absolute h-1 bg-indigo-500 top-1/2 left-0 w-0 -translate-y-1/2 z-0 transition-all duration-500"></div>
                                <div class="step-node active relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-1">1</div>
                                <div class="step-node relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-2">2</div>
                                <div class="step-node relative z-10 w-10 h-10 rounded-full border-4 border-white bg-slate-100 flex items-center justify-center font-black shadow-md" id="node-3">3</div>
                            </div>
                            <div id="wizard-step-1" class="space-y-6 max-w-xl mx-auto">
                                <textarea id="task-text" rows="4" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white outline-none font-medium text-lg resize-none" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"></textarea>
                                <input type="text" id="task-answer" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 focus:bg-white outline-none font-bold" placeholder="–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç">
                                <button onclick="app.nextWizardStep(2)" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">–î–∞–ª–µ–µ</button>
                            </div>
                            <div id="wizard-step-2" class="hidden space-y-6 max-w-2xl mx-auto">
                                <div id="student-checklist" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-1"></div>
                                <div class="flex gap-3">
                                    <button onclick="app.nextWizardStep(1)" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold">–ù–∞–∑–∞–¥</button>
                                    <button onclick="app.nextWizardStep(3)" class="flex-[2] py-5 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">–î–∞–ª–µ–µ</button>
                                </div>
                            </div>
                            <div id="wizard-step-3" class="hidden space-y-8 max-w-xl mx-auto">
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                                        <div class="relative">
                                            <input type="text" onfocus="(this.type='datetime-local')" onblur="if(!this.value)this.type='text'" id="task-publish-date" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 font-bold text-slate-700" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è">
                                            <div class="text-xs text-slate-400 mt-2 ml-2">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-400 mb-2 ml-2 uppercase tracking-wide">–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                                        <input type="text" onfocus="(this.type='datetime-local')" onblur="if(!this.value)this.type='text'" id="task-deadline" class="w-full px-6 py-5 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 font-bold text-slate-700" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è">
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button onclick="app.nextWizardStep(2)" class="flex-1 py-5 bg-slate-100 text-slate-600 rounded-2xl font-bold">–ù–∞–∑–∞–¥</button>
                                    <button onclick="app.assignTask()" class="flex-[2] py-5 bg-emerald-500 text-white rounded-2xl font-black shadow-xl">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="teacher-tasks-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            </section>

            <!-- TAB: STATS -->
            <section id="tab-stats" class="hidden">
                <div class="hidden md:flex flex-col md:flex-row justify-between items-center gap-4 md:mb-10 screen-header">
                    <div>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-800">–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h2>
                        <p class="text-slate-500 mt-1 font-medium">–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–ª–∞—Å—Å–∞</p>
                    </div>
                </div>
                <div id="quick-stats" class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-10"></div>
                <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 shadow-sm border border-slate-100">
                    <div class="h-[300px] md:h-[450px] mb-12"><canvas id="statsChart"></canvas></div>
                    <div class="border-t border-slate-50 pt-10">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6 ml-2">–†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤</h3>
                        <div id="stats-summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="screen-student-dash" class="screen hidden min-h-screen md:h-screen md:overflow-hidden flex flex-col md:flex-row">
        
        <!-- MOBILE TOP HEADER (Fixed) -->
        <header class="md:hidden mobile-header-glass border-b border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.02)]">
    <h1 id="mobile-header-title" class="font-black text-2xl text-slate-800">–ú–æ–∏ —É—Ä–æ–∫–∏</h1>
</header>

        <aside class="desktop-sidebar w-80 bg-white border-r border-slate-100 p-8 flex flex-col shrink-0 overflow-y-auto">
            <div class="flex items-center gap-3 mb-12 font-black text-2xl uppercase tracking-widest text-amber-600 italic"><i data-lucide="backpack"></i> With Lera</div>
            <nav class="flex-grow">
                <div class="student-active-tab px-6 py-4 rounded-2xl font-black flex items-center gap-4 shadow-sm"><i data-lucide="book-open"></i> –ú–æ–∏ —É—Ä–æ–∫–∏</div>
            </nav>
            <div class="mt-auto pt-8 border-t border-slate-50">
                <div class="bg-amber-50 rounded-[2rem] p-6 mb-8 border border-amber-100">
                    <p id="student-name-display" class="font-black text-slate-900 truncate text-lg">...</p>
                    <p id="student-phrase-display" class="text-xs text-amber-700 opacity-60 font-mono mb-4"></p>
                    <div class="bg-white px-5 py-3 rounded-2xl flex justify-between items-center shadow-sm">
                        <span id="student-total-score" class="font-black text-amber-700 text-2xl">0</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl text-slate-400 font-bold">–í—ã–π—Ç–∏</button>
            </div>
        </aside>
        <nav class="mobile-nav hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 z-50 flex flex-row justify-around items-center p-2 pb-6 shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
            <div class="flex flex-col items-center gap-1 p-3 text-amber-500 font-black text-[10px]"><i data-lucide="book-open"></i> –£—Ä–æ–∫–∏</div>
            <div class="flex flex-col items-center gap-1 p-3 text-slate-700 font-black text-[10px]"><span id="mob-student-score" class="text-lg">0</span> –±–∞–ª–ª–æ–≤</div>
            <button onclick="app.logout()" class="flex flex-col items-center gap-1 p-3 text-slate-400 font-black text-[10px]"><i data-lucide="log-out"></i> –í—ã—Ö–æ–¥</button>
        </nav>
        <main class="main-content flex-grow p-6 md:p-12 overflow-y-auto bg-[#F8FAFC]">
            <h2 class="text-3xl md:text-4xl font-black mb-8 text-slate-800 md:block hidden">–£—Ä–æ–∫–∏</h2>
            <div id="student-tasks-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyA_mptcpENpEsrJYHXBRxb-rlRH_eqI8-E","authDomain":"studento-aa5d2.firebaseapp.com","projectId":"studento-aa5d2","storageBucket":"studento-aa5d2.firebasestorage.app","messagingSenderId":"1078257307837","appId":"1:1078257307837:web:9ea84484c1dfdb129ca7d4"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-edu-v4';
        
        const appFb = initializeApp(firebaseConfig);
        const auth = getAuth(appFb);
        const db = getFirestore(appFb);

        let currentStudentId = null;
        let groupedTasks = []; 
        let statsChart = null; 

        const formatDate = (inputDate) => {
            if (!inputDate) return "";
            const d = new Date(inputDate);
            return d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };

        const notify = (text, type = 'info') => {
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = `${type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'} text-white px-6 py-4 rounded-2xl shadow-2xl animate-slide-up mb-2 flex items-center gap-3 font-bold`;
            el.innerHTML = `<span class="text-sm">${text}</span>`;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 400); }, 3000);
        };

        const getColPath = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

        let activeTeacherTab = 'students';

        window.app = {
            showScreen: (id) => {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                document.getElementById('screen-main').classList.add('hidden');
                document.getElementById(id).classList.remove('hidden');
                lucide.createIcons();
            },

            askConfirm: (message) => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal-confirm');
                    document.getElementById('confirm-message').textContent = message;
                    modal.classList.remove('hidden');
                    document.body.classList.add('modal-open');
                    document.getElementById('confirm-ok').onclick = () => { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); resolve(true); };
                    document.getElementById('confirm-cancel').onclick = () => { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); resolve(false); };
                });
            },



            setTeacherTab: (tab) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∂–∏–º–∞–µ–º –ª–∏ –º—ã –Ω–∞ —Ç—É –∂–µ —Å–∞–º—É—é –≤–∫–ª–∞–¥–∫—É
    if (activeTeacherTab === tab && !document.getElementById(`tab-${tab}`).classList.contains('hidden')) {
        return; // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º
    }

    const tabs = ['students', 'tasks', 'stats'];
    const titles = {
        students: '–ö–ª–∞—Å—Å',
        tasks: '–ó–∞–¥–∞–Ω–∏—è',
        stats: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞'
    };
    
    const mobileTitle = document.getElementById('mobile-header-title');
    if (mobileTitle) mobileTitle.textContent = titles[tab];

    tabs.forEach(t => {
        const el = document.getElementById(`tab-${t}`);
        const isVisible = t === tab;
        
        if (isVisible) {
            el.classList.remove('hidden');
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ–±–∞–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Ä–µ–∞–ª—å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ –≤–∫–ª–∞–¥–∫—É
            el.classList.remove('animate-slide-up');
            void el.offsetWidth; // –ú–∞–≥–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ (Reflow)
            el.classList.add('animate-slide-up');
        } else {
            el.classList.add('hidden');
        }
        
        document.getElementById(`tab-btn-${t}`).classList.toggle('active-tab', isVisible);
        document.getElementById(`mob-tab-${t}`).classList.toggle('mobile-active-tab', isVisible);
    });
    
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
    activeTeacherTab = tab;

    if(tab === 'students') loadMyStudents();
    if(tab === 'tasks') loadTeacherTasks();
    if(tab === 'stats') loadStatistics();
    lucide.createIcons();
},

            toggleAddStudentForm: () => document.getElementById('add-student-form').classList.toggle('hidden'),

            openNewTaskForm: () => {
                document.getElementById('task-creation-wizard').classList.remove('hidden');
                app.nextWizardStep(1);
            },
            closeNewTaskForm: () => document.getElementById('task-creation-wizard').classList.add('hidden'),
            
            nextWizardStep: (step) => {
                [1, 2, 3].forEach(s => {
                    document.getElementById(`wizard-step-${s}`).classList.toggle('hidden', s !== step);
                    const node = document.getElementById(`node-${s}`);
                    node.classList.toggle('active', s === step);
                    node.classList.toggle('completed', s < step);
                });
                document.getElementById('step-line-1').style.width = step === 1 ? '0%' : step === 2 ? '50%' : '100%';
            },

            teacherLogin: async () => {
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-password').value);
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } catch (e) { notify("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞", "error"); }
            },

            teacherRegister: async () => {
                try {
                    await createUserWithEmailAndPassword(auth, document.getElementById('t-email').value, document.getElementById('t-password').value);
                    window.app.showScreen('screen-teacher-dash');
                    window.app.setTeacherTab('students');
                } catch (e) { notify("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏", "error"); }
            },

            createStudent: async () => {
                const name = document.getElementById('new-name').value;
                const phrase = document.getElementById('new-phrase').value.trim().toLowerCase();
                if (!name || phrase.split(/\s+/).length !== 3) return notify("–ù—É–∂–Ω–æ –∏–º—è –∏ 3 —Å–ª–æ–≤–∞", "error");
                try {
                    await addDoc(getColPath('students'), { teacherId: auth.currentUser.uid, name, phrase, createdAt: Date.now() });
                    document.getElementById('new-name').value = ''; document.getElementById('new-phrase').value = '';
                    notify("–ì–æ—Ç–æ–≤–æ", "success");
                    loadMyStudents();
                    app.toggleAddStudentForm();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },

            deleteStudent: async (sid) => {
                if(await app.askConfirm("–£–¥–∞–ª–∏—Ç—å?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', sid));
                    loadMyStudents();
                }
            },

            assignTask: async () => {
                const text = document.getElementById('task-text').value;
                const answer = document.getElementById('task-answer').value.trim().toLowerCase();
                const deadlineVal = document.getElementById('task-deadline').value;
                const publishVal = document.getElementById('task-publish-date').value;
                const checked = document.querySelectorAll('.student-checkbox:checked');
                
                if (!text || !answer || !deadlineVal || checked.length === 0) return notify("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë", "error");
                
                const groupId = Date.now().toString();
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø—É–±–ª–∏–∫—É–µ–º —Å–µ–π—á–∞—Å
                const publishAt = publishVal ? Timestamp.fromDate(new Date(publishVal)) : Timestamp.now();
                const deadline = Timestamp.fromDate(new Date(deadlineVal));

                try {
                    const promises = Array.from(checked).map(cb => {
                        return addDoc(getColPath('tasks'), {
                            groupId, teacherId: auth.currentUser.uid, studentId: cb.value, studentName: cb.dataset.name,
                            question: text, correctAnswer: answer, 
                            deadline: deadline,
                            publishAt: publishAt,
                            status: 'assigned', score: 0, createdAt: Date.now()
                        });
                    });
                    await Promise.all(promises);
                    notify("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "success");
                    app.closeNewTaskForm();
                    loadTeacherTasks();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },

            deleteTaskGroup: async (groupId) => {
                if(await app.askConfirm("–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö?")) {
                    const group = groupedTasks.find(g => g.groupId === groupId);
                    await Promise.all(group.items.map(item => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', item.id))));
                    loadTeacherTasks();
                }
            },

            showTaskDetails: (groupId) => {
                const group = groupedTasks.find(g => g.groupId === groupId);
                if (!group) return;
                const content = document.getElementById('modal-content');
                const publishDate = group.publishAt ? formatDate(group.publishAt.toDate()) : '–°—Ä–∞–∑—É';

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-xl">
                                <i data-lucide="layers" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-2xl font-black text-slate-800">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞–Ω–∏—è</h3>
                        </div>
                        
                        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 italic text-slate-700 leading-relaxed font-medium">"${group.question}"</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-indigo-50/50 p-5 rounded-3xl border border-indigo-100/50">
                                <div class="text-[10px] font-black uppercase text-indigo-400 mb-1 tracking-widest">–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
                                <div class="text-lg font-black text-indigo-700">${group.correctAnswer}</div>
                            </div>
                            <div class="bg-amber-50/50 p-5 rounded-3xl border border-amber-100/50">
                                <div class="text-[10px] font-black uppercase text-amber-500 mb-1 tracking-widest">–î–µ–¥–ª–∞–π–Ω</div>
                                <div class="text-lg font-black text-amber-700">${formatDate(group.deadline.toDate())}</div>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100 col-span-1 md:col-span-2">
                                <div class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest">–ü—É–±–ª–∏–∫–∞—Ü–∏—è</div>
                                <div class="text-base font-bold text-slate-600">${publishDate}</div>
                            </div>
                        </div>

                        <div class="space-y-3 pt-4">
                            <div class="text-[10px] font-black uppercase text-slate-400 mb-1 tracking-widest ml-2">–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</div>
                            ${group.items.map(item => `
                                <div class="flex flex-col p-4 bg-white border border-slate-100 rounded-2xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="font-bold text-slate-800">${item.studentName}</div>
                                        <div class="text-xs font-black ${item.status === 'completed' ? 'text-emerald-500' : 'text-slate-300'}">
                                            ${item.status === 'completed' ? `–°–¥–∞–Ω–æ (${item.score} –±.)` : '–û–∂–∏–¥–∞–µ—Ç'}
                                        </div>
                                    </div>
                                    ${item.status === 'completed' ? `<div class="text-sm bg-slate-50 p-3 rounded-xl text-slate-600"><span class="font-bold text-slate-400 text-xs uppercase mr-2">–û—Ç–≤–µ—Ç:</span> ${item.studentAnswer}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.getElementById('modal-task-details').classList.remove('hidden');
                document.body.classList.add('modal-open');
                lucide.createIcons();
            },

            closeTaskDetails: () => {
                document.getElementById('modal-task-details').classList.add('hidden');
                document.body.classList.remove('modal-open');
            },

            studentLogin: async () => {
                const phrase = document.getElementById('s-phrase').value.trim().toLowerCase();
                try {
                    const snap = await getDocs(getColPath('students'));
                    const student = snap.docs.find(d => d.data().phrase === phrase);
                    if (!student) return notify("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥", "error");
                    currentStudentId = student.id;
                    document.getElementById('student-name-display').textContent = student.data().name;
                    document.getElementById('student-phrase-display').textContent = student.data().phrase;
                    app.showScreen('screen-student-dash');
                    loadStudentTasks();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },

            submitTask: async (taskId, correct, deadlineSec) => {
                const val = document.getElementById(`input-${taskId}`).value.trim().toLowerCase();
                if (!val) return notify("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç", "error");
                const isCorrect = val === correct && (Date.now() / 1000) <= deadlineSec;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tasks', taskId), {
                        status: 'completed', studentAnswer: val, score: isCorrect ? 5 : 0, completedAt: Date.now()
                    });
                    notify(isCorrect ? "–í–µ—Ä–Ω–æ! +5 –±–∞–ª–ª–æ–≤" : "–ü—Ä–∏–Ω—è—Ç–æ", "success");
                    loadStudentTasks();
                } catch (e) { notify("–û—à–∏–±–∫–∞", "error"); }
            },

            logout: async () => { await signOut(auth); window.location.reload(); }
        };

        async function loadMyStudents() {
            if (!auth.currentUser) return;
            const [studentsSnap, tasksSnap] = await Promise.all([ getDocs(getColPath('students')), getDocs(getColPath('tasks')) ]);
            const tasks = tasksSnap.docs.map(d => d.data());
            const scores = {};
            tasks.forEach(t => { if(t.teacherId === auth.currentUser.uid) scores[t.studentId] = (scores[t.studentId] || 0) + (t.score || 0); });
            const list = document.getElementById('student-list');
            const checklist = document.getElementById('student-checklist');
            const myStudents = studentsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(s => s.teacherId === auth.currentUser.uid);
            
            let listHtml = '';
            let checklistHtml = '';
            myStudents.forEach(s => {
                const total = scores[s.id] || 0;
                listHtml += `
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 flex flex-col items-center text-center group relative">
                        <button onclick="app.deleteStudent('${s.id}')" class="absolute top-4 right-4 text-slate-200 hover:text-rose-500 transition-colors p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center text-xl font-black mb-4">${s.name[0]}</div>
                        <h4 class="font-black text-slate-800 truncate w-full px-4">${s.name}</h4>
                        <div class="bg-indigo-600 text-white px-4 py-1.5 rounded-full text-xs font-black shadow-lg shadow-indigo-100 mt-4">${total} –±.</div>
                    </div>`;
                checklistHtml += `
                    <label class="group flex items-center gap-4 p-5 bg-white rounded-2xl border-2 border-slate-50 cursor-pointer hover:border-indigo-400 transition-all">
                        <input type="checkbox" value="${s.id}" data-name="${s.name}" class="student-checkbox peer sr-only">
                        <div class="w-6 h-6 border-2 border-slate-200 rounded-lg peer-checked:bg-indigo-600 peer-checked:border-indigo-600 flex items-center justify-center transition-all">
                            <i data-lucide="check" class="w-4 h-4 text-white opacity-0 peer-checked:opacity-100"></i>
                        </div>
                        <span class="font-bold text-slate-700">${s.name}</span>
                    </label>`;
            });
            list.innerHTML = listHtml;
            checklist.innerHTML = checklistHtml;
            lucide.createIcons();
        }

        async function loadTeacherTasks() {
            if (!auth.currentUser) return;
            const snap = await getDocs(getColPath('tasks'));
            const container = document.getElementById('teacher-tasks-list');
            const allTasks = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.teacherId === auth.currentUser.uid);
            const groupsMap = {};
            allTasks.forEach(t => {
                const gid = t.groupId || t.id;
                if (!groupsMap[gid]) groupsMap[gid] = { ...t, items: [] };
                groupsMap[gid].items.push(t);
            });
            groupedTasks = Object.values(groupsMap).sort((a, b) => b.createdAt - a.createdAt);
            
            if (groupedTasks.length === 0) {
                container.innerHTML = '<div class="col-span-full py-20 text-center text-slate-300 font-bold italic">–ü—É—Å—Ç–æ</div>';
                return;
            }

            let html = '';
            groupedTasks.forEach(g => {
                const total = g.items.length;
                const done = g.items.filter(i => i.status === 'completed').length;
                const prc = Math.round((done / total) * 100);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –±—É–¥—É—â–µ–º –ª–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è
                const isScheduled = g.publishAt && g.publishAt.toMillis() > Date.now();
                const icon = isScheduled ? '<i data-lucide="clock" class="w-4 h-4 text-amber-500"></i>' : '';

                html += `
                    <div class="task-card bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm cursor-pointer relative" onclick="app.showTaskDetails('${g.groupId}')">
                        ${isScheduled ? '<div class="absolute top-6 right-14 bg-amber-50 text-amber-600 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider">–ü–ª–∞–Ω</div>' : ''}
                        <div class="flex justify-between items-start mb-4">
                            <div class="text-[10px] text-slate-400 font-black uppercase">–î–µ–¥–ª–∞–π–Ω: ${formatDate(g.deadline.toDate())}</div>
                            <button onclick="event.stopPropagation(); app.deleteTaskGroup('${g.groupId}')" class="text-slate-200 hover:text-rose-500"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <h4 class="font-black text-slate-800 text-lg mb-4 line-clamp-2">${g.question}</h4>
                        <div class="w-full h-1.5 bg-slate-50 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500" style="width: ${prc}%"></div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
            lucide.createIcons();
        }

        async function loadStatistics() {
            if (!auth.currentUser) return;
            const [studentsSnap, tasksSnap] = await Promise.all([ getDocs(getColPath('students')), getDocs(getColPath('tasks')) ]);
            const students = studentsSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(s => s.teacherId === auth.currentUser.uid);
            const tasks = tasksSnap.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.teacherId === auth.currentUser.uid);
            const completedTasks = tasks.filter(t => t.status === 'completed').sort((a, b) => a.completedAt - b.completedAt);

            const totalScore = completedTasks.reduce((acc, t) => acc + (t.score || 0), 0);
            const avgScore = completedTasks.length ? (totalScore / completedTasks.length).toFixed(1) : 0;
            const completionRate = tasks.length ? Math.round((completedTasks.length / tasks.length) * 100) : 0;

            document.getElementById('quick-stats').innerHTML = `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2 tracking-widest">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</span>
                    <div class="text-3xl font-black text-slate-800">${avgScore}</div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                    <span class="text-[10px] font-black uppercase text-slate-400 block mb-2 tracking-widest">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
                    <div class="text-3xl font-black text-indigo-600">${completionRate}%</div>
                </div>
            `;

            const dates = [...new Set(completedTasks.map(t => new Date(t.completedAt).toLocaleDateString()))];
            const datasets = students.map((s, idx) => {
                let cumulative = 0;
                return {
                    label: s.name,
                    data: dates.map(date => {
                        cumulative += completedTasks.filter(t => t.studentId === s.id && new Date(t.completedAt).toLocaleDateString() === date).reduce((acc, c) => acc + (c.score || 0), 0);
                        return cumulative;
                    }),
                    borderColor: ['#4f46e5', '#f59e0b', '#10b981', '#ef4444'][idx % 4],
                    tension: 0.4, fill: false, borderWidth: 3
                };
            });

            if (statsChart) statsChart.destroy();
            statsChart = new Chart(document.getElementById('statsChart'), {
                type: 'line',
                data: { labels: dates, datasets },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, grid: { color: '#f8fafc' } }, x: { grid: { display: false } } } 
                }
            });

            document.getElementById('stats-summary').innerHTML = students.map(s => {
                const total = tasks.filter(t => t.studentId === s.id).reduce((acc, c) => acc + (c.score || 0), 0);
                return `
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                        <div class="font-black text-slate-800 truncate mb-1">${s.name}</div>
                        <div class="text-indigo-600 font-black text-xl">${total} –±–∞–ª–ª–æ–≤</div>
                    </div>`;
            }).join('');
        }

        async function loadStudentTasks() {
            if (!currentStudentId) return;
            const snap = await getDocs(getColPath('tasks'));
            const container = document.getElementById('student-tasks-list');
            const now = Date.now();
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏—è: —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –ò –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É–∂–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ (–∏–ª–∏ –µ–≥–æ –Ω–µ—Ç)
            const tasks = snap.docs.map(d => ({id: d.id, ...d.data()}))
                .filter(t => t.studentId === currentStudentId)
                .filter(t => {
                    // –ï—Å–ª–∏ publishAt —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è. –ï—Å–ª–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É.
                    if (t.publishAt) {
                        return t.publishAt.toMillis() <= now;
                    }
                    return true;
                })
                .sort((a, b) => b.createdAt - a.createdAt);
                
            const total = tasks.reduce((acc, t) => acc + (t.score || 0), 0);
            document.getElementById('student-total-score').textContent = total + " –±.";
            document.getElementById('mob-student-score').textContent = total;

            if (tasks.length === 0) {
                container.innerHTML = '<div class="col-span-full py-20 text-center text-slate-300 font-bold italic">–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }

            let html = '';
            tasks.forEach(t => {
                const done = t.status === 'completed';
                if (done) {
                    html += `<div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm"><span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-black">+${t.score} –±.</span><h4 class="font-bold text-slate-500 mt-4">${t.question}</h4></div>`;
                } else {
                    html += `<div class="bg-white rounded-[2rem] p-6 md:p-8 border-2 border-amber-100 shadow-xl shadow-amber-50 relative"><h4 class="text-xl font-black text-slate-800 mb-8">${t.question}</h4><input type="text" id="input-${t.id}" class="w-full p-5 bg-slate-50 rounded-2xl outline-none font-bold text-lg mb-4" placeholder="–¢–≤–æ–π –æ—Ç–≤–µ—Ç..."><button onclick="app.submitTask('${t.id}', '${t.correctAnswer}', ${t.deadline.seconds})" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black">–°–¥–∞—Ç—å</button></div>`;
                }
            });
            container.innerHTML = html;
            lucide.createIcons();
        }

        onAuthStateChanged(auth, (user) => { if (user && user.email) { loadMyStudents(); loadTeacherTasks(); } });
        signInAnonymously(auth).catch(() => {});
        lucide.createIcons();
    </script>
</body>
</html>